FIXED

1. ls should render files as relative to the requested directory

E.g. ls /tmp should show file_in_tmp, not /tmp/file_in_tmp.

What bash does:

- ls -l one directory: files are relative to that directory

- ls -l multiple directories: Listing looks like this:

     dir1:
     <ls -l listing relative to dir1>

     dir2:
     <ls -l listing relative to dir2>

I don't like that highly formatted listing (for multiple
directories). So for one directory, make the listing relative. For
multiple directories, list absolute paths.

----------------------------------------------------------------------

FIXED

2. Line wrapping is broken, (when typing commands)

See GNU readline horizontal-scroll-mode.
https://tiswww.cwru.edu/php/chet/readline/rluserman.html#SEC10

I think this is fixed (see util.py). But if not, I was about to send
this to stackoverflow:

I am implementing a shell with some novel features, in Python 3. My code uses the input() function and readline module to read command lines, support command history, line editing, and so on. I'm passing a prompt, which includes ANSI escape codes (for color) to the input function, and things are mostly working.

But occasionally, something will go wrong:

- Only a prefix of the prompt is printed.

- If I recall a command and edit it, the editing goes to the wrong position within the line.

- Sometimes, typing a long line, wrapping will occur far too early, before the end of the terminal line is reached.

These problems are not highly reproducible. However, so far, it appears that omitting the ANSI escapes from the prompt fixes the problem.

I have googled this problem extensively, and the closest match I've been able to locate is this: https://stackoverflow.com/questions/17432993/adding-ansi-color-escape-sequences-to-a-bash-prompt-results-in-bad-cursor-positi. But this seems to be a different problem. (My problem seems involves input(), the readline module, and the underlying GNU readline library, not bash.)

I'm looking for advice on a direction to pursue.

----------------------------------------------------------------------

FIXED

3. Getting the group of some gids kills the shell

M jao@cheese:~$ ls -fr /opt
Traceback (most recent call last):
  File "/home/jao/git/osh2/src/osh/main.py", line 45, in <module>
    main()
  File "/home/jao/git/osh2/src/osh/main.py", line 41, in main
    process_input(run_command)
  File "/home/jao/git/osh2/src/osh/main.py", line 26, in process_input
    handle_line(line)
  File "/home/jao/git/osh2/src/osh/main.py", line 15, in run_command
    command.execute()
  File "/home/jao/git/osh2/src/osh/core.py", line 238, in execute
    self.pipeline.receive(None)
  File "/home/jao/git/osh2/src/osh/core.py", line 198, in receive
    self.first_op.receive(x)
  File "/home/jao/git/osh2/src/osh/op/ls.py", line 109, in receive
    self.visit(file, 0)
  File "/home/jao/git/osh2/src/osh/op/ls.py", line 135, in visit
    self.visit(file, level + 1)
  File "/home/jao/git/osh2/src/osh/op/ls.py", line 135, in visit
    self.visit(file, level + 1)
  File "/home/jao/git/osh2/src/osh/op/ls.py", line 135, in visit
    self.visit(file, level + 1)
  [Previous line repeated 1 more time]
  File "/home/jao/git/osh2/src/osh/op/ls.py", line 131, in visit
    self.send_path(path)
  File "/home/jao/git/osh2/src/osh/op/ls.py", line 144, in send_path
    self.send(file)
  File "/home/jao/git/osh2/src/osh/core.py", line 100, in send
    self.receiver.receive_input_or_error(x)
  File "/home/jao/git/osh2/src/osh/core.py", line 115, in receive_input_or_error
    self.receive(normalize_output(x))
  File "/home/jao/git/osh2/src/osh/op/out.py", line 90, in receive
    out = out.render_full(self.use_color())
  File "/home/jao/git/osh2/src/osh/object/file.py", line 91, in render_full
    line = self._formatted_metadata()
  File "/home/jao/git/osh2/src/osh/object/file.py", line 131, in _formatted_metadata
    '{:8s}'.format(groupname(self.gid)),
  File "/home/jao/git/osh2/src/osh/util.py", line 17, in groupname
    return grp.getgrgid(gid).gr_name
KeyError: 'getgrgid(): gid not found: 143'

----------------------------------------------------------------------

FIXED

4. Receive_complete called too many times following remote fork

@jao [ gen 3 ] | red . +

Should produce (localhost, 3). But it produces that output TWICE.

----------------------------------------------------------------------

FIXED

5. Unspecified behavior for red

red . + does something given inputs of size 3. What is supposed to
happen? Document and test for it.

----------------------------------------------------------------------

FIXED

6. File.render_full should include date/time

Linux does (day, month, time) for recent, (day, month, year) for
older. 

E.g.

lrwxrwxrwx 1 root   ro          31 Feb 26  2019  x-www-browser -> /etc/alternatives/x-www-browser
-rwxr-xr-x 1 root   root       18712 Sep  5 07:15  xxd

----------------------------------------------------------------------

FIXED

7. assert x is None in op.recieve() is a problem

Incorrect usage, such as "ls | bash emacs" causes the assertion to
fail and kills the shell. Should be a usage error instead.


----------------------------------------------------------------------

Oops, there are two bug 8s.

FIXED

8a. Fix rendering of links

- Color schema shows link using same color as directory in
  prompt. Confusing.

- Show link and target (different colors)


FIXED

8b. Highlighting confusion

If a directory (or file) matches the name of an executable, then the
highlighting is wrong. It is highlighted as an executable, not what it
really is.

----------------------------------------------------------------------

FIXED

9. Syntax error in map function not handled correctly

M jao@cheese:~/git/marcel/src/marcel$ ps | map (p: (p.pid, p.commandline.split()[0] if p.commandline else '')
Caught <class 'SyntaxError'>: invalid syntax (<string>, line 1)
  File "/home/jao/git/marcel/src/marcel/core.py", line 24, in arg_checker
    return check_and_convert(s)
  File "/home/jao/git/marcel/src/marcel/core.py", line 40, in check_function
    return marcel.function.Function(s)
  File "/home/jao/git/marcel/src/marcel/function.py", line 26, in __init__
    self.create_function()
  File "/home/jao/git/marcel/src/marcel/function.py", line 68, in create_function
    self.function = eval('lambda: ' + self.source, env.globals())
usage: map [-h] function
map: error: argument function: not a valid function

- There shouldn't be a stack, just an error message.


----------------------------------------------------------------------

FIXED

10. sort all by itself produces None as output

This seems wrong:

     M jao@cheese:~/git/marcel$ sort
     None

....................

Fixed for sort, but a more systematic fix is needed. Also affects
unique, window, probably others.

....................

Op:

- receive: For actually receiving something, input should not be None.

- run: For the first op in a pipeline, when there is no
  input. (E.g. runpipeline first op might receive input).

----------------------------------------------------------------------

FIXED

11. ls () works?!

M jao@cheese:~/git/marcel$ ls ()
drwxr-xr-x   jao      jao              4096   2020 Feb 25 15:33:00   .
drwxr-xr-x   jao      jao              4096   2020 Feb 26 23:43:50   .git
-rw-r--r--   jao      jao                20   2020 Jan 24 17:07:26   .gitignore
drwxr-xr-x   jao      jao              4096   2020 Feb 26 23:59:32   .idea
-rw-r--r--   jao      jao              6420   2020 Feb 25 15:59:14   README.md
drwxr-xr-x   jao      jao              4096   2020 Feb 25 11:22:15   bin
drwxr-xr-x   jao      jao              4096   2020 Feb 21 13:22:22   experiments
drwxr-xr-x   jao      jao              4096   2020 Feb 26 09:35:03   notes
drwxr-xr-x   jao      jao              4096   2020 Feb 19 10:31:26   src
drwxr-xr-x   jao      jao              4096   2020 Feb 25 09:38:13   test

----------------------------------------------------------------------

FIXED

12. Arguments to bash executable not being processed?

jao@cheese:~/git/marcel$ bash -i less README.md
Missing filename ("less --help" for help)
M jao@cheese:~/git/marcel$ bash -i ls *.md
bin  experiments  notes  README.md  src  test
M jao@cheese:~/git/marcel$ bash -i which which
Escaped command failed with exit code 1: which which
None

----------------------------------------------------------------------

FIXED

13. Tab completion for op isn't working after the first op in a pipeline

----------------------------------------------------------------------

FIXED

14. Tab expansion for files doesn't work if path starts with ~

----------------------------------------------------------------------

FIXED

15. File expansion not working for path beginning with ~/

E.g.

  M jao@cheese:~/git/marcel/src/marcel$ ls ~/ac

(There are two files whose names start with "ac")

----------------------------------------------------------------------

FIXED

16. Permission error on rm of directory crashes shell

M jao@cheese:/tmp$ rm rd
Traceback (most recent call last):
  File "/home/jao/git/marcel/src/marcel/main.py", line 88, in <module>
    Main().run()
  File "/home/jao/git/marcel/src/marcel/main.py", line 58, in run
    Main.run_command(line)
  File "/home/jao/git/marcel/src/marcel/main.py", line 70, in run_command
    Command(pipeline).execute()
  File "/home/jao/git/marcel/src/marcel/main.py", line 36, in execute
    self.pipeline.receive(None)
  File "/home/jao/git/marcel/src/marcel/core.py", line 209, in receive
    self.first_op.receive(x)
  File "/home/jao/git/marcel/src/marcel/op/rm.py", line 51, in receive
    Rm.remove(root)
  File "/home/jao/git/marcel/src/marcel/op/rm.py", line 67, in remove
    shutil.rmtree(root)
  File "/usr/lib/python3.7/shutil.py", line 498, in rmtree
    onerror(os.rmdir, path, sys.exc_info())
  File "/usr/lib/python3.7/shutil.py", line 496, in rmtree
    os.rmdir(path)
PermissionError: [Errno 1] Operation not permitted: '/tmp/rd'

----------------------------------------------------------------------

FIXED (accidentally)

17. Tab completion for filenames with spaces and escapes

E.g., tab completion for a\ b doesn't work.


----------------------------------------------------------------------

FIXED

18. Following restart, multilines history is wrong

A multiline command is recalled one line at a time.

----------------------------------------------------------------------

FIXED

19. Crash on first run of marcel if .marcel_history doesn't exist


----------------------------------------------------------------------

FIXED

20. edit op isn't working

Wasn't quite finished.


----------------------------------------------------------------------

FIXED

21. Prompt directory stuck at ~

The problem is that the value of PWD is copied into the .marcel.py
global namespace. Need to implement a Variable class, and put it in
that namespace. The Variable can then be updated by Environment.cd.

I.e., the Variable can be shared between Environment and the config
namespace, but values cannot.

----------------------------------------------------------------------

FIXED

22. Error output should be more informative

M jao@cheese:~$ gen 3 -1 | map (x: 1/x)
-1.0
Error(None)
1.0

Error(None): should identify input and op

----------------------------------------------------------------------

FIXED

23. Space after tab completion is off

Want a space when the choice is unambiguous. Don't want it otherwise,
e.g. complete xy with strings xya xyb.

----------------------------------------------------------------------

FIXED

24. cat problem causes marcel to crash

M jao@cheese:/tmp$ cat /tmp/nsm*
Traceback (most recent call last):
  File "/home/jao/git/marcel/src/marcel/main.py", line 122, in <module>
    MAIN.run()
  File "/home/jao/git/marcel/src/marcel/main.py", line 77, in run
    self.run_command(line)
  File "/home/jao/git/marcel/src/marcel/main.py", line 89, in run_command
    Command(pipeline).execute()
  File "/home/jao/git/marcel/src/marcel/main.py", line 40, in execute
    self.pipeline.receive_complete()
  File "/home/jao/git/marcel/src/marcel/core.py", line 240, in receive_complete
    self.first_op.receive_complete()
  File "/home/jao/git/marcel/src/marcel/op/bash.py", line 61, in receive_complete
    self.runner.run()
  File "/home/jao/git/marcel/src/marcel/op/bash.py", line 85, in run
    stdout, stderr = process.communicate(input=input)
  File "/usr/lib/python3.7/subprocess.py", line 964, in communicate
    stdout, stderr = self._communicate(input, endtime, timeout)
  File "/usr/lib/python3.7/subprocess.py", line 1755, in _communicate
    self.stdout.errors)
  File "/usr/lib/python3.7/subprocess.py", line 841, in _translate_newlines
    data = data.decode(encoding, errors)
UnicodeDecodeError: 'utf-8' codec can't decode byte 0xa0 in position 1247: invalid start byte


Also:

M jao@cheese:~$ find teaching
Process Process-3:
Traceback (most recent call last):
  File "/usr/lib/python3.7/multiprocessing/process.py", line 297, in _bootstrap
    self.run()
  File "/usr/lib/python3.7/multiprocessing/process.py", line 99, in run
    self._target(*self._args, **self._kwargs)
  File "/home/jao/git/marcel/src/marcel/job.py", line 130, in run_command
    env_vars = command.execute()
  File "/home/jao/git/marcel/src/marcel/main.py", line 43, in execute
    self.pipeline.receive_complete()
  File "/home/jao/git/marcel/src/marcel/core.py", line 300, in receive_complete
    self.first_op.receive_complete()
  File "/home/jao/git/marcel/src/marcel/op/bash.py", line 79, in receive_complete
    self.runner.run()
  File "/home/jao/git/marcel/src/marcel/op/bash.py", line 124, in run
    stdout, stderr = process.communicate(input=input)
  File "/usr/lib/python3.7/subprocess.py", line 964, in communicate
    stdout, stderr = self._communicate(input, endtime, timeout)
  File "/usr/lib/python3.7/subprocess.py", line 1755, in _communicate
    self.stdout.errors)
  File "/usr/lib/python3.7/subprocess.py", line 841, in _translate_newlines
    data = data.decode(encoding, errors)
UnicodeDecodeError: 'utf-8' codec can't decode byte 0x87 in position 1113486: invalid start byte


----------------------------------------------------------------------


FIXED

25. ls causes marcel to crash

M jao@cheese:~$ ls -r snap

...
drwxr-xr-x   jao      jao              4096   2019 Aug 11 18:30:02   spotify/36/.local/share/icons
drwxr-xr-x   jao      jao              4096   2019 Aug 11 18:30:12   spotify/36/.local/share/icons/Adwaita
lrwxrwxrwx   jao      jao                46   2019 Aug 11 18:30:02   spotify/36/.local/share/icons/Adwaita/16x16 -> /snap/spotify/36/usr/share/icons/Adwaita/16x16
drwxr-xr-x   root     root              965   2019 Jul 17 13:34:47   spotify/36/.local/share/icons/Adwaita/16x16/actions
Traceback (most recent call last):
  File "/home/jao/git/marcel/src/marcel/main.py", line 122, in <module>
    MAIN.run()
  File "/home/jao/git/marcel/src/marcel/main.py", line 77, in run
    self.run_command(line)
  File "/home/jao/git/marcel/src/marcel/main.py", line 89, in run_command
    Command(pipeline).execute()
  File "/home/jao/git/marcel/src/marcel/main.py", line 39, in execute
    self.pipeline.receive(None)
  File "/home/jao/git/marcel/src/marcel/core.py", line 233, in receive
    self.first_op.receive(x)
  File "/home/jao/git/marcel/src/marcel/op/ls.py", line 111, in receive
    self.visit(root, 0, base)
  File "/home/jao/git/marcel/src/marcel/op/ls.py", line 128, in visit
    self.visit(file, level + 1, base)
  File "/home/jao/git/marcel/src/marcel/op/ls.py", line 128, in visit
    self.visit(file, level + 1, base)
  File "/home/jao/git/marcel/src/marcel/op/ls.py", line 128, in visit
    self.visit(file, level + 1, base)
  [Previous line repeated 6 more times]
  File "/home/jao/git/marcel/src/marcel/op/ls.py", line 124, in visit
    self.send_path(root, base)
  File "/home/jao/git/marcel/src/marcel/op/ls.py", line 138, in send_path
    self.send(file)
  File "/home/jao/git/marcel/src/marcel/core.py", line 111, in send
    self.receiver.receive_input_or_error(x)
  File "/home/jao/git/marcel/src/marcel/core.py", line 126, in receive_input_or_error
    self.receive(normalize_output(x))
  File "/home/jao/git/marcel/src/marcel/op/out.py", line 78, in receive
    out = out.render_full(self.color_scheme())
  File "/home/jao/git/marcel/src/marcel/object/file.py", line 62, in render_full
    line[-1] = colorize(line[-1], self._highlight_color(self, color_scheme))
  File "/home/jao/git/marcel/src/marcel/util.py", line 88, in colorize
    1 if color.bold else 0,
AttributeError: 'str' object has no attribute 'bold'


----------------------------------------------------------------------

FIXED

26. Symlink target always displayed as absolute

It should be displayed however it is stored. 

marcel:

    M jao@cheese:/usr/bin$ ls xzcat
    lrwxrwxrwx   root     root                2   2019 Jan 27 20:09:34   /usr/bin/xzcat -> /usr/bin/xz

bash:

    jao@cheese:/usr/bin$ ls -l xzcat
    lrwxrwxrwx 1 root root 2 Jan 27  2019 xzcat -> xz

----------------------------------------------------------------------

FIXED

27. Shell crashes on some pathlib operations if current dir does not exist

cd from current dir:

Original exception was:
Traceback (most recent call last):
  File "/home/jao/git/marcel/src/marcel/main.py", line 122, in <module>
    MAIN.run()
  File "/home/jao/git/marcel/src/marcel/main.py", line 77, in run
    self.run_command(line)
  File "/home/jao/git/marcel/src/marcel/main.py", line 89, in run_command
    Command(pipeline).execute()
  File "/home/jao/git/marcel/src/marcel/main.py", line 39, in execute
    self.pipeline.receive(None)
  File "/home/jao/git/marcel/src/marcel/core.py", line 233, in receive
    self.first_op.receive(x)
  File "/home/jao/git/marcel/src/marcel/op/cd.py", line 45, in receive
    dir = self.directory.expanduser().resolve()
  File "/usr/lib/python3.7/pathlib.py", line 1151, in resolve
    s = self._flavour.resolve(self, strict=strict)
  File "/usr/lib/python3.7/pathlib.py", line 354, in resolve
    base = '' if path.is_absolute() else os.getcwd()
FileNotFoundError: [Errno 2] No such file or directory


Start marcel from dir that was deleted:

Original exception was:
Traceback (most recent call last):
  File "/home/jao/git/marcel/src/marcel/main.py", line 121, in <module>
    MAIN = Main()
  File "/home/jao/git/marcel/src/marcel/main.py", line 59, in __init__
    self.env = marcel.env.Environment(config_path)
  File "/home/jao/git/marcel/src/marcel/env.py", line 19, in __init__
    self._current_dir = pathlib.Path.cwd().resolve()
  File "/usr/lib/python3.7/pathlib.py", line 1064, in cwd
    return cls(os.getcwd())
FileNotFoundError: [Errno 2] No such file or directory


----------------------------------------------------------------------

FIXED

28. Hang on command with extra )

The last command hangs when an extra ) is added to the end.

M jao@cheese:/tmp/test$ ls
drwxr-xr-x   jao      jao              4096   2020 Mar 17 12:50:51   .
drwxr-xr-x   jao      jao              4096   2020 Mar 17 12:50:30   d
-rw-r--r--   jao      jao                 2   2020 Mar 17 12:50:30   f
-rw-r--r--   jao      jao                 5   2020 Mar 17 12:50:51   g
-rw-r--r--   jao      jao                 2   2020 Mar 17 12:50:30   lf
lrwxrwxrwx   jao      jao                11   2020 Mar 17 12:50:30   sd -> /tmp/test/d
lrwxrwxrwx   jao      jao                11   2020 Mar 17 12:50:30   sf -> /tmp/test/f
M jao@cheese:/tmp/test$ ls f g
-rw-r--r--   jao      jao                 2   2020 Mar 17 12:50:30   /tmp/test/f
-rw-r--r--   jao      jao                 5   2020 Mar 17 12:50:51   /tmp/test/g
M jao@cheese:/tmp/test$ ls f g | map (f: (f.name, f.size))
('f', 2)
('g', 5)
M jao@cheese:/tmp/test$ ls f g | map (f: (f.name, f.size)))
^C

----------------------------------------------------------------------

FIXED

29. Fork execution of ls is broken

Remote:

    M jao@cheese:~$ @jao [ ls /home/jao ]
    M jao@cheese:~$ 

No output at all.

Local:

    M jao@cheese:~$ @1 [ ls /home/jao ]
    Traceback (most recent call last):
      File "/home/jao/git/marcel/src/marcel/main.py", line 122, in <module>
        MAIN.run()
      File "/home/jao/git/marcel/src/marcel/main.py", line 77, in run
        self.run_command(line)
      File "/home/jao/git/marcel/src/marcel/main.py", line 89, in run_command
        Command(pipeline).execute()
      File "/home/jao/git/marcel/src/marcel/main.py", line 38, in execute
        self.pipeline.setup_2()
      File "/home/jao/git/marcel/src/marcel/core.py", line 228, in setup_2
        op.setup_2()
      File "/home/jao/git/marcel/src/marcel/op/fork.py", line 76, in setup_2
        pipeline_copy.setup_1()
      File "/home/jao/git/marcel/src/marcel/core.py", line 217, in setup_1
        op.setup_1()
      File "/home/jao/git/marcel/src/marcel/op/ls.py", line 93, in setup_1
        super().setup_1()
      File "/home/jao/git/marcel/src/marcel/op/filenames.py", line 35, in setup_1
        self.current_dir = self.env().pwd()
    AttributeError: 'GlobalState' object has no attribute 'env'

----------------------------------------------------------------------

FIXED

30. cd broken

M jao@cheese:~/git/marcel$ cd
Cannot cd into /home/jao/git/marcel/~. Directory does not exist.

----------------------------------------------------------------------

FIXED

31. ls /no/such/path appears to work

/no/such/path evaluates to an empty root, so the command is basically
"ls" and we get the files in the current directory.

----------------------------------------------------------------------

FIXED

32. ls crashes shell on PermissionError

M jao@cheese:~/git/marcel$ ls ~/.dbus/session-bus 
drwx------   root     root             4096   2019 Mar 28 23:45:10   .
Traceback (most recent call last):
  File "/home/jao/git/marcel/src/marcel/main.py", line 126, in <module>
    MAIN.run()
  File "/home/jao/git/marcel/src/marcel/main.py", line 81, in run
    self.run_command(line)
  File "/home/jao/git/marcel/src/marcel/main.py", line 93, in run_command
    Command(pipeline).execute()
  File "/home/jao/git/marcel/src/marcel/main.py", line 39, in execute
    self.pipeline.receive(None)
  File "/home/jao/git/marcel/src/marcel/core.py", line 233, in receive
    self.first_op.receive(x)
  File "/home/jao/git/marcel/src/marcel/op/filenames.py", line 28, in receive
    self.action(root)
  File "/home/jao/git/marcel/src/marcel/op/ls.py", line 120, in action
    self.visit(source, 0)
  File "/home/jao/git/marcel/src/marcel/op/ls.py", line 127, in visit
    for file in sorted(root.iterdir()):
  File "/usr/lib/python3.7/pathlib.py", line 1090, in iterdir
    for name in self._accessor.listdir(self):
PermissionError: [Errno 13] Permission denied: '/home/jao/.dbus/session-bus'


----------------------------------------------------------------------

FIXED

33. > in command line doesn't work

M jao@cheese:~/git/marcel$ git diff > /tmp/m.diff
Error(error: Could not access '>')



----------------------------------------------------------------------

FIXED

34. Tab completion vs. sudo -- shell crash

If we enter this much of a command:

    sudo -i [ ls /home/jao/.dbus/ses

tab-completion runs into permission problems trying to do its work.

----------------------------------------------------------------------

FIXED

35. Completed jobs accumulate in jobs output

JobControl.jobs shouldn't be exposed directly. Go through a method
that calls remove_completed.

----------------------------------------------------------------------

FIXED

36. Duplicated output when grep is invoked

This is odd:

    M jao@cheese:~/git/marcel/test$ echo hello
    hello
    M jao@cheese:~/git/marcel/test$ echo hello | grep hello
    hello
    hello


----------------------------------------------------------------------

FIXED

37. kill op only kills

It ignores the signal, and just kills the command. What is the correct
behavior? kill is implemented by SIGTERM, not SIGTERM, as usual. Maybe
SIGTERM would work? Haven't tried it. If SIGTERM works instead of
SIGKILL, then switch to it, and have the kill op work consistently
with bash.

----------------------------------------------------------------------

FIXED

38. Wildcard not working

M jao@cheese:~$ grep MiniMachete /var/log/syslog*
Error(grep: /var/log/syslog*: No such file or directory)

----------------------------------------------------------------------

FIXED

39. Incorrect wrapping of help text

From red.DETAILS:

'''
...
If this sequence is piped to this invocation of {red}:

    red . + . +

then groups are defined using the first and third values, {(1, 10), (1, 11), (2, 20), (3, 30)}.
The output would be:

    (1, 11, 10, 300)
...
'''

Formatted:

If this sequence is piped to this invocation of red:

    red . + . +

then groups are defined using the first and third values, (1, 10), (1, 11), (2, 20), (3, 30). The output would be:

    (1, 11, 10, 300)


Why isn't the "then groups ..." text wrapped?

----------------------------------------------------------------------

40. Unknown cluster name is assumed to be an int

M jao@cheese:~/git/marcel/test$ @local [ ps | select (p: 'python' in p.commandline) ]
Process Process-3:
Traceback (most recent call last):
  File "/usr/lib/python3.7/multiprocessing/process.py", line 297, in _bootstrap
    self.run()
  File "/usr/lib/python3.7/multiprocessing/process.py", line 99, in run
    self._target(*self._args, **self._kwargs)
  File "/home/jao/git/marcel/src/marcel/job.py", line 130, in run_command
    env_vars = command.execute()
  File "/home/jao/git/marcel/src/marcel/main.py", line 40, in execute
    self.pipeline.setup_1()
  File "/home/jao/git/marcel/src/marcel/core.py", line 276, in setup_1
    op.setup_1()
  File "/home/jao/git/marcel/src/marcel/op/fork.py", line 45, in setup_1
    self.impl = Remote(self) if cluster else Local(self)
  File "/home/jao/git/marcel/src/marcel/op/fork.py", line 176, in __init__
    op.fork_spec = int(op.fork_spec)
ValueError: invalid literal for int() with base 10: 'local'


----------------------------------------------------------------------

FIXED

41. Blank line should not be ignored on continuation line

Blank lines are ignored, which is fine. But if the blank line is a
continuation line, then the current command should be ended and executed.
Cleanup:

----------------------------------------------------------------------

NOT A BUG: echo doesn't accept piped input. And ... | xargs echo works.

42. Errors piped to executables are broken

Odd results:

M jao@cheese:/etc/sysctl.d$ gen 3 | map (x: 1/(1-x)) | echo
Error(map(x: 1/(1-x)) failed on (1,): division by zero)

----------------------------------------------------------------------

NOT A BUG: Yes, crashing the shell is fine. Bad markup is a bug in source, users shouldn't see it.

43. Bad markup shouldn't crash the shell

And probably don't throw Exception.

M jao@cheese:~$ help configuration
Traceback (most recent call last):
  File "/home/jao/git/marcel/src/marcel/main.py", line 159, in <module>
    MAIN.run()
  File "/home/jao/git/marcel/src/marcel/main.py", line 90, in run
    self.run_command(line)
  File "/home/jao/git/marcel/src/marcel/main.py", line 107, in run_command
    command.execute()
  File "/home/jao/git/marcel/src/marcel/main.py", line 41, in execute
    self.pipeline.receive(None)
  File "/home/jao/git/marcel/src/marcel/core.py", line 292, in receive
    self.first_op.receive(x)
  File "/home/jao/git/marcel/src/marcel/op/help.py", line 52, in receive
    help_text = Help.op_help(op_module) if op_module else self.topic_help()
  File "/home/jao/git/marcel/src/marcel/op/help.py", line 81, in topic_help
    return formatter.format(help_text)
  File "/home/jao/git/marcel/src/marcel/helpformatter.py", line 298, in format
    blocks = self.find_explicit_paragraph_boundaries(text)
  File "/home/jao/git/marcel/src/marcel/helpformatter.py", line 321, in find_explicit_paragraph_boundaries
    blocks.append(Paragraph(self, text[open:close]))
  File "/home/jao/git/marcel/src/marcel/helpformatter.py", line 208, in __init__
    self.paragraph_markup = ParagraphMarkup(markup)
  File "/home/jao/git/marcel/src/marcel/helpformatter.py", line 85, in __init__
    self.parse_paragraph_formatting()
  File "/home/jao/git/marcel/src/marcel/helpformatter.py", line 91, in parse_paragraph_formatting
    self.raise_invalid_formatting_exception()
  File "/home/jao/git/marcel/src/marcel/helpformatter.py", line 74, in raise_invalid_formatting_exception
    raise Exception(f'Invalid formatting specification: {self.text}')
Exception: Invalid formatting specification: {process_...}


----------------------------------------------------------------------

FIXED

44. \ in help text doesn't work.

\\ in help_command.py: Need space between \\ and } or crash. Also, not
even \\ is showing up.

----------------------------------------------------------------------

45. Tab completion on "ls -l" (I think)

M-0.6.3 jao@cheese:~/git/marcel$ ls -l test/test_opusage: ls [-h] [-0 | -1 | -r] [-f] [-d] [-s] ...
Caught <class 'marcel.exception.KillCommandException'>: ls: error: unrecognized arguments: -l

  File "/home/jao/git/marcel/marcel/tabcompleter.py", line 73, in complete
    parser.parse(partial_text=True)
  File "/home/jao/git/marcel/marcel/parse.py", line 443, in parse
    self.args_action(token)
  File "/home/jao/git/marcel/marcel/parse.py", line 417, in args_action
    self.finish_op()
  File "/home/jao/git/marcel/marcel/parse.py", line 513, in finish_op
    arg_parser.parse_args(current.args, namespace=op)
  File "/home/jao/git/marcel/marcel/core.py", line 61, in parse_args
    return super().parse_args(args, namespace)
  File "/usr/lib/python3.7/argparse.py", line 1767, in parse_args
    self.error(msg % ' '.join(argv))
  File "/usr/lib/python3.7/argparse.py", line 2516, in error
    self.exit(2, _('%(prog)s: error: %(message)s\n') % args)
  File "/home/jao/git/marcel/marcel/core.py", line 68, in exit
    raise marcel.exception.KillCommandException(message)
ls: error: unrecognized arguments: -l

usage: ls [-h] [-0 | -1 | -r] [-f] [-d] [-s] ...
Caught <class 'marcel.exception.KillCommandException'>: ls: error: unrecognized arguments: -l

  File "/home/jao/git/marcel/marcel/tabcompleter.py", line 73, in complete
    parser.parse(partial_text=True)
  File "/home/jao/git/marcel/marcel/parse.py", line 443, in parse
    self.args_action(token)
  File "/home/jao/git/marcel/marcel/parse.py", line 417, in args_action
    self.finish_op()
  File "/home/jao/git/marcel/marcel/parse.py", line 513, in finish_op
    arg_parser.parse_args(current.args, namespace=op)
  File "/home/jao/git/marcel/marcel/core.py", line 61, in parse_args
    return super().parse_args(args, namespace)
  File "/usr/lib/python3.7/argparse.py", line 1767, in parse_args
    self.error(msg % ' '.join(argv))
  File "/usr/lib/python3.7/argparse.py", line 2516, in error
    self.exit(2, _('%(prog)s: error: %(message)s\n') % args)
  File "/home/jao/git/marcel/marcel/core.py", line 68, in exit
    raise marcel.exception.KillCommandException(message)
ls: error: unrecognized arguments: -l


----------------------------------------------------------------------

NOT A BUG

The ssh session was in a process. The prompt was from the main loop of the console process.
bash -i ssh ... works as expected.

46. ssh identity confusion

    M-0.6.5 jao@cheese:~$ ssh -Y z@localhost
    z@localhost's password: 
    Welcome to Pop!_OS 19.10 (GNU/Linux 5.3.0-7648-generic x86_64)
    
     * Documentation:  https://help.ubuntu.com
     * Management:     https://landscape.canonical.com
     * Support:        https://ubuntu.com/advantage
    
     * Ubuntu 20.04 LTS is out, raising the bar on performance, security,
       and optimisation for Intel, AMD, Nvidia, ARM64 and Z15 as well as
       AWS, Azure and Google Cloud.
    
         https://ubuntu.com/blog/ubuntu-20-04-lts-arrives
    
    New release '20.04 LTS' available.
    Run 'do-release-upgrade' to upgrade to it.
    
    M-0.6.5 jao@cheese:~$ 

Why does remote session end up in marcel, logged in as jao?

----------------------------------------------------------------------

NOT A BUG (I think this was fixed under a higher bug number.)

48. Syntax error in .marcel.py should be handled more gracefully

jao@cheese:~/git/marcel/test$ marcel
Traceback (most recent call last):
  File "/usr/lib/python3.7/runpy.py", line 193, in _run_module_as_main
    "__main__", mod_spec)
  File "/usr/lib/python3.7/runpy.py", line 85, in _run_code
    exec(code, run_globals)
  File "/home/jao/git/marcel/marcel/main.py", line 211, in <module>
    MAIN = Main()
  File "/home/jao/git/marcel/marcel/main.py", line 90, in __init__
    self.env = marcel.env.Environment(self.config)
  File "/home/jao/git/marcel/marcel/env.py", line 136, in __init__
    self.read_config(config_file)
  File "/home/jao/git/marcel/marcel/env.py", line 201, in read_config
    exec(config_source, self.namespace, locals)
  File "<string>", line 64
    cat = [ map (f: (f, f.readlines())) | expand 1 ]
                  ^
SyntaxError: invalid syntax

----------------------------------------------------------------------

FIXED

49. Symbol defined in config file not visible to pipeline assigned to var

M-0.7.1 jao@cheese:~/git/marcel/test$ recent = [select(f: now() - f.mtime < hours(8))]
M-0.7.1 jao@cheese:~/git/marcel/test$ (recent)
pipeline(select(f: now() - f.mtime < hours(8)))
M-0.7.1 jao@cheese:~/git/marcel/test$ ls | recent
Error(Running select(f: now() - f.mtime < hours(8)) on (.,): name 'now' is not defined)
Error(Running select(f: now() - f.mtime < hours(8)) on (.marcel.py,): name 'now' is not defined)
Error(Running select(f: now() - f.mtime < hours(8)) on (.marcel_bug29.py,): name 'now' is not defined)
Error(Running select(f: now() - f.mtime < hours(8)) on (__init__.py,): name 'now' is not defined)
Error(Running select(f: now() - f.mtime < hours(8)) on (__pycache__,): name 'now' is not defined)
Error(Running select(f: now() - f.mtime < hours(8)) on (bug_28.py,): name 'now' is not defined)
Error(Running select(f: now() - f.mtime < hours(8)) on (bug_29.py,): name 'now' is not defined)
Error(Running select(f: now() - f.mtime < hours(8)) on (bug_30.py,): name 'now' is not defined)
Error(Running select(f: now() - f.mtime < hours(8)) on (bug_31.py,): name 'now' is not defined)
Error(Running select(f: now() - f.mtime < hours(8)) on (bug_33.py,): name 'now' is not defined)
Error(Running select(f: now() - f.mtime < hours(8)) on (bug_38.py,): name 'now' is not defined)
Error(Running select(f: now() - f.mtime < hours(8)) on (bug_39.py,): name 'now' is not defined)
Error(Running select(f: now() - f.mtime < hours(8)) on (test_api.py,): name 'now' is not defined)
Error(Running select(f: now() - f.mtime < hours(8)) on (test_api2.py,): name 'now' is not defined)
Error(Running select(f: now() - f.mtime < hours(8)) on (test_base.py,): name 'now' is not defined)
Error(Running select(f: now() - f.mtime < hours(8)) on (test_embedded_python.txt,): name 'now' is not defined)
Error(Running select(f: now() - f.mtime < hours(8)) on (test_filename_ops.py,): name 'now' is not defined)
Error(Running select(f: now() - f.mtime < hours(8)) on (test_help.py,): name 'now' is not defined)
Error(Running select(f: now() - f.mtime < hours(8)) on (test_native_filename_ops.py,): name 'now' is not defined)
Error(Running select(f: now() - f.mtime < hours(8)) on (test_ops.py,): name 'now' is not defined)
Error(Running select(f: now() - f.mtime < hours(8)) on (test_parser.py,): name 'now' is not defined)
Error(Running select(f: now() - f.mtime < hours(8)) on (test_python_string.txt,): name 'now' is not defined)
Error(Running select(f: now() - f.mtime < hours(8)) on (test_shell_string.txt,): name 'now' is not defined)
Error(Running select(f: now() - f.mtime < hours(8)) on (test_tokenizing.py,): name 'now' is not defined)
Error(Running select(f: now() - f.mtime < hours(8)) on (testall,): name 'now' is not defined)

----------------------------------------------------------------------

FIXED

50. Assigning function with unbound args blows up

    M-0.7.1 jao@cheese:~$ x = (a: a + 1)
    Error(Running assign(x, None) on : <lambda>() missing 1 required positional argument: 'a')
    Traceback (most recent call last):
      File "/home/jao/git/marcel/marcel/functionwrapper.py", line 59, in __call__
        return self._function(*args, **kwargs)
    TypeError: <lambda>() missing 1 required positional argument: 'a'
    
    During handling of the above exception, another exception occurred:
    
    Traceback (most recent call last):
      File "/usr/lib/python3.7/runpy.py", line 193, in _run_module_as_main
        "__main__", mod_spec)
      File "/usr/lib/python3.7/runpy.py", line 85, in _run_code
        exec(code, run_globals)
      File "/home/jao/git/marcel/marcel/main.py", line 212, in <module>
        MAIN.run()
      File "/home/jao/git/marcel/marcel/main.py", line 116, in run
        self.run_command(line)
      File "/home/jao/git/marcel/marcel/main.py", line 140, in run_command
        command.execute()
      File "/home/jao/git/marcel/marcel/core.py", line 413, in execute
        self.pipeline.setup_1()
      File "/home/jao/git/marcel/marcel/core.py", line 348, in setup_1
        op.setup_1()
      File "/home/jao/git/marcel/marcel/op/assign.py", line 48, in setup_1
        self.value = function()
      File "/home/jao/git/marcel/marcel/functionwrapper.py", line 67, in __call__
        self._op.fatal_error(function_input_string, str(e))
      File "/home/jao/git/marcel/marcel/core.py", line 255, in fatal_error
        raise marcel.exception.KillAndResumeException(error)
    marcel.exception.KillAndResumeException: Error(Running assign(x, None) on : <lambda>() missing 1 required positional argument: 'a')

Allow this? If not, then at least fail gracefully.

----------------------------------------------------------------------

FIXED

51. Crash on editing and entering line with no line continuation after \ (?)

M-0.7.3 jao@cheese:~/git/marcel$ ls -fr \
| select (f: f.suffix == '.py') \
| map (f: f.read().count('\n')) |
Traceback (most recent call last):
  File "/usr/lib/python3.7/runpy.py", line 193, in _run_module_as_main
    "__main__", mod_spec)
  File "/usr/lib/python3.7/runpy.py", line 85, in _run_code
    exec(code, run_globals)
  File "/home/jao/git/marcel/marcel/main.py", line 210, in <module>
    MAIN.run()
  File "/home/jao/git/marcel/marcel/main.py", line 116, in run
    self.run_command(line)
  File "/home/jao/git/marcel/marcel/main.py", line 128, in run_command
    pipeline = parser.parse()
  File "/home/jao/git/marcel/marcel/parser.py", line 560, in parse
    return self.command()
  File "/home/jao/git/marcel/marcel/parser.py", line 566, in command
    return self.pipeline()
  File "/home/jao/git/marcel/marcel/parser.py", line 586, in pipeline
    op_sequence = Parser.ensure_sequence(self.op_sequence())
  File "/home/jao/git/marcel/marcel/parser.py", line 599, in op_sequence
    op_sequence = Parser.ensure_sequence(self.op_sequence())
  File "/home/jao/git/marcel/marcel/parser.py", line 599, in op_sequence
    op_sequence = Parser.ensure_sequence(self.op_sequence())
  File "/home/jao/git/marcel/marcel/parser.py", line 599, in op_sequence
    op_sequence = Parser.ensure_sequence(self.op_sequence())
  File "/home/jao/git/marcel/marcel/parser.py", line 597, in op_sequence
    op_args = self.op_args()
  File "/home/jao/git/marcel/marcel/parser.py", line 609, in op_args
    op_token = self.op()
  File "/home/jao/git/marcel/marcel/parser.py", line 625, in op
    raise PrematureEndError()
marcel.parser.PrematureEndError: Command ended prematurely.

----------------------------------------------------------------------

FIXED

52. Pickling/unpickling Environment

What is the right thing to do? Parts of it make no sense for farcel:
color scheme, PWD, probably others. HOMEDIR may or may not be right.
Also, sometimes we copy for remote execution, sometimes for local
execution. 

Need to rethink Environment transmission.

----------------------------------------------------------------------

FIXED

53. Stack trace on unexpected arg type to ls

M-0.7.6 jao@cheese:~/git/marcel$ ls (File('bin'))
Process Process-11:
Traceback (most recent call last):
  File "/usr/lib/python3.7/multiprocessing/process.py", line 297, in _bootstrap
    self.run()
  File "/usr/lib/python3.7/multiprocessing/process.py", line 99, in run
    self._target(*self._args, **self._kwargs)
  File "/home/jao/git/marcel/marcel/job.py", line 146, in run_command
    dir_vars = command.execute()
  File "/home/jao/git/marcel/marcel/core.py", line 346, in execute
    self.pipeline.setup_1()
  File "/home/jao/git/marcel/marcel/core.py", line 297, in setup_1
    op.setup_1()
  File "/home/jao/git/marcel/marcel/op/ls.py", line 111, in setup_1
    super().setup_1()
  File "/home/jao/git/marcel/marcel/op/filenames.py", line 39, in setup_1
    self.roots = FilenamesOp.deglob(self.current_dir, self.filenames)
  File "/home/jao/git/marcel/marcel/op/filenames.py", line 82, in deglob
    paths = FilenamesOp.normalize_paths(filenames)
  File "/home/jao/git/marcel/marcel/op/filenames.py", line 70, in normalize_paths
    filename = os.path.normpath(filename)
  File "/usr/lib/python3.7/posixpath.py", line 340, in normpath
    path = os.fspath(path)
TypeError: expected str, bytes or os.PathLike object, not File
M-0.7.6 jao@cheese:~/git/marcel$ 

----------------------------------------------------------------------

FIXED

54. "ps -u" is broken

Without a userid. Seems to work with one.

----------------------------------------------------------------------

55. Tab completion showing non-public commands

E.g. tab completion of "g" ->gather gen

gather should not be visible.

----------------------------------------------------------------------

FIXED

56. stderr not captured

M-0.7.8 jao@cheese:~$ print 'a'
M-0.7.8 jao@cheese:~$ 
jao@cheese:~$ print 'a'
"my" variable $file masks earlier declaration in same scope at /usr/bin/print line 339.
Use of uninitialized value $code in concatenation (.) or string at /usr/bin/print line 356, <READER> line 1.
Error: no such file "a"
jao@cheese:~$ 

print 'a' is a shell command which writes to stderr. Marcel doesn't
report it.

----------------------------------------------------------------------

NOT A BUG

57. This seems wrong

    M-0.7.9 jao@cheese:~/git/marcel/test$ printa
    Unknown command: printa
    M-0.7.9 jao@cheese:~/git/marcel/test$ print('a')
    printa

In bash, ls, "ls", 'l's all do the same thing.


abc('def'):

- Lexer turns this into Expression(f'''abc{'def'}''')

- Parser then makes it map(Expression(...))

abcdef:

- Parser tries to do create_op and fails.

When should Expressions be evaluated? To fix this bug, it would have
to be at parse time. But that doesn't work in general, e.g. for the
functions used by map and select.

Decide based on context. In case of an op (this bug) do it at parse
time. But we DO want an expression such as (5+6) to be evaluated at
runtime, not interpreted as an op.

I'm going to say this is not a bug.

----------------------------------------------------------------------

FIXED

59. cat can't find file that exists

Is bash not expanding ~?

M-0.7.12 jao@cheese:~/git/marcel/test$ cat ~/system76.txt
Error(cat: '~/system76.txt': No such file or directory)

----------------------------------------------------------------------

FIXED

60. Preserve quotes when passing args to bash

Quote-sensitive tests in test_ops fail otherwise.

RE-ENABLE test_bash() in test_ops once this is fixed.

----------------------------------------------------------------------

FIXED

61. runpipeline op doesn't work when first in pipeline.

Create a pipeline and use it:

    M-0.8.0 jao@cheese:~/git/marcel/test$ a = [gen 3]
    M-0.8.0 jao@cheese:~/git/marcel/test$ a
    0
    1
    2
    M-0.8.0 jao@cheese:~/git/marcel/test$ (a)
    pipeline(gen(count=3, start=0, pad=None))

Embed the pipeline in another one:

    M-0.8.0 jao@cheese:~/git/marcel/test$ b = [a]
    M-0.8.0 jao@cheese:~/git/marcel/test$ (b)
    pipeline(runpipeline(a))
    M-0.8.0 jao@cheese:~/git/marcel/test$ b
    M-0.8.0 jao@cheese:~/git/marcel/test$ 

Executing b produces no output. It should have run a.

----------------------------------------------------------------------

62. Don't crash if .marcel.py is not present

Crash isn't on startup, but on the first command. The crash is on
checking the file's mtime. 

Create an empty .marcel.py.


----------------------------------------------------------------------

FIXED

63. Wrapping of {L} tags is broken.

E.g., from red.HELP:

{L,indent=4:28}-i, --incremental       Output a tuple for each step of the reduction. I.e., there will be one
output tuple for each input tuple, with the reductions showing the result of the reduction up to and including
the most recent input.

----------------------------------------------------------------------

NOT A BUG

64: Unexpected expand behavior

M-0.9.15 jao@cheese:~/git/marcel/test$ (sys.path) | expand 1
('/home/jao/git/marcel/test', '/', '/usr/lib/python38.zip', '/usr/lib/python3.8', '/usr/lib/python3.8/lib-dynload', '/home/jao/.local/lib/python3.8/site-packages', '/usr/local/lib/python3.8/dist-packages', '/usr/lib/python3/dist-packages')
('/home/jao/git/marcel/test', 'h', '/usr/lib/python38.zip', '/usr/lib/python3.8', '/usr/lib/python3.8/lib-dynload', '/home/jao/.local/lib/python3.8/site-packages', '/usr/local/lib/python3.8/dist-packages', '/usr/lib/python3/dist-packages')
('/home/jao/git/marcel/test', 'o', '/usr/lib/python38.zip', '/usr/lib/python3.8', '/usr/lib/python3.8/lib-dynload', '/home/jao/.local/lib/python3.8/site-packages', '/usr/local/lib/python3.8/dist-packages', '/usr/lib/python3/dist-packages')
('/home/jao/git/marcel/test', 'm', '/usr/lib/python38.zip', '/usr/lib/python3.8', '/usr/lib/python3.8/lib-dynload', '/home/jao/.local/lib/python3.8/site-packages', '/usr/local/lib/python3.8/dist-packages', '/usr/lib/python3/dist-packages')
('/home/jao/git/marcel/test', 'e', '/usr/lib/python38.zip', '/usr/lib/python3.8', '/usr/lib/python3.8/lib-dynload', '/home/jao/.local/lib/python3.8/site-packages', '/usr/local/lib/python3.8/dist-packages', '/usr/lib/python3/dist-packages')
('/home/jao/git/marcel/test', '/', '/usr/lib/python38.zip', '/usr/lib/python3.8', '/usr/lib/python3.8/lib-dynload', '/home/jao/.local/lib/python3.8/site-packages', '/usr/local/lib/python3.8/dist-packages', '/usr/lib/python3/dist-packages')
('/home/jao/git/marcel/test', 'j', '/usr/lib/python38.zip', '/usr/lib/python3.8', '/usr/lib/python3.8/lib-dynload', '/home/jao/.local/lib/python3.8/site-packages', '/usr/local/lib/python3.8/dist-packages', '/usr/lib/python3/dist-packages')
('/home/jao/git/marcel/test', 'a', '/usr/lib/python38.zip', '/usr/lib/python3.8', '/usr/lib/python3.8/lib-dynload', '/home/jao/.local/lib/python3.8/site-packages', '/usr/local/lib/python3.8/dist-packages', '/usr/lib/python3/dist-packages')
('/home/jao/git/marcel/test', 'o', '/usr/lib/python38.zip', '/usr/lib/python3.8', '/usr/lib/python3.8/lib-dynload', '/home/jao/.local/lib/python3.8/site-packages', '/usr/local/lib/python3.8/dist-packages', '/usr/lib/python3/dist-packages')
('/home/jao/git/marcel/test', '/', '/usr/lib/python38.zip', '/usr/lib/python3.8', '/usr/lib/python3.8/lib-dynload', '/home/jao/.local/lib/python3.8/site-packages', '/usr/local/lib/python3.8/dist-packages', '/usr/lib/python3/dist-packages')
('/home/jao/git/marcel/test', 'g', '/usr/lib/python38.zip', '/usr/lib/python3.8', '/usr/lib/python3.8/lib-dynload', '/home/jao/.local/lib/python3.8/site-packages', '/usr/local/lib/python3.8/dist-packages', '/usr/lib/python3/dist-packages')
('/home/jao/git/marcel/test', 'i', '/usr/lib/python38.zip', '/usr/lib/python3.8', '/usr/lib/python3.8/lib-dynload', '/home/jao/.local/lib/python3.8/site-packages', '/usr/local/lib/python3.8/dist-packages', '/usr/lib/python3/dist-packages')
('/home/jao/git/marcel/test', 't', '/usr/lib/python38.zip', '/usr/lib/python3.8', '/usr/lib/python3.8/lib-dynload', '/home/jao/.local/lib/python3.8/site-packages', '/usr/local/lib/python3.8/dist-packages', '/usr/lib/python3/dist-packages')
('/home/jao/git/marcel/test', '/', '/usr/lib/python38.zip', '/usr/lib/python3.8', '/usr/lib/python3.8/lib-dynload', '/home/jao/.local/lib/python3.8/site-packages', '/usr/local/lib/python3.8/dist-packages', '/usr/lib/python3/dist-packages')
('/home/jao/git/marcel/test', 'm', '/usr/lib/python38.zip', '/usr/lib/python3.8', '/usr/lib/python3.8/lib-dynload', '/home/jao/.local/lib/python3.8/site-packages', '/usr/local/lib/python3.8/dist-packages', '/usr/lib/python3/dist-packages')
('/home/jao/git/marcel/test', 'a', '/usr/lib/python38.zip', '/usr/lib/python3.8', '/usr/lib/python3.8/lib-dynload', '/home/jao/.local/lib/python3.8/site-packages', '/usr/local/lib/python3.8/dist-packages', '/usr/lib/python3/dist-packages')
('/home/jao/git/marcel/test', 'r', '/usr/lib/python38.zip', '/usr/lib/python3.8', '/usr/lib/python3.8/lib-dynload', '/home/jao/.local/lib/python3.8/site-packages', '/usr/local/lib/python3.8/dist-packages', '/usr/lib/python3/dist-packages')
('/home/jao/git/marcel/test', 'c', '/usr/lib/python38.zip', '/usr/lib/python3.8', '/usr/lib/python3.8/lib-dynload', '/home/jao/.local/lib/python3.8/site-packages', '/usr/local/lib/python3.8/dist-packages', '/usr/lib/python3/dist-packages')
('/home/jao/git/marcel/test', 'e', '/usr/lib/python38.zip', '/usr/lib/python3.8', '/usr/lib/python3.8/lib-dynload', '/home/jao/.local/lib/python3.8/site-packages', '/usr/local/lib/python3.8/dist-packages', '/usr/lib/python3/dist-packages')
('/home/jao/git/marcel/test', 'l', '/usr/lib/python38.zip', '/usr/lib/python3.8', '/usr/lib/python3.8/lib-dynload', '/home/jao/.local/lib/python3.8/site-packages', '/usr/local/lib/python3.8/dist-packages', '/usr/lib/python3/dist-packages')


----------------------------------------------------------------------

FIXED

65. Returning updated namespace from Job still broken

M-0.9.15 jao@cheese:~/git/marcel/test$ x = [(4)]
M-0.9.15 jao@cheese:~/git/marcel/test$ x
4
Process Process-1:
Traceback (most recent call last):
  File "/usr/lib/python3.8/multiprocessing/process.py", line 315, in _bootstrap
    self.run()
  File "/usr/lib/python3.8/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/home/jao/git/marcel/marcel/job.py", line 147, in run_command_in_child
    writer.send(child_namespace_changes)
  File "/usr/lib/python3.8/multiprocessing/connection.py", line 206, in send
    self._send_bytes(_ForkingPickler.dumps(obj))
  File "/usr/lib/python3.8/multiprocessing/reduction.py", line 51, in dumps
    cls(buf, protocol).dump(obj)
_pickle.PicklingError: Can't pickle <function <lambda> at 0x7f75c4a4b550>: attribute lookup <lambda> on __main__ failed

----------------------------------------------------------------------

NOT A BUG

67. Pipeline syntax needs to be generalized

    M-0.9.15 jao@cheese:~/git/marcel$ gen 3 | map (x: x + 5)
    5
    6
    7
    M-0.9.15 jao@cheese:~/git/marcel$ gen 3 | [x: map (x + 5)]
    Parsing error at position 8 of "...gen 3 | [x: map (x + 5)]...": Unexpected token type: Begin([)

This syntax:

    ... | [ ... ]

is rejected by the parser, which means we can't have pipelines with
parameters as literals. Fix the parser.

......................................................................

This no longer produces a parsing error, but the semantics are
wrong. gen 3 | args |( x: ... |) is correct and works.

----------------------------------------------------------------------

FIXED

68. Help formatting broken -- indent vs. wrap

This indents by 4:

    {L,indent=4}loop ((0, 1)) [select (x, y: y < 1000000) | map (x, y: (y, x + y))] | map (x, y: x)

This does not:

    {L,indent=4,wrap=F}loop ((0, 1)) [select (x, y: y < 1000000) | map (x, y: (y, x + y))] | map (x, y: x)

This does indent:

    {L,indent=4,wrap=T}loop ((0, 1)) [select (x, y: y < 1000000) | map (x, y: (y, x + y))] | map (x, y: x)

So wrap=F causes indent to be ignored.

----------------------------------------------------------------------

FIXED

70. Pipeline containing loop crashes when executed

M-0.9.17 jao@cheese:~/git/marcel/test$ p = [loop (0) [select (x: x < 5) | emit | map (x: x+1)]]
M-0.9.17 jao@cheese:~/git/marcel/test$ p
Process Process-2:
Traceback (most recent call last):
  File "/usr/lib/python3.8/multiprocessing/process.py", line 315, in _bootstrap
    self.run()
  File "/usr/lib/python3.8/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/home/jao/git/marcel/marcel/job.py", line 145, in run_command_in_child
    child_namespace_changes = command.execute()
  File "/home/jao/git/marcel/marcel/core.py", line 392, in execute
    self.pipeline.setup_1()
  File "/home/jao/git/marcel/marcel/core.py", line 314, in setup_1
    op.setup_1()
  File "/home/jao/git/marcel/marcel/op/runpipeline.py", line 49, in setup_1
    self.pipeline.setup_1()
  File "/home/jao/git/marcel/marcel/core.py", line 314, in setup_1
    op.setup_1()
  File "/home/jao/git/marcel/marcel/op/loop.py", line 104, in setup_1
    loop_pipeline.prepend(marcel.opmodule.create_op(self.env(), 'load', self.loopvar))
  File "/home/jao/git/marcel/marcel/opmodule.py", line 83, in create_op
    op_module = env.op_modules[op_name]
AttributeError: 'Environment' object has no attribute 'op_modules'


----------------------------------------------------------------------

FIXED

71. store not setting variable

M-0.9.17 jao@cheese:~/git/marcel/test$ gen 10 | ifthen (x: x%2==0) [store d2]
0
1
2
3
4
5
6
7
8
9
M-0.9.17 jao@cheese:~/git/marcel/test$ (d2)
Error: Running map(lambda: d2): name 'd2' is not defined

----------------------------------------------------------------------

FIXED

72. Join of stored pipelines fails

cd ~/git/marcel
ls -fr marcel test \
| ifthen (f: now() - f.mtime < days(1)) [store recent] \
| ifelse (f: f.suffix == '.py') [store py] \
| ifelse (f: f.suffix == '.txt') [store txt]
load recent | join [load py]

Process Process-2:
Traceback (most recent call last):
  File "/usr/lib/python3.8/multiprocessing/process.py", line 315, in _bootstrap
    self.run()
  File "/usr/lib/python3.8/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/home/jao/git/marcel/marcel/job.py", line 145, in run_command_in_child
    child_namespace_changes = command.execute()
  File "/home/jao/git/marcel/marcel/core.py", line 440, in execute
    self.pipeline.receive(None)
  File "/home/jao/git/marcel/marcel/core.py", line 373, in receive
    self.first_op.receive_input(x)
  File "/home/jao/git/marcel/marcel/core.py", line 175, in receive_input
    self.receive(None if x is None else
  File "/home/jao/git/marcel/marcel/op/load.py", line 86, in receive
    self.send(next(self.input))
  File "/home/jao/git/marcel/marcel/core.py", line 158, in send
    receiver.receive_input(x)
  File "/home/jao/git/marcel/marcel/core.py", line 175, in receive_input
    self.receive(None if x is None else
  File "/home/jao/git/marcel/marcel/op/join.py", line 130, in receive
    self.send(x + match[1:])
  File "/home/jao/git/marcel/marcel/core.py", line 158, in send
    receiver.receive_input(x)
  File "/home/jao/git/marcel/marcel/core.py", line 175, in receive_input
    self.receive(None if x is None else
  File "/home/jao/git/marcel/marcel/op/out.py", line 115, in receive
    out = out.render_full(self.color_scheme())
  File "/home/jao/git/marcel/marcel/object/file.py", line 96, in render_full
    line = self._formatted_metadata()
  File "/home/jao/git/marcel/marcel/object/file.py", line 151, in _formatted_metadata
    self.display_path.as_posix()]
AttributeError: 'NoneType' object has no attribute 'as_posix'


----------------------------------------------------------------------

FIXED

73.Parsing error involving pipe and/or pipeline args with load syntax

Pipe before the last join is rejected

    M-0.9.20 jao@cheese:~/git/marcel$ a > join [b>] | join [c>]
    Parsing error at position 10 of "...join [b>] | join [c>]...": Unexpected token type: Pipe(|)
    
Two successive joins not piped is OK?!

    M-0.9.20 jao@cheese:~/git/marcel$ a > join [b>] join [c>]
    (0, 0, 0, 0)
    (1, 10, 100, 1000)
    (2, 20, 200, 2000)
    (3, 30, 300, 3000)
    (4, 40, 400, 4000)

----------------------------------------------------------------------

FIXED 

74. Redirect after join fails

Setup:

    gen 5 | map (x: (x, x*10)) > a
    gen 5 | map (x: (x, x*100)) > b
    gen 5 | map (x: (x, x*1000)) > c
    

This prints the result of the join, doesn't assign to d:

    a > join[b>] | join [c>] > d

This works:

    a > join[b>] | join [c>] | store d

----------------------------------------------------------------------

FIXED

75. read is buggy, stops before end

E.g., ls ~/git/marcel/notes/grammar.txt | read

----------------------------------------------------------------------

FIXED

76. ~/ doesn't work in out command.

----------------------------------------------------------------------

FIXED

77. ctrl-C doesn't work!

Not killing gen 0.

----------------------------------------------------------------------

FIXED

78. vim doesn't work

----------------------------------------------------------------------

NOT A BUG

79. less doesn't work

----------------------------------------------------------------------

FIXED

80. ls -fr > /tmp/x 

What does this do?! Doesn't result in an error message.

----------------------------------------------------------------------

FIXED

81. ls > x

Variable ls is undefined.

This is parsed as load + store, instead of op + store.

----------------------------------------------------------------------

FIXED

82. Var assignment isn't working

    M-0.10.6 jao@cheese:~/git/marcel/test$ x = (1)
    M-0.10.6 jao@cheese:~/git/marcel/test$ (x)
    Error: Running map(lambda: x): name 'x' is not defined

----------------------------------------------------------------------

FIXED

83. ! is broken

----------------------------------------------------------------------

FIXED

84. Type of list is changed to tuple

    x = ([1, 2, 3])
    (x)

prints (1, 2, 3). I.e., list turns into tuple.

----------------------------------------------------------------------

FIXED

86. Need to describe the color scheme 

ColorScheme.__repr__? A command? There needs to be some way to let the
use see the color scheme.

----------------------------------------------------------------------

NOT A BUG

87. Assign pipeline without brackets

Should it be allowed? If not, this failure mode is pretty bad:

    M-0.10.8 jao@cheese:~/git/marcel/marcel/object$ g = gen 5
    M-0.10.8 jao@cheese:~/git/marcel/marcel/object$ (g)
    gen

The string "gen" is assigned and the rest is ignored.

......................................................................

Reasonable syntax error:

M 0.16.4 jao@cheese ~/git/marcel/test$ g = gen 5
(| assign(g, None) |) followed by excess tokens


----------------------------------------------------------------------

FIXED

88. Crash on ifelse operating on processes

    M-0.10.8 jao@cheese:~/git/marcel/test$ ps | ifelse (p: username(p.uid) == 'root') [> root] > others
    Process Process-8:
    Traceback (most recent call last):
      File "/usr/lib/python3.8/multiprocessing/process.py", line 315, in _bootstrap
        self.run()
      File "/usr/lib/python3.8/multiprocessing/process.py", line 108, in run
        self._target(*self._args, **self._kwargs)
      File "/home/jao/git/marcel/marcel/job.py", line 147, in run_command_in_child
        writer.send(child_namespace_changes)
      File "/usr/lib/python3.8/multiprocessing/connection.py", line 206, in send
        self._send_bytes(_ForkingPickler.dumps(obj))
      File "/usr/lib/python3.8/multiprocessing/reduction.py", line 51, in dumps
        cls(buf, protocol).dump(obj)
    TypeError: 'NoneType' object is not callable


The problem is Processes in variables:

    M-0.10.8 jao@cheese:~/git/marcel/test$ ps > p
    Process Process-3:
    Traceback (most recent call last):
      File "/usr/lib/python3.8/multiprocessing/process.py", line 315, in _bootstrap
        self.run()
      File "/usr/lib/python3.8/multiprocessing/process.py", line 108, in run
        self._target(*self._args, **self._kwargs)
      File "/home/jao/git/marcel/marcel/job.py", line 147, in run_command_in_child
        writer.send(child_namespace_changes)
      File "/usr/lib/python3.8/multiprocessing/connection.py", line 206, in send
        self._send_bytes(_ForkingPickler.dumps(obj))
      File "/usr/lib/python3.8/multiprocessing/reduction.py", line 51, in dumps
        cls(buf, protocol).dump(obj)
    TypeError: 'NoneType' object is not callable

----------------------------------------------------------------------

FIXED

90. config file change effect delayed

The change should take effect on the next command.

----------------------------------------------------------------------

FIXED

91. Failure to append fails silently

    x = [gen 10]
    ls > x

ls fails to replace x, and x still has the value from its first assignment.

----------------------------------------------------------------------

NOT A BUG

92. Silent failure when intersect pipeline does store instead of load

This should complain:

    recent > intersect [> py]

This is OK. The > py doesn't make sense, but it does yield an empty
stream, and the intersection result is correct.

----------------------------------------------------------------------

FIXED

93. Bash is using its own list of interactive executables

Should be using the one in env.

----------------------------------------------------------------------

FIXED

94. window omitting last output

    M-0.10.11 jao@cheese:~/git/marcel/test$ gen 4 1 | args [n: gen (n)] | window (x: x == 0) 
    0
    [0, 1]
    [0, 1, 2]

[0, 1, 2, 3] is missing.

----------------------------------------------------------------------

FIXED

96. ps crashing

M-0.10.14 jao@cheese:~$ timer 1 | args [t: ps]
<class 'object'>: <object object at 0x7faa0d47a550>
Process Process-8:
Traceback (most recent call last):
  File "/usr/lib/python3.8/multiprocessing/process.py", line 315, in _bootstrap
    self.run()
  File "/usr/lib/python3.8/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/home/jao/git/marcel/marcel/job.py", line 145, in run_command_in_child
    child_namespace_changes = command.execute()
  File "/home/jao/git/marcel/marcel/core.py", line 460, in execute
    self.pipeline.receive(None)
  File "/home/jao/git/marcel/marcel/core.py", line 393, in receive
    self.first_op.receive_input(x)
  File "/home/jao/git/marcel/marcel/core.py", line 196, in receive_input
    self.receive(None if x is None else
  File "/home/jao/git/marcel/marcel/op/timer.py", line 117, in receive
    self.send(now)
  File "/home/jao/git/marcel/marcel/core.py", line 179, in send
    receiver.receive_input(x)
  File "/home/jao/git/marcel/marcel/core.py", line 196, in receive_input
    self.receive(None if x is None else
  File "/home/jao/git/marcel/marcel/op/args.py", line 75, in receive
    self.impl.receive(x)
  File "/home/jao/git/marcel/marcel/op/args.py", line 104, in receive
    self.generate_and_run_pipeline()
  File "/home/jao/git/marcel/marcel/op/args.py", line 141, in generate_and_run_pipeline
    marcel.core.Command(None, self.pipeline).execute()
  File "/home/jao/git/marcel/marcel/core.py", line 458, in execute
    self.pipeline.setup_1()
  File "/home/jao/git/marcel/marcel/core.py", line 377, in setup_1
    op.setup_1()
  File "/home/jao/git/marcel/marcel/op/ps.py", line 104, in setup_1
    self.user = os.getuid() if self.user in (None, True) else Ps.convert_to_id(self.user, marcel.util.uid)
  File "/home/jao/git/marcel/marcel/op/ps.py", line 136, in convert_to_id
    except ValueError:
TypeError: int() argument must be a string, a bytes-like object or a number, not 'object'

----------------------------------------------------------------------

FIXED

98. Autocomplete doesn't work in pipeline

    l<tab>
    load  loop  ls 

    ls | args [l<tab>

doesn't show any options.

Don't forget to add a test to test_tab_completion

Notes:

- End of Parser.op_args does self.current_ops.pop(), restoring args as
  current op, instead of "l".

- Parser.arg calls self.next_token(End) but doesn't check that it's there. Allows 
  things like this to work: "sudo [ls". FIXED

----------------------------------------------------------------------

NOT A BUG

99. Redirection doesn't work for executables

This works, putting a list of Files into x:

    ls > x

This does not work:

    date > x

Error message: Variable date is undefined.

......................................................................

Works now.

----------------------------------------------------------------------

FIXED

100. Space after tab-completed flag is missing

ls --r<tab>

should produce '--recursive '. The space is omitted.

----------------------------------------------------------------------

FIXED

101. EOF in the middle of an Expression produces a stack dump and crash

M-0.10.16 jao@cheese:~/git/marcel$ ls -fr marcel test | ext py | map (f: f.read.count('\n'
Traceback (most recent call last):
  File "/usr/lib/python3.8/runpy.py", line 193, in _run_module_as_main
    return _run_code(code, main_globals, None,
  File "/usr/lib/python3.8/runpy.py", line 86, in _run_code
    exec(code, run_globals)
  File "/home/jao/git/marcel/marcel/main.py", line 305, in <module>
    MAIN.run()
  File "/home/jao/git/marcel/marcel/main.py", line 131, in run
    self.run_command(self.input)
  File "/home/jao/git/marcel/marcel/main.py", line 144, in run_command
    pipeline = parser.parse()
  File "/home/jao/git/marcel/marcel/parser.py", line 811, in parse
    return self.command()
  File "/home/jao/git/marcel/marcel/parser.py", line 819, in command
    return self.pipeline(None)
  File "/home/jao/git/marcel/marcel/parser.py", line 906, in pipeline
    op_sequence = self.op_sequence()
  File "/home/jao/git/marcel/marcel/parser.py", line 933, in op_sequence
    return op_args + self.op_sequence()
  File "/home/jao/git/marcel/marcel/parser.py", line 933, in op_sequence
    return op_args + self.op_sequence()
  File "/home/jao/git/marcel/marcel/parser.py", line 930, in op_sequence
    op_args = [self.op_args()]
  File "/home/jao/git/marcel/marcel/parser.py", line 948, in op_args
    arg_token = self.arg()
  File "/home/jao/git/marcel/marcel/parser.py", line 962, in arg
    if self.next_token(Begin):
  File "/home/jao/git/marcel/marcel/parser.py", line 1000, in next_token
    raise self.tokens[self.t].exception
  File "/home/jao/git/marcel/marcel/parser.py", line 590, in tokens
    token = self.next_token()
  File "/home/jao/git/marcel/marcel/parser.py", line 602, in next_token
    token = Expression(self.text, self.end, adjacent_to_previous)
  File "/home/jao/git/marcel/marcel/parser.py", line 272, in __init__
    self.scan()
  File "/home/jao/git/marcel/marcel/parser.py", line 335, in scan
    raise LexerException(self, 'Malformed Python expression')
marcel.parser.LexerException: ("(f: f.read.count('\\n'", 'Malformed Python expression')
jao@cheese:~/git/marcel$ 


----------------------------------------------------------------------

NOT FIXABLE

There is already an error message identifying unhashable input.

102. Set ops can't be applied to lists

And the lists can't be anywhere, not even deeply nested. The problem
is hashing, which is applied deeply, and may reach a list. Lists are
not hashable.

Comparison-based algorithms are out too, since, for example:

    >>> [1,2] < ['a']
    Traceback (most recent call last):
      File "<stdin>", line 1, in <module>
    TypeError: '<' not supported between instances of 'int' and 'str'

Hmm.

----------------------------------------------------------------------

103. RUN_ON_STARTUP symbols should count toward config symbols, not session symbols

ext is defined in ~/.marcel.py, in RUN_ON_STARTUP.

M-0.10.16 jao@cheese:~/git/marcel/test$ env -s
('ext', [e: select(lambda e: lambda f: f.suffix == '.' + e)])

----------------------------------------------------------------------

NOT A BUG

Probably fixed by recent work on env

104. Control over run immediate vs. in job needs work

env runs in same process, and works:

    M-0.10.17 jao@cheese:~/git/marcel$ env 
    ('BOLD', 1)
    ('COLOR_EXT_IMAGE', Color(3, 0, 2, BOLD))
    ...

env > e fails:

    M-0.10.17 jao@cheese:~/git/marcel$ env > e
    Process Process-15:
    Traceback (most recent call last):
      File "/usr/lib/python3.8/multiprocessing/process.py", line 315, in _bootstrap
        self.run()
      File "/usr/lib/python3.8/multiprocessing/process.py", line 108, in run
        self._target(*self._args, **self._kwargs)
      File "/home/jao/git/marcel/marcel/job.py", line 147, in run_command_in_child
        writer.send(child_namespace_changes)
      File "/usr/lib/python3.8/multiprocessing/connection.py", line 206, in send
        self._send_bytes(_ForkingPickler.dumps(obj))
      File "/usr/lib/python3.8/multiprocessing/reduction.py", line 51, in dumps
        cls(buf, protocol).dump(obj)
    _pickle.PicklingError: Can't pickle <function <lambda> at 0x7fc5361bd820>: attribute lookup <lambda> on __main__ failed
    M-0.10.17 jao@cheese:~/git/marcel$ 
    
The pipeline has two ops, so Main.run_immediate returns false.

----------------------------------------------------------------------

FIXED

105. Stack dump printed if pipeline requiring args is run without pipeline

M-0.10.17 jao@cheese:~/git/marcel/experiments$ (ext)
[e: select(lambda e: lambda f: f.suffix == '.' + e)]
M-0.10.17 jao@cheese:~/git/marcel/experiments$ ext
Process Process-4:
Traceback (most recent call last):
  File "/usr/lib/python3.8/multiprocessing/process.py", line 315, in _bootstrap
    self.run()
  File "/usr/lib/python3.8/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/home/jao/git/marcel/marcel/job.py", line 145, in run_command_in_child
    child_namespace_changes = command.execute(self.env)
  File "/home/jao/git/marcel/marcel/core.py", line 478, in execute
    self.pipeline.receive(None)
  File "/home/jao/git/marcel/marcel/core.py", line 411, in receive
    self.first_op.receive_input(x)
  File "/home/jao/git/marcel/marcel/core.py", line 199, in receive_input
    self.receive(None if x is None else
  File "/home/jao/git/marcel/marcel/op/runpipeline.py", line 57, in receive
    self.pipeline.receive(x)
  File "/home/jao/git/marcel/marcel/core.py", line 411, in receive
    self.first_op.receive_input(x)
  File "/home/jao/git/marcel/marcel/core.py", line 199, in receive_input
    self.receive(None if x is None else
  File "/home/jao/git/marcel/marcel/op/select.py", line 58, in receive
    if self.function(*x):
TypeError: FunctionWrapper object argument after * must be an iterable, not NoneType

This appears to depend on the fact that ext is defined in RUN_ON_STARTUP.

----------------------------------------------------------------------

FIXED

106. Wrong error message

    p = [x: gen(x)]
    p

Error message is: 

    Error evaluating lambda x: lambda: x on None: <lambda>() missing 1 required positional argument: 'x'

Should be:

    Unbound pipeline parameters for ...

I think.
 
----------------------------------------------------------------------

FIXED

107. Stack trace on db authentication failure

M-0.10.18 jao@cheese:~/git/marcel$ sql -d jdb 'select * from t'
Process Process-7:
Traceback (most recent call last):
  File "/usr/lib/python3.8/multiprocessing/process.py", line 315, in _bootstrap
    self.run()
  File "/usr/lib/python3.8/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/home/jao/git/marcel/marcel/job.py", line 147, in run_command_in_child
    child_namespace_changes = command.execute(self.env)
  File "/home/jao/git/marcel/marcel/core.py", line 477, in execute
    self.pipeline.setup_1(env)
  File "/home/jao/git/marcel/marcel/core.py", line 387, in setup_1
    op.setup_1(env)
  File "/home/jao/git/marcel/marcel/op/sql.py", line 125, in setup_1
    self.connection = self.db.connection()
  File "/home/jao/git/marcel/marcel/object/db.py", line 41, in connection
    return self.connection_class(self)
  File "/home/jao/git/marcel/marcel/object/db.py", line 80, in __init__
    connection = psycopg2.connect(dbname=db.dbname,
  File "/usr/local/lib/python3.8/dist-packages/psycopg2/__init__.py", line 127, in connect
    conn = _connect(dsn, connection_factory=connection_factory, **kwasync)
psycopg2.OperationalError: fe_sendauth: no password supplied

----------------------------------------------------------------------

FIXED

109. Slow command after storing large sequence

If the env is large, then every command is slow because copying the
env from one process to another is slow. E.g. 

    cd ~/git
    ls -fr > x
    gen 40 1 | args [n: gen (n) 1 | red * | map (f: (n, f))]

To be fair, this is a lot of env copying, once per iteration through
args.

Hmm. That's not it. gen 1 1 | args ... is also slow. I don't
understand why this particular command is slow but others are not,
after ls -fr > x.

The problem is copying FunctionWrapper._globals, which contains x. And
_globals isn't really the problem, since the function's code would
have to have the env too, (__globals__)

Can a function's closure be discovered? If it can, then do that, and
limit the namespace to just the closure. (Might require two evals, one
to get the closure, one to create the function with the reduced
namespace).

OR: 

- Create the function with an empty namespace.
- inspect.getclosurevars(f).unbound is the set of unbound vars
- Create the function again, with a namespace based on those unbound vars.


This doesn't fix the problem. pipeline.copy() still copies the entire
env.  This approach would require computing the reduced set of globals
for the entire pipeline.

And of course, this approach is not foolproof, as an environment var
can be referred to indirectly, e.g. "globals()['x']" instead of "x".

ACCUMULATING ARBITRARILY LARGE RESULTS IN MEMORY MAY BE A BAD IDEA.

----------------------------------------------------------------------

FIXED

110. API doesn't clean up reservoirs

----------------------------------------------------------------------

NOT A BUG: Sending reservoirs to remote hosts is dumb

111. Improve serialization of Reservoirs for remote execution

Currently, the reservoir's file name is transmitted, which won't work
(except for localhost, under some conditions).

----------------------------------------------------------------------

FIXED

115. store op should flush occasionally

E.g., in situations like this:

      timer 1 > x

Could flush after each dill.dump(). Is that guaranteed to produce a
readable result? That could get expensive. Flush periodically? How
would this be specified/controlled?

Flushing isn't the entire problem. x doesn't show up in env until the
pipeline finishes execution. Before execution, need to analyze
pipeline for new variables.

----------------------------------------------------------------------

FIXED

116. Why is this crashing?

M-0.10.24 jao@cheese:~/git/marcel$ ls marcel test | out | args [d: ls -fr (d) | ext py | map (f: (f, f.read().count('\n'))) | sort (f, n: n) | tail 10]
drwxr-xr-x   jao    jao        4096   2020 Oct 05 14:09:31   marcel
(op/sql.py, 245)
(op/window.py, 254)
(op/fork.py, 296)
(job.py, 305)
(main.py, 316)
(env.py, 336)
(argsparser.py, 493)
(core.py, 514)
(helpformatter.py, 568)
(parser.py, 1099)
-rw-r--r--   jao    jao         652   2020 May 10 15:41:11   marcel/__init__.py
Process Process-11:
Traceback (most recent call last):
  File "/usr/lib/python3.8/multiprocessing/process.py", line 315, in _bootstrap
    self.run()
  File "/usr/lib/python3.8/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/home/jao/git/marcel/marcel/job.py", line 147, in run_command_in_child
    child_namespace_changes = command.execute(self.env)
  File "/home/jao/git/marcel/marcel/core.py", line 463, in execute
    self.pipeline.receive(None)
  File "/home/jao/git/marcel/marcel/core.py", line 396, in receive
    self.first_op.receive_input(x)
  File "/home/jao/git/marcel/marcel/core.py", line 193, in receive_input
    self.receive(None if x is None else
  File "/home/jao/git/marcel/marcel/op/ls.py", line 155, in receive
    self.visit(root, 0)
  File "/home/jao/git/marcel/marcel/op/ls.py", line 167, in visit
    self.visit(file, level + 1)
  File "/home/jao/git/marcel/marcel/op/ls.py", line 163, in visit
    self.send_path(root)
  File "/home/jao/git/marcel/marcel/op/ls.py", line 180, in send_path
    self.send(file)
  File "/home/jao/git/marcel/marcel/core.py", line 176, in send
    receiver.receive_input(x)
  File "/home/jao/git/marcel/marcel/core.py", line 193, in receive_input
    self.receive(None if x is None else
  File "/home/jao/git/marcel/marcel/op/out.py", line 124, in receive
    self.send(x)
  File "/home/jao/git/marcel/marcel/core.py", line 176, in send
    receiver.receive_input(x)
  File "/home/jao/git/marcel/marcel/core.py", line 193, in receive_input
    self.receive(None if x is None else
  File "/home/jao/git/marcel/marcel/op/args.py", line 78, in receive
    self.impl.receive(x)
  File "/home/jao/git/marcel/marcel/op/args.py", line 108, in receive
    self.generate_and_run_pipeline()
  File "/home/jao/git/marcel/marcel/op/args.py", line 145, in generate_and_run_pipeline
    marcel.core.Command(None, self.pipeline).execute(self.op.env())
  File "/home/jao/git/marcel/marcel/core.py", line 460, in execute
    self.pipeline.setup_1(env)
  File "/home/jao/git/marcel/marcel/core.py", line 374, in setup_1
    op.setup_1(env)
  File "/home/jao/git/marcel/marcel/op/runpipeline.py", line 36, in setup_1
    assert self.pipeline is None
AssertionError


Simplifying: This causes the crash too:

    ls marcel | args [d: ls -fr (d) | ext py ]

But this does not:

    ls marcel | args [d: ls -fr (d) ]

Even simpler:

    g = [n: gen (n)]
    gen 3 1 | args [n: g (n)]

The problem seems to be a pipeline var inside args.

----------------------------------------------------------------------

FIXED

117. Heuristic for determining whether out should be appended is wrong


    f = [x: gen (x) 1 | args [n: gen (n) 1 | red * | map (f: (n, f))] | out '{}: {}']
    f (5)

output:

    1: 1
    (1, 1)
    2: 2
    (2, 2)
    3: 6
    (3, 6)
    4: 24
    (4, 24)
    5: 120
    (5, 120)

Because out is not terminal in the topmost pipeline.


----------------------------------------------------------------------

FIXED

118. Invoking runpipeline inside args results in RecursionError

M-0.10.25 jao@cheese:~$ fact = [x: gen (x) 1 | args [n: gen (n) 1 | red * | map (f: (n, f))]]
M-0.10.25 jao@cheese:~$ fact (20)
(1, 1)
(2, 2)
(3, 6)
(4, 24)
(5, 120)
(6, 720)
(7, 5040)
(8, 40320)
(9, 362880)
(10, 3628800)
(11, 39916800)
(12, 479001600)
(13, 6227020800)
(14, 87178291200)
(15, 1307674368000)
(16, 20922789888000)
Cloning error: (<class 'RecursionError'>) maximum recursion depth exceeded while calling a Python object
Caught <class 'RecursionError'>: maximum recursion depth exceeded while calling a Python object


It looks like the pipeline SOURCE being copied by args keeps growing?!?!

----------------------------------------------------------------------

FIXED

119.

M-0.11.0 jao@cheese:~/git/marcel$ ls -fr marcel test | ext py 
Process Process-8:
Traceback (most recent call last):
  File "/home/jao/git/marcel/marcel/functionwrapper.py", line 89, in __call__
    return self.function()(*args, **kwargs)
  File "<string>", line 1, in <lambda>
NameError: name 'e' is not defined

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/lib/python3.8/multiprocessing/process.py", line 315, in _bootstrap
    self.run()
  File "/usr/lib/python3.8/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/home/jao/git/marcel/marcel/job.py", line 147, in run_command_in_child
    child_namespace_changes = command.execute(self.env)
  File "/home/jao/git/marcel/marcel/core.py", line 389, in execute
    self.pipeline.receive(None)
  File "/home/jao/git/marcel/marcel/core.py", line 339, in receive
    self.ops[0].receive_input(x)
  File "/home/jao/git/marcel/marcel/core.py", line 161, in receive_input
    self.receive(None if x is None else
  File "/home/jao/git/marcel/marcel/op/ls.py", line 154, in receive
    self.visit(root, 0)
  File "/home/jao/git/marcel/marcel/op/ls.py", line 166, in visit
    self.visit(file, level + 1)
  File "/home/jao/git/marcel/marcel/op/ls.py", line 162, in visit
    self.send_path(root)
  File "/home/jao/git/marcel/marcel/op/ls.py", line 179, in send_path
    self.send(file)
  File "/home/jao/git/marcel/marcel/core.py", line 144, in send
    receiver.receive_input(x)
  File "/home/jao/git/marcel/marcel/core.py", line 161, in receive_input
    self.receive(None if x is None else
  File "/home/jao/git/marcel/marcel/op/runpipeline.py", line 51, in receive
    self.pipeline.receive(x)
  File "/home/jao/git/marcel/marcel/core.py", line 339, in receive
    self.ops[0].receive_input(x)
  File "/home/jao/git/marcel/marcel/core.py", line 161, in receive_input
    self.receive(None if x is None else
  File "/home/jao/git/marcel/marcel/op/select.py", line 58, in receive
    fx = self.function() if x is None else self.function(*x)
  File "/home/jao/git/marcel/marcel/functionwrapper.py", line 91, in __call__
    self.handle_error(e, self.function_input_description(args, kwargs))
  File "/home/jao/git/marcel/marcel/functionwrapper.py", line 111, in handle_error
    self._op.fatal_error(function_input_string, str(e))
  File "/home/jao/git/marcel/marcel/core.py", line 191, in fatal_error
    self.owner.handle_error(error)
  File "/home/jao/git/marcel/marcel/core.py", line 308, in handle_error
    self.error_handler(self.env(), error)
  File "/home/jao/git/marcel/marcel/main.py", line 239, in default_error_handler
    print(error.render_full(env.color_scheme()))
AttributeError: 'NoneType' object has no attribute 'color_scheme'
M-0.11.0 jao@cheese:~/git/marcel$ 


----------------------------------------------------------------------

FIXED

120. cd into a non-directory crashes

M-0.11.0 jao@cheese:~/git/geophile$ cd sjt
Traceback (most recent call last):
  File "/usr/lib/python3.8/runpy.py", line 193, in _run_module_as_main
    return _run_code(code, main_globals, None,
  File "/usr/lib/python3.8/runpy.py", line 86, in _run_code
    exec(code, run_globals)
  File "/home/jao/git/marcel/marcel/main.py", line 307, in <module>
    MAIN.run()
  File "/home/jao/git/marcel/marcel/main.py", line 131, in run
    self.run_command(self.input)
  File "/home/jao/git/marcel/marcel/main.py", line 153, in run_command
    command.execute()
  File "/home/jao/git/marcel/marcel/core.py", line 379, in execute
    self.pipeline.receive(None)
  File "/home/jao/git/marcel/marcel/core.py", line 330, in receive
    self.ops[0].receive_input(x)
  File "/home/jao/git/marcel/marcel/core.py", line 147, in receive_input
    self.receive(None if x is None else
  File "/home/jao/git/marcel/marcel/op/cd.py", line 59, in receive
    self.env().dir_state().cd(self.directory)
  File "/home/jao/git/marcel/marcel/env.py", line 108, in cd
    os.chdir(new_dir)
NotADirectoryError: [Errno 20] Not a directory: '/home/jao/git/geophile/sjt'
jao@cheese:~/git/geophile$ ls

----------------------------------------------------------------------

121. Crash when referring to undefined cluster

M-0.11.0 jao@cheese:~$ @jao [ gen 3 -1 | map (x: 1/x) ]
Process Process-2:
Traceback (most recent call last):
  File "/usr/lib/python3.8/multiprocessing/process.py", line 315, in _bootstrap
    self.run()
  File "/usr/lib/python3.8/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/home/jao/git/marcel/marcel/job.py", line 147, in run_command_in_child
    child_namespace_changes = command.execute(self.env)
  File "/home/jao/git/marcel/marcel/core.py", line 376, in execute
    self.pipeline.setup_1()
  File "/home/jao/git/marcel/marcel/core.py", line 317, in setup_1
    op.setup_1()
  File "/home/jao/git/marcel/marcel/op/fork2.py", line 63, in setup_1
    for host in self.cluster.hosts:
AttributeError: 'NoneType' object has no attribute 'hosts'

----------------------------------------------------------------------

NOT A BUG

122. Killing foreground job on ctrl-c is broken

Not happening now.

M-0.11.0 jao@cheese:~/git/marcel$ timer 1
1602780803.0
1602780804.0
1602780805.0
^CM-0.11.0 jao@cheese:~/git/marcel$ 

----------------------------------------------------------------------

FIXED

123. This should be a syntax error

M-0.11.1 jao@cheese:~/git/marcel$ p = gen n | args [n: echo (n)]
M-0.11.1 jao@cheese:~/git/marcel$ (p)
gen

----------------------------------------------------------------------

FIXED

124. Pipeline arg not bound

While investigating 118:

M-0.11.2 jao@cheese:~/git/marcel/test$ fact = [x: gen (x) 1 | args [n: gen (n) 1 | red * | map (f: (n, f))]]
M-0.11.2 jao@cheese:~/git/marcel/test$ fact (20)
Error: Running gen(count=lambda: x, start=1, pad=None): name 'x' is not defined
name 'x' is not defined

- x should be defined
- don't need the error message twice

*** Does RunPipeline.setup() need to copy the pipeline?

----------------------------------------------------------------------

FIXED

125. Scope counting is broken

    M-0.11.2 jao@cheese:~$ recent = [n: select (f: f.mtime - now() < days(n))]
    M-0.11.2 jao@cheese:~$ ls | recent (1)
    drwxr-xr-x   jao    jao        4096   2020 Oct 15 23:01:32   .
    drwxr-xr-x   jao    jao        4096   2019 Jan 29 10:22:28   .CLion2018.3
    drwxrwxr-x   jao    jao        4096   2019 Apr 01 16:04:44   .CLion2019.1
    drwxrwxr-x   jao    jao        4096   2019 Sep 08 14:13:25   .CLion2019.2
    -rw-------   jao    jao       12092   2019 Dec 11 20:59:24   .ICEauthority
    drwxr-xr-x   jao    jao        4096   2019 Jan 25 23:26:10   .IntelliJIdea2018.3
    drwxrwxr-x   jao    jao        4096   2019 Jul 25 10:25:22   .IntelliJIdea2019.2
    drwxrwxr-x   jao    jao        4096   2019 Feb 04 15:17:08   .PyCharm2018.3
    drwxrwxr-x   jao    jao        4096   2019 Mar 29 09:47:46   .PyCharm2019.1
    drwxrwxr-x   jao    jao        4096   2019 Jul 24 19:49:51   .PyCharm2019.2
    -rw-------   jao    jao         312   2020 Jun 24 23:29:10   .Xauthority
    -rw-------   jao    jao       31894   2020 Oct 15 17:26:46   .bash_history
    -rw-r--r--   jao    jao         220   2019 Jan 25 19:23:32   .bash_logout
    -rw-r--r--   jao    jao        5424   2020 May 21 19:45:49   .bashrc
    -rw-r--r--   jao    jao        3771   2019 Jan 25 13:30:51   .bashrc~
    drwxrwxr-x   jao    jao        4096   2019 Mar 30 18:52:26   .bazaar
    -rw-r--r--   jao    jao      105922   2019 Aug 25 12:34:21   .bzr.log
    drwxrwxr-x   jao    jao        4096   2020 Oct 05 09:39:57   .cache
    drwxrwxr-x   jao    jao        4096   2020 Sep 27 21:18:17   .config
    drwx------   jao    jao        4096   2019 Dec 11 20:58:25   .config.bak
    drwx------   jao    jao        4096   2019 Dec 11 20:58:25   .config.bk
    drwx------   jao    jao        4096   2019 Mar 25 17:12:12   .dbus
    drwxr-xr-x   jao    jao        4096   2019 Mar 10 17:20:32   .debug
    drwx------   jao    jao        4096   2020 Oct 15 23:00:04   .emacs.d
    drwx------   jao    jao        4096   2019 Sep 02 14:27:46   .gconf
    -rw-r--r--   jao    jao          79   2013 Jan 31 17:47:52   .gitconfig
    drwx------   jao    jao        4096   2019 Jan 29 10:23:23   .gnome
    drwx------   jao    jao        4096   2019 Mar 10 23:47:14   .gnubg
    drwx------   jao    jao        4096   2020 Oct 11 10:19:41   .gnupg
    drwxr-xr-x   jao    jao        4096   2019 Sep 06 15:04:05   .gphoto
    drwxr-xr-x   jao    jao        4096   2019 Jan 29 00:10:08   .idea
    drwxr-xr-x   jao    jao        4096   2020 May 08 12:03:12   .ipython
    drwxr-xr-x   jao    jao        4096   2019 May 13 08:09:44   .java
    -rw-------   jao    jao          59   2020 May 12 19:43:08   .lesshst
    drwx------   jao    jao        4096   2020 May 10 12:02:43   .local
    drwxrwxr-x   jao    jao        4096   2019 Jul 25 11:11:15   .m2
    -rw-r--r--   jao    jao        2186   2020 Oct 14 12:53:42   .marcel.py
    -rw-------   jao    jao       18577   2020 Oct 15 23:01:32   .marcel_history
    drwxr-xr-x   jao    jao        4096   2019 May 28 10:04:17   .minimachete
    drwxrwxr-x   jao    jao        4096   2019 Sep 02 14:27:46   .mono
    drwx------   jao    jao        4096   2019 Jan 25 19:24:04   .mozilla
    drwx------   jao    jao        4096   2019 Feb 10 22:50:21   .mozilla-backup
    -rw-rw-r--   jao    jao        1774   2019 Apr 13 17:21:29   .oshrc
    -rw-r--r--   jao    jao         361   2019 Jan 25 19:23:33   .pam_environment
    drwx------   jao    jao        4096   2019 Jan 25 13:47:31   .pki
    -rw-r--r--   jao    jao         807   2019 Jan 25 19:23:32   .profile
    -rw-------   jao    jao       21760   2020 Sep 19 20:19:42   .psql_history
    -rw-------   jao    jao           0   2019 Jun 22 15:51:19   .psql_history-08976.tmp
    -rw-------   jao    jao           0   2019 Dec 09 12:24:33   .psql_history-19841.tmp
    -rw-------   jao    jao           0   2019 Sep 04 19:36:41   .psql_history-31689.tmp
    -rw-r--r--   jao    jao          16   2019 Jan 28 13:00:35   .psqlrc
    -rw-r--r--   jao    jao         430   2020 May 10 13:09:33   .pypirc
    -rw-------   jao    jao       16574   2020 Oct 15 10:22:23   .python_history
    drwxr-xr-x   jao    jao        4096   2019 Sep 09 10:24:20   .racket
    -rw-r--r--   root   root         71   2019 May 30 23:13:46   .selected_editor
    drwx------   jao    jao        4096   2020 Jun 11 21:36:02   .ssh
    drwxr-xr-x   jao    jao        4096   2019 Jan 25 22:44:47   .subversion
    -rw-r--r--   jao    jao           0   2019 Jan 25 12:42:18   .sudo_as_admin_successful
    drwxrwxr-x   jao    jao        4096   2020 Jun 22 21:42:22   .support-experiment
    -rw-------   jao    jao        4096   2020 Jan 26 17:55:53   .swo
    -rw-------   jao    jao        4096   2020 Jan 26 17:55:28   .swp
    drwx------   jao    jao        4096   2019 Nov 10 22:22:48   .thunderbird
    -rw-r--r--   jao    jao         285   2020 Mar 19 10:18:43   .wget-hsts
    -rw-------   jao    jao        4615   2019 Dec 11 20:59:23   .xsession-errors
    drwxr-xr-x   jao    jao        4096   2020 Jul 02 14:12:46   .zoom
    lrwxrwxrwx   jao    jao          24   2020 Jan 10 14:24:27   115 -> teaching/tufts/115/2020s
    drwxrwxr-x   jao    jao        4096   2019 Apr 02 09:01:59   Audiobooks
    drwxr-xr-x   jao    jao        4096   2020 Oct 02 16:41:48   Desktop
    drwxr-xr-x   jao    jao        4096   2020 Aug 22 10:08:00   Documents
    drwxr-xr-x   jao    jao        4096   2020 Sep 29 10:41:38   Downloads
    -rw-rw-r--   jao    jao     1866972   2020 Sep 18 11:36:02   Firefox_wallpaper.png
    drwxr-xr-x   jao    jao        4096   2019 Sep 24 16:14:20   Francine
    drwxr-xr-x   jao    jao        4096   2019 Jul 18 12:19:42   GNUstep
    drwxr-xr-x   jao    jao        4096   2019 Apr 19 14:52:38   Hannah 26
    drwxr-xr-x   jao    jao        4096   2019 Nov 13 15:43:21   Head Over Heels
    drwxr-xr-x   jao    jao        4096   2019 Feb 19 21:02:23   Love At First Like
    drwx------   jao    jao        4096   2019 May 28 13:30:03   Music
    drwxr-xr-x   jao    jao        4096   2020 May 26 17:40:33   Pictures
    drwxrwxr-x   jao    jao        4096   2019 Apr 02 09:01:59   Podcasts
    drwxr-xr-x   jao    jao        4096   2019 Jan 25 19:23:52   Public
    drwxr-xr-x   jao    jao        4096   2019 Jan 25 19:23:52   Templates
    drwxr-xr-x   jao    jao        4096   2019 Jan 25 19:23:52   Videos
    drwxrwxr-x   jao    jao        4096   2020 Aug 14 15:31:14   __pycache__
    -rw-rw-r--   jao    jao         131   2020 Jul 22 08:59:28   acme.txt
    drwxr-xr-x   jao    jao        4096   2020 Jan 01 11:05:32   backup
    drwxr-xr-x   jao    jao        4096   2020 Jun 11 21:20:04   bin
    drwxr-xr-x   jao    jao        4096   2019 Jun 18 11:06:54   blackring
    drwxr-xr-x   jao    jao        4096   2020 Aug 30 17:21:15   boat
    -rw-rw-r--   jao    jao           6   2020 Aug 02 20:53:19   bug_76.txt
    -rw-rw-r--   jao    jao        1672   2020 Sep 06 12:25:20   canada.txt
    drwxr-xr-x   jao    jao        4096   2019 Oct 18 14:44:52   consulting
    -rw-r--r--   jao    jao       26721   2020 Mar 26 19:03:39   coronavirus_journal.txt
    drwxrwxr-x   jao    jao        4096   2019 Nov 10 12:22:41   ephemera
    drwxr-xr-x   jao    jao        4096   2017 Jun 23 17:58:43   erdo
    drwxr-xr-x   jao    jao        4096   2019 Mar 15 16:23:53   facebook
    drwxrwxr-x   jao    jao        4096   2020 Aug 22 10:23:58   frog
    -rw-rw-r--   jao    jao         654   2020 Aug 20 16:38:58   getout.txt
    drwxr-xr-x   jao    jao        4096   2020 Sep 23 17:38:50   git
    drwxr-xr-x   jao    jao        4096   2019 Dec 29 11:50:03   hacks
    drwxr-xr-x   jao    jao        4096   2020 Jan 04 13:35:04   jt_loan
    -rw-rw-r--   jao    jao        1992   2020 Sep 19 13:22:44   lasagna.txt
    drwxr-xr-x   jao    jao        4096   2018 Dec 21 11:09:47   lizp
    drwxr-xr-x   jao    jao        4096   2019 Feb 13 21:35:53   llvm
    -rw-r--r--   jao    jao        6711   2020 Jan 29 16:25:08   mario.txt
    drwxrwxr-x   jao    jao        4096   2020 Jul 23 19:13:32   martel
    -rw-r--r--   jao    jao        1118   2020 Mar 23 10:07:33   max_2020_03_23.txt
    -rw-rw-r--   jao    jao         361   2020 Sep 21 15:28:13   max_2020_09_21.txt
    drwxr-xr-x   jao    jao        4096   2019 Feb 07 22:20:22   mintyzack
    -rw-rw-r--   jao    jao         316   2020 Sep 05 20:04:09   movies.txt
    -rw-rw-r--   jao    jao       44985   2019 Feb 15 11:02:00   mozilla.pdf
    -rw-rw-r--   jao    jao        2941   2020 Sep 23 16:41:39   nethar.txt
    -rw-rw-r--   jao    jao         217   2020 Sep 01 20:42:40   notes.txt
    drwxrwxr-x   jao    jao        4096   2020 Aug 14 10:15:26   nothing
    -rw-rw-r--   jao    jao         869   2020 Aug 25 13:54:19   nothing.txt
    drwxr-xr-x   jao    jao        4096   2020 May 15 09:52:38   opt
    -rw-rw-r--   jao    jao       37211   2020 Oct 15 17:19:10   passwords.txt
    -rw-r--r--   jao    jao       13377   2019 Jan 20 12:43:37   reality_distortion_field.md
    -rw-rw-r--   jao    jao        2415   2019 Oct 06 23:13:49   reload.txt
    drwxrwxr-x   jao    jao        4096   2019 May 11 11:25:08   sailboat
    -rw-rw-r--   jao    jao        3509   2019 Nov 01 14:35:51   sandy.txt
    -rw-rw-r--   jao    jao        1045   2020 Oct 02 14:08:49   shell-collab.txt
    -rw-r--r--   jao    jao         318   2020 Apr 06 22:59:20   shopping.txt
    drwxr-xr-x   jao    jao        4096   2019 Aug 11 18:30:01   snap
    -rw-r--r--   root   root    1011301   2020 Jun 08 16:10:55   system76-logs.tgz
    drwxr-xr-x   jao    jao        4096   2017 Nov 27 16:35:59   teaching
    -rw-rw-r--   jao    jao          79   2019 Oct 31 12:12:06   today.txt
    -rw-rw-r--   jao    jao           0   2020 Sep 08 12:33:24   todo.txt
    -rw-rw-r--   jao    jao         132   2020 Oct 14 15:33:44   trip.txt
    -rw-rw-r--   jao    jao         621   2020 Sep 11 11:43:57   vahan.txt
    drwxrwxr-x   jao    jao        4096   2020 Sep 18 11:36:49   wallpaper
    drwxr-xr-x   jao    jao        4096   2019 Apr 10 12:32:55   zack
    -rw-rw-r--   jao    jao         341   2020 Jun 10 15:34:07   zack_disk_usage.txt
    drwxrwxr-x   jao    jao        4096   2020 Sep 01 20:30:14   zkd_index
    Process Process-1:
    Traceback (most recent call last):
      File "/usr/lib/python3.8/multiprocessing/process.py", line 315, in _bootstrap
        self.run()
      File "/usr/lib/python3.8/multiprocessing/process.py", line 108, in run
        self._target(*self._args, **self._kwargs)
      File "/home/jao/git/marcel/marcel/job.py", line 147, in run_command_in_child
        child_namespace_changes = command.execute(self.env)
      File "/home/jao/git/marcel/marcel/core.py", line 373, in execute
        assert self.env.vars().n_scopes() == depth, self.env.vars().n_scopes()
    AssertionError: 133

The number in the assertion error happens to match the number of files printed.

----------------------------------------------------------------------

126. Reservoirs broken?

M-0.11.3 jao@cheese:~$ fact = [x: gen (x) 1 | args [n: gen (n) 1 | red * | map (f: (n, f))]]    
M-0.11.3 jao@cheese:~$ fact (100) > f
Process Process-4:
Traceback (most recent call last):
  File "/usr/lib/python3.8/multiprocessing/process.py", line 315, in _bootstrap
    self.run()
  File "/usr/lib/python3.8/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/home/jao/git/marcel/marcel/job.py", line 147, in run_command_in_child
    child_namespace_changes = command.execute(self.env)
  File "/home/jao/git/marcel/marcel/core.py", line 385, in execute
    self.pipeline.receive(None)
  File "/home/jao/git/marcel/marcel/core.py", line 333, in receive
    self.ops[0].receive_input(x)
  File "/home/jao/git/marcel/marcel/core.py", line 144, in receive_input
    self.receive(None if x is None else
  File "/home/jao/git/marcel/marcel/op/runpipeline.py", line 68, in receive
    self.pipeline.receive(x)
  File "/home/jao/git/marcel/marcel/core.py", line 333, in receive
    self.ops[0].receive_input(x)
  File "/home/jao/git/marcel/marcel/core.py", line 144, in receive_input
    self.receive(None if x is None else
  File "/home/jao/git/marcel/marcel/op/gen.py", line 98, in receive
    self.send(self.apply_padding(x))
  File "/home/jao/git/marcel/marcel/core.py", line 127, in send
    receiver.receive_input(x)
  File "/home/jao/git/marcel/marcel/core.py", line 144, in receive_input
    self.receive(None if x is None else
  File "/home/jao/git/marcel/marcel/op/args.py", line 77, in receive
    self.impl.receive(x)
  File "/home/jao/git/marcel/marcel/op/args.py", line 110, in receive
    self.run_pipeline(self.op.env())
  File "/home/jao/git/marcel/marcel/op/args.py", line 169, in run_pipeline
    marcel.core.Command(env, None, self.pipeline).execute()
  File "/home/jao/git/marcel/marcel/core.py", line 386, in execute
    self.pipeline.receive_complete()
  File "/home/jao/git/marcel/marcel/core.py", line 336, in receive_complete
    self.ops[0].receive_complete()
  File "/home/jao/git/marcel/marcel/core.py", line 158, in receive_complete
    self.send_complete()
  File "/home/jao/git/marcel/marcel/core.py", line 136, in send_complete
    self.receiver.receive_complete()
  File "/home/jao/git/marcel/marcel/op/red.py", line 167, in receive_complete
    self.reducer.receive_complete()
  File "/home/jao/git/marcel/marcel/op/red.py", line 202, in receive_complete
    self.op.send(tuple(self.accumulator))
  File "/home/jao/git/marcel/marcel/core.py", line 127, in send
    receiver.receive_input(x)
  File "/home/jao/git/marcel/marcel/core.py", line 144, in receive_input
    self.receive(None if x is None else
  File "/home/jao/git/marcel/marcel/op/map.py", line 66, in receive
    self.send(output)
  File "/home/jao/git/marcel/marcel/core.py", line 127, in send
    receiver.receive_input(x)
  File "/home/jao/git/marcel/marcel/core.py", line 144, in receive_input
    self.receive(None if x is None else
  File "/home/jao/git/marcel/marcel/op/store.py", line 103, in receive
    self.writer.write(x)
  File "/home/jao/git/marcel/marcel/reservoir.py", line 111, in write
    dill.dump(x, self.file)
  File "/usr/local/lib/python3.8/dist-packages/dill/_dill.py", line 259, in dump
    Pickler(file, protocol, **_kwds).dump(obj)
  File "/usr/local/lib/python3.8/dist-packages/dill/_dill.py", line 445, in dump
    StockPickler.dump(self, obj)
  File "/usr/lib/python3.8/pickle.py", line 482, in dump
    self.write(PROTO + pack("<B", self.proto))
  File "/usr/lib/python3.8/pickle.py", line 245, in write
    return self.file_write(data)
ValueError: write to closed file
M-0.11.3 jao@cheese:~$ 

----------------------------------------------------------------------

NOT A BUG

127. API env missing symbols

E.g. USER, HOME.

----------------------------------------------------------------------

NOT A BUG - defined behavior for negative arg

129. tail shouldn't allow negative args

Other ops likely have the same problem.

Doing parse-time checking isn't sufficient. A check is also needed at
execution time, for args that need to be evaluated. The conversion
functions in ArgsParser (e.g. str_to_int) don't really allow for that
second use, as they are tied to the ArgsParser object, which isn't
available at runtime. They could *almost* be made independent of
ArgsParser, but there are some dependencies:

- self.op_name: op isn't available during arg parsing. 

- self.env

- self.current_op: For function(). Need to revisit error handling
  (which is why f.set_op(self.current_op) is called), and perhaps get
  rid of this call.

Tail now defines behavior for negative args, but there is a general
problem. Args need to be checked at setup time, after function eval.

----------------------------------------------------------------------

FIXED

130. File.base incorrect?

These are all in the same directory, should be rendered without the directory info.

M-0.11.6 jao@cheese:~/git/marcel/marcel/op$ ls *.py | read -l | select (f, x: 'str_to_int' in x) | (f, x: f) | unique | sort
/home/jao/git/marcel/marcel/op/edit.py
/home/jao/git/marcel/marcel/op/expand.py
/home/jao/git/marcel/marcel/op/gen.py
/home/jao/git/marcel/marcel/op/head.py
/home/jao/git/marcel/marcel/op/jobop.py
/home/jao/git/marcel/marcel/op/run.py
/home/jao/git/marcel/marcel/op/sql.py
/home/jao/git/marcel/marcel/op/tail.py
/home/jao/git/marcel/marcel/op/window.py

read changes the base of the file. Because it extends FilenameOps
which passes pathlib.Paths to subclasses, losing the base informatino
from ls.

----------------------------------------------------------------------

FIXED

131. Crash on odd arg to read

M-0.11.6 jao@cheese:~/git/marcel/marcel/op$ read =l *.py
Process Process-30:
Traceback (most recent call last):
  File "/usr/lib/python3.8/multiprocessing/process.py", line 315, in _bootstrap
    self.run()
  File "/usr/lib/python3.8/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/home/jao/git/marcel/marcel/job.py", line 147, in run_command_in_child
    child_namespace_changes = command.execute(self.env)
  File "/home/jao/git/marcel/marcel/core.py", line 385, in execute
    self.pipeline.receive(None)
  File "/home/jao/git/marcel/marcel/core.py", line 333, in receive
    self.ops[0].receive_input(x)
  File "/home/jao/git/marcel/marcel/core.py", line 144, in receive_input
    self.receive(None if x is None else
  File "/home/jao/git/marcel/marcel/op/read.py", line 125, in receive
    super().receive(None)
  File "/home/jao/git/marcel/marcel/op/filenamesop.py", line 85, in receive
    self.visit(root, 0)
  File "/home/jao/git/marcel/marcel/op/filenamesop.py", line 90, in visit
    file = File(root, self.base, self.metadata_cache)
  File "/home/jao/git/marcel/marcel/op/read.py", line 140, in read_file
  File "/home/jao/git/marcel/marcel/op/read.py", line 158, in read_file
    try:
IsADirectoryError: [Errno 21] Is a directory: '/home/jao/git/marcel/marcel/op'

----------------------------------------------------------------------
FIXED

132. Crash when read given a directory

M-0.11.6 jao@cheese:~/git/marcel$ read -r /tmp
Process Process-7:
Traceback (most recent call last):
  File "/usr/lib/python3.8/multiprocessing/process.py", line 315, in _bootstrap
    self.run()
  File "/usr/lib/python3.8/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/home/jao/git/marcel/marcel/job.py", line 147, in run_command_in_child
    child_namespace_changes = command.execute(self.env)
  File "/home/jao/git/marcel/marcel/core.py", line 385, in execute
    self.pipeline.receive(None)
  File "/home/jao/git/marcel/marcel/core.py", line 333, in receive
    self.ops[0].receive_input(x)
  File "/home/jao/git/marcel/marcel/core.py", line 144, in receive_input
    self.receive(None if x is None else
  File "/home/jao/git/marcel/marcel/op/read.py", line 125, in receive
    super().receive(None)
  File "/home/jao/git/marcel/marcel/op/filenamesop.py", line 85, in receive
    self.visit(root, 0)
  File "/home/jao/git/marcel/marcel/op/filenamesop.py", line 91, in visit
    self.action(self, file)
  File "/home/jao/git/marcel/marcel/op/read.py", line 139, in read_file
    op.reader.read_file(op, file, [file] if op.label else None)
  File "/home/jao/git/marcel/marcel/op/read.py", line 157, in read_file
    with open(file.path, 'r') as input:
IsADirectoryError: [Errno 21] Is a directory: '/tmp'

----------------------------------------------------------------------

FIXED

133. Command works the first time it is used, but not after that

grem is defined in .marcel.py:

    grem = [pattern, files: read -l (files) | select (f, l: pattern in l) | map (f, l: f) | unique]

M-0.11.6 jao@cheese:~$ cd git/marcel/marcel/op

M-0.11.6 jao@cheese:~/git/marcel/marcel/op$ ls *.py | args [f: grem Disjoint (f)]
-rw-rw-r--   jao    jao        7331   2020 Oct 27 16:18:32   window.py

M-0.11.6 jao@cheese:~/git/marcel/marcel/op$ ls *.py | args [f: grem Disjoint (f)]
Error: Running read(label=True): 'NoneType' object is not callable
'NoneType' object is not callable

----------------------------------------------------------------------

FIXED

134. help read is incomplete

Doesn't include args inherited from FilenamesOp. Related: __repr__
omits inherited args too.

----------------------------------------------------------------------

FIXED

135. Crash on AttributeError in function

M-0.11.8 jao@cheese:~/git/marcel/marcel/op$ grep window * | ext py | (f, l: f) | unique
Process Process-8:
Traceback (most recent call last):
  File "/home/jao/git/marcel/marcel/function.py", line 41, in __call__
    return self.function(*args, **kwargs)
  File "<string>", line 1, in <lambda>
AttributeError: 'str' object has no attribute 'suffix'

During handling of the above exception, another exception occurred:

    Traceback (most recent call last):
      File "/usr/lib/python3.8/multiprocessing/process.py", line 315, in _bootstrap
        self.run()
      File "/usr/lib/python3.8/multiprocessing/process.py", line 108, in run
        self._target(*self._args, **self._kwargs)
      File "/home/jao/git/marcel/marcel/job.py", line 147, in run_command_in_child
        child_namespace_changes = command.execute(self.env)
      File "/home/jao/git/marcel/marcel/core.py", line 386, in execute
        self.pipeline.receive_complete()
      File "/home/jao/git/marcel/marcel/core.py", line 336, in receive_complete
        self.ops[0].receive_complete()
      File "/home/jao/git/marcel/marcel/op/bash.py", line 90, in receive_complete
        self.runner.run()
      File "/home/jao/git/marcel/marcel/op/bash.py", line 128, in run
        op.send(line)
      File "/home/jao/git/marcel/marcel/core.py", line 127, in send
        receiver.receive_input(x)
      File "/home/jao/git/marcel/marcel/core.py", line 144, in receive_input
        self.receive(None if x is None else
      File "/home/jao/git/marcel/marcel/op/runpipeline.py", line 66, in receive
        self.pipeline.receive(x)
      File "/home/jao/git/marcel/marcel/core.py", line 333, in receive
        self.ops[0].receive_input(x)
      File "/home/jao/git/marcel/marcel/core.py", line 144, in receive_input
        self.receive(None if x is None else
      File "/home/jao/git/marcel/marcel/op/select.py", line 63, in receive
        fx = self.function() if x is None else self.function(*x)
      File "/home/jao/git/marcel/marcel/function.py", line 43, in __call__
        self.handle_error(e, self.function_input(args, kwargs))
      File "/home/jao/git/marcel/marcel/function.py", line 59, in handle_error
        self.op.fatal_error(function_input, str(e))
      File "/home/jao/git/marcel/marcel/core.py", line 179, in fatal_error
        self.owner.handle_error(error)
    AttributeError: 'NoneType' object has no attribute 'handle_error'


The problem is error handling inside runpipeline. E.g.

Error in map's function handled correctly:

    M-0.11.8 jao@cheese:~/git/marcel/marcel/op$ gen 3 | map (x: (x, x)) | select (x: x % 2 == 0)
    Error: Running select(lambda x: x % 2 == 0) on (0, 0): <lambda>() takes 1 positional argument but 2 were given
    Error: Running select(lambda x: x % 2 == 0) on (1, 1): <lambda>() takes 1 positional argument but 2 were given
    Error: Running select(lambda x: x % 2 == 0) on (2, 2): <lambda>() takes 1 positional argument but 2 were given

But if the same error occurs inside runpipeline:

    M-0.11.8 jao@cheese:~/git/marcel/marcel/op$ s = [select (x: (x % 2 == 0))]
    M-0.11.8 jao@cheese:~/git/marcel/marcel/op$ gen 3 | (x: (x, x)) | s
    Process Process-21:
    Traceback (most recent call last):
      File "/home/jao/git/marcel/marcel/function.py", line 41, in __call__
        return self.function(*args, **kwargs)
    TypeError: <lambda>() takes 1 positional argument but 2 were given
    
    During handling of the above exception, another exception occurred:
    
    Traceback (most recent call last):
      File "/usr/lib/python3.8/multiprocessing/process.py", line 315, in _bootstrap
        self.run()
      File "/usr/lib/python3.8/multiprocessing/process.py", line 108, in run
        self._target(*self._args, **self._kwargs)
      File "/home/jao/git/marcel/marcel/job.py", line 147, in run_command_in_child
        child_namespace_changes = command.execute(self.env)
      File "/home/jao/git/marcel/marcel/core.py", line 385, in execute
        self.pipeline.receive(None)
      File "/home/jao/git/marcel/marcel/core.py", line 333, in receive
        self.ops[0].receive_input(x)
      File "/home/jao/git/marcel/marcel/core.py", line 144, in receive_input
        self.receive(None if x is None else
      File "/home/jao/git/marcel/marcel/op/gen.py", line 97, in receive
        self.send(self.apply_padding(x))
      File "/home/jao/git/marcel/marcel/core.py", line 127, in send
        receiver.receive_input(x)
      File "/home/jao/git/marcel/marcel/core.py", line 144, in receive_input
        self.receive(None if x is None else
      File "/home/jao/git/marcel/marcel/op/map.py", line 66, in receive
        self.send(output)
      File "/home/jao/git/marcel/marcel/core.py", line 127, in send
        receiver.receive_input(x)
      File "/home/jao/git/marcel/marcel/core.py", line 144, in receive_input
        self.receive(None if x is None else
      File "/home/jao/git/marcel/marcel/op/runpipeline.py", line 66, in receive
        self.pipeline.receive(x)
      File "/home/jao/git/marcel/marcel/core.py", line 333, in receive
        self.ops[0].receive_input(x)
      File "/home/jao/git/marcel/marcel/core.py", line 144, in receive_input
        self.receive(None if x is None else
      File "/home/jao/git/marcel/marcel/op/select.py", line 63, in receive
        fx = self.function() if x is None else self.function(*x)
      File "/home/jao/git/marcel/marcel/function.py", line 43, in __call__
        self.handle_error(e, self.function_input(args, kwargs))
      File "/home/jao/git/marcel/marcel/function.py", line 59, in handle_error
        self.op.fatal_error(function_input, str(e))
      File "/home/jao/git/marcel/marcel/core.py", line 179, in fatal_error
        self.owner.handle_error(error)
    AttributeError: 'NoneType' object has no attribute 'handle_error'
    M-0.11.8 jao@cheese:~/git/marcel/marcel/op$ 

The problem is that runpipeline creates a copy of the pipeline. The
copy is then set up. The function inside the copy has an op from the
ORIGINAL pipeline, which was not set up.

Fix: Function.op is a lot of trouble. Get rid of it, pass in op at
point of call.

----------------------------------------------------------------------

FIXED

136. red after args crashes

M-0.11.8 jao@cheese:~/git/marcel$ ls -0 marcel test \
| args [d: ls -fr (d) \
           | ext py \
           | (f: f.read().count('\n')) \
           | red + \
           | (n: (d, n))] \
| map (d, n: n) \
| red +
13358
Process Process-9:
Traceback (most recent call last):
  File "/usr/lib/python3.8/multiprocessing/process.py", line 315, in _bootstrap
    self.run()
  File "/usr/lib/python3.8/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/home/jao/git/marcel/marcel/job.py", line 147, in run_command_in_child
    child_namespace_changes = command.execute(self.env)
  File "/home/jao/git/marcel/marcel/core.py", line 389, in execute
    self.pipeline.receive(None)
  File "/home/jao/git/marcel/marcel/core.py", line 337, in receive
    self.ops[0].receive_input(x)
  File "/home/jao/git/marcel/marcel/core.py", line 147, in receive_input
    self.receive(None if x is None else
  File "/home/jao/git/marcel/marcel/op/filenamesop.py", line 85, in receive
    self.visit(root, 0)
  File "/home/jao/git/marcel/marcel/op/filenamesop.py", line 91, in visit
    self.action(self, file)
  File "/home/jao/git/marcel/marcel/op/ls.py", line 123, in send_path
    op.send(file)
  File "/home/jao/git/marcel/marcel/core.py", line 127, in send
    receiver.receive_input(x)
  File "/home/jao/git/marcel/marcel/core.py", line 147, in receive_input
    self.receive(None if x is None else
  File "/home/jao/git/marcel/marcel/op/args.py", line 77, in receive
    self.impl.receive(x)
  File "/home/jao/git/marcel/marcel/op/args.py", line 110, in receive
    self.run_pipeline(self.op.env())
  File "/home/jao/git/marcel/marcel/op/args.py", line 166, in run_pipeline
    marcel.core.Command(env, None, self.pipeline).execute()
  File "/home/jao/git/marcel/marcel/core.py", line 390, in execute
    self.pipeline.receive_complete()
  File "/home/jao/git/marcel/marcel/core.py", line 340, in receive_complete
    self.ops[0].receive_complete()
  File "/home/jao/git/marcel/marcel/core.py", line 161, in receive_complete
    self.send_complete()
  File "/home/jao/git/marcel/marcel/core.py", line 136, in send_complete
    self.receiver.receive_complete()
  File "/home/jao/git/marcel/marcel/op/runpipeline.py", line 71, in receive_complete
    self.pipeline.receive_complete()
  File "/home/jao/git/marcel/marcel/core.py", line 340, in receive_complete
    self.ops[0].receive_complete()
  File "/home/jao/git/marcel/marcel/core.py", line 161, in receive_complete
    self.send_complete()
  File "/home/jao/git/marcel/marcel/core.py", line 136, in send_complete
    self.receiver.receive_complete()
  File "/home/jao/git/marcel/marcel/core.py", line 161, in receive_complete
    self.send_complete()
  File "/home/jao/git/marcel/marcel/core.py", line 136, in send_complete
    self.receiver.receive_complete()
  File "/home/jao/git/marcel/marcel/op/red.py", line 167, in receive_complete
    self.reducer.receive_complete()
  File "/home/jao/git/marcel/marcel/op/red.py", line 203, in receive_complete
    op.send(tuple(self.accumulator))
  File "/home/jao/git/marcel/marcel/core.py", line 127, in send
    receiver.receive_input(x)
  File "/home/jao/git/marcel/marcel/core.py", line 147, in receive_input
    self.receive(None if x is None else
  File "/home/jao/git/marcel/marcel/op/map.py", line 68, in receive
    self.send(output)
  File "/home/jao/git/marcel/marcel/core.py", line 127, in send
    receiver.receive_input(x)
  File "/home/jao/git/marcel/marcel/core.py", line 147, in receive_input
    self.receive(None if x is None else
  File "/home/jao/git/marcel/marcel/op/map.py", line 68, in receive
    self.send(output)
  File "/home/jao/git/marcel/marcel/core.py", line 127, in send
    receiver.receive_input(x)
  File "/home/jao/git/marcel/marcel/core.py", line 147, in receive_input
    self.receive(None if x is None else
  File "/home/jao/git/marcel/marcel/op/red.py", line 164, in receive
    self.reducer.receive(x)
  File "/home/jao/git/marcel/marcel/op/red.py", line 196, in receive
    accumulator[i] = op.call(functions[i], accumulator[i], x[i])
TypeError: 'NoneType' object is not subscriptable


args pipeline's receive_complete propagates after the pipeline.

Last op of args pipeline should not propagate r_c to op after args. E.g.

     ... args [... map (...)] | red ...

map's r_c should not propagate to red's r_c. Red's r_c should be
invoked by args r_c.

----------------------------------------------------------------------

FIXED

138. Handling changed .marcel.py crashes

This is after defining loc in RUN_ON_STARTUP:

    M-0.11.8 jao@cheese:~/git/marcel/test$ (loc)
    Traceback (most recent call last):
      File "/usr/lib/python3.8/runpy.py", line 194, in _run_module_as_main
        return _run_code(code, main_globals, None,
      File "/usr/lib/python3.8/runpy.py", line 87, in _run_code
        exec(code, run_globals)
      File "/home/jao/git/marcel/marcel/main.py", line 300, in <module>
        MAIN = Main(None, same_process=False, old_namespace=old_namespace)
      File "/home/jao/git/marcel/marcel/main.py", line 98, in __init__
        self.env = marcel.env.Environment.new(config_file, old_namespace)
      File "/home/jao/git/marcel/marcel/env.py", line 211, in new
        env.config_path = env.read_config(config_file)
      File "/home/jao/git/marcel/marcel/env.py", line 333, in read_config
        exec(config_source, self.namespace.flattened(), locals)
      File "/home/jao/git/marcel/marcel/nestednamespace.py", line 72, in flattened
        for map in self.scopes:
    TypeError: 'NoneType' object is not iterable


----------------------------------------------------------------------

FIXED

139. Crash running ps on @jao

M-0.11.10 jao@cheese:~$ @jao [ ps ]
Traceback (most recent call last):
  File "/usr/local/bin/farcel.py", line 163, in main
    signal_id = input.load()
  File "/usr/local/lib/python3.8/dist-packages/dill/_dill.py", line 472, in load
    obj = StockUnpickler.load(self)
EOFError: Ran out of input

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/local/bin/farcel.py", line 178, in <module>
    main()
  File "/usr/local/bin/farcel.py", line 168, in main
    while pipeline_runner.is_alive():
UnboundLocalError: local variable 'pipeline_runner' referenced before assignment

----------------------------------------------------------------------

NOT A BUG

Seems to be working now

140. Variable not showing up in env -s

    M-0.11.10 jao@cheese:~$ ls > x
    M-0.11.10 jao@cheese:~$ env -s
    ('x', Reservoir(/tmp/tmp2ywu7zm6))
    M-0.11.10 jao@cheese:~$ @jao [df -h] > here
    M-0.11.10 jao@cheese:~$ env -s
    ('x', Reservoir(/tmp/tmp2ywu7zm6))

But here is definitely present:

    M-0.11.10 jao@cheese:~$ (here)
    Reservoir(/tmp/tmpgc1cxlou)


----------------------------------------------------------------------

FIXED

141. Crash on unknown command run remotely

    M-0.11.10 jao@cheese:~/git/marcel$ @acme [ ef -h ]
    Exception in thread Thread-1:
    Traceback (most recent call last):
      File "/usr/local/lib/python3.8/threading.py", line 932, in _bootstrap_inner
        self.run()
      File "/usr/local/bin/farcel.py", line 83, in run
        self.pipeline.receive_complete()
      File "/usr/local/lib/python3.8/site-packages/marcel/core.py", line 336, in receive_complete
        self.ops[0].receive_complete()
      File "/usr/local/lib/python3.8/site-packages/marcel/op/runpipeline.py", line 71, in receive_complete
        self.pipeline.receive_complete()
    AttributeError: 'NoneType' object has no attribute 'receive_complete'
    Error(acme): The variable ef is undefined.


----------------------------------------------------------------------

FIXED

142. Crash on unsupported color scheme property name

jao@cheese:~/git/marcel$ marcel
Traceback (most recent call last):
  File "/usr/lib/python3.8/runpy.py", line 194, in _run_module_as_main
    return _run_code(code, main_globals, None,
  File "/usr/lib/python3.8/runpy.py", line 87, in _run_code
    exec(code, run_globals)
  File "/home/jao/git/marcel/marcel/main.py", line 300, in <module>
    MAIN = Main(None, same_process=False, old_namespace=old_namespace)
  File "/home/jao/git/marcel/marcel/main.py", line 98, in __init__
    self.env = marcel.env.Environment.new(config_file, old_namespace)
  File "/home/jao/git/marcel/marcel/env.py", line 211, in new
    env.config_path = env.read_config(config_file)
  File "/home/jao/git/marcel/marcel/env.py", line 333, in read_config
    exec(config_source, self.namespace.flattened(), locals)
  File "<string>", line 41, in <module>
  File "/home/jao/git/marcel/marcel/object/color.py", line 96, in __setattr__
    raise ColorSchemeError(f'{key} is not a supported color scheme attribute.')
marcel.object.color.ColorSchemeError: asdf_scheme_value is not a supported color scheme attribute.

----------------------------------------------------------------------

FIXED

143. Need to import env

M-0.11.11 jao@cheese:~/boat$ python bin/reduceimages.py original reduced 640
Error: Traceback (most recent call last):
Error:   File "bin/reduceimages.py", line 7, in <module>
Error:     from pathlib import Path
Error: ImportError: No module named pathlib
M-0.11.11 jao@cheese:~/boat$ 

----------------------------------------------------------------------

FIXED

145. Crash when defining cluster with unknown host name

See on MacOS:

    NAS-40015001:~ jorenstein$ marcel
    Traceback (most recent call last):
      File "/Library/Python/3.7/site-packages/marcel/object/cluster.py", line 29, in __init__
        self.addr = str(ipaddress.ip_address(host))
      File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.7/lib/python3.7/ipaddress.py", line 54, in ip_address
        address)
    ValueError: 'acme' does not appear to be an IPv4 or IPv6 address
    
    During handling of the above exception, another exception occurred:
    
    Traceback (most recent call last):
      File "/Library/Python/3.7/site-packages/marcel/object/cluster.py", line 34, in __init__
        self.addr = str(ipaddress.ip_address(socket.gethostbyname(host)))
    socket.gaierror: [Errno 8] nodename nor servname provided, or not known
    
    During handling of the above exception, another exception occurred:
    
    Traceback (most recent call last):
      File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.7/lib/python3.7/runpy.py", line 193, in _run_module_as_main
        "__main__", mod_spec)
      File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.7/lib/python3.7/runpy.py", line 85, in _run_code
        exec(code, run_globals)
      File "/Library/Python/3.7/site-packages/marcel/main.py", line 300, in <module>
        MAIN = Main(None, same_process=False, old_namespace=old_namespace)
      File "/Library/Python/3.7/site-packages/marcel/main.py", line 98, in __init__
        self.env = marcel.env.Environment.new(config_file, old_namespace)
      File "/Library/Python/3.7/site-packages/marcel/env.py", line 211, in new
        env.config_path = env.read_config(config_file)
      File "/Library/Python/3.7/site-packages/marcel/env.py", line 333, in read_config
        exec(config_source, self.namespace.flattened(), locals)
      File "<string>", line 68, in <module>
      File "/Library/Python/3.7/site-packages/marcel/builtin.py", line 44, in remote
        return Cluster(user, identity, host, hosts)
      File "/Library/Python/3.7/site-packages/marcel/object/cluster.py", line 68, in __init__
        self.hosts = [Host(host, self) for host in hosts]
      File "/Library/Python/3.7/site-packages/marcel/object/cluster.py", line 68, in <listcomp>
        self.hosts = [Host(host, self) for host in hosts]
      File "/Library/Python/3.7/site-packages/marcel/object/cluster.py", line 38, in __init__
        f'Cannot understand {host} as a host name or as an IP address.')
    marcel.exception.KillCommandException: Cannot understand acme as a host name or as an IP address.
    NAS-40015001:~ jorenstein$ 

----------------------------------------------------------------------

NOT A BUG

146. "bash" no longer works

    M 0.11.12 jao@cheese:~/git/marcel/test$ bash
    M 0.11.12 jao@cheese:~/git/marcel/test$ 

This was caused by running "marcel" as the last command in .bashrc.


----------------------------------------------------------------------

FIXED

147. Space after tab-completion is broken

Sometimes there's a space when there shouldn't be, and vice versa.

Check ops, flags, filenames.

- Op completion works

- Flag completion: Doesn't leave a space after unique completion,
  (e.g. "ls --rec")

- Filename completion: Shouldn't leave a space after /.

----------------------------------------------------------------------

FIXED

150. Help wrapping is broken

Spec:

    {p,wrap=F,indent=4}
    COLOR_SCHEME.file_file = COLOR_WHITE_BOLD
    COLOR_SCHEME.file_dir = Color(0, 2, 3, BOLD)
    COLOR_SCHEME.file_link = Color(4, 2, 0, BOLD)
    COLOR_SCHEME.file_executable = Color(0, 4, 0, BOLD)
    ...

Output:

        COLOR_SCHEME.file_file = COLOR_WHITE_BOLD
    COLOR_SCHEME.file_dir = Color(0, 2, 3, BOLD)
    COLOR_SCHEME.file_link = Color(4, 2, 0, BOLD)
    COLOR_SCHEME.file_executable = Color(0, 4, 0, BOLD)
    ...

See also output from "help join".

----------------------------------------------------------------------

FIXED

151. Sort done by pipeline-valued arg not working

Define this: byt = [sort (f: f.mtime)]

Then:

Sorting explicitly works:

    M 0.11.14 jao@cheese ~$ ls Downloads | sort (f: f.mtime)
    -rw-rw-r--   jao    jao       51973   2020 Aug 15 10:50:40   Screenshot from 2020-08-15 10-50-39.png
    -rw-rw-r--   jao    jao       51471   2020 Aug 15 10:57:11   Screenshot from 2020-08-15 10-57-10.png
    -rw-rw-r--   jao    jao       12054   2020 Aug 15 11:35:12   Screenshot from 2020-08-15 11-35-11.png
    -rw-rw-r--   jao    jao       11457   2020 Aug 15 11:36:16   Screenshot from 2020-08-15 11-36-13.png
    -rw-rw-r--   jao    jao       47219   2020 Aug 15 11:38:46   Screenshot from 2020-08-15 11-38-44.png
    -rw-rw-r--   jao    jao       14645   2020 Aug 15 11:41:36   Screenshot from 2020-08-15 11-41-35.png
    -rw-rw-r--   jao    jao       28798   2020 Aug 15 11:51:33   Screenshot from 2020-08-15 11-51-31.png
    -rw-rw-r--   jao    jao       52104   2020 Aug 15 11:53:44   Screenshot from 2020-08-15 11-53-43.png
    -rw-rw-r--   jao    jao       24154   2020 Aug 15 13:57:33   Screenshot from 2020-08-15 13-57-32.png
    -rw-rw-r--   jao    jao       10660   2020 Aug 15 14:00:24   Screenshot from 2020-08-15 14-00-23.png
    -rw-rw-r--   jao    jao       34980   2020 Aug 15 14:03:28   Screenshot from 2020-08-15 14-03-26.png
    -rw-rw-r--   jao    jao       52256   2020 Aug 15 14:22:10   Screenshot from 2020-08-15 14-22-09.png
    -rw-rw-r--   jao    jao       20926   2020 Aug 15 14:44:05   Screenshot from 2020-08-15 14-44-03.png
    -rw-rw-r--   jao    jao       20923   2020 Aug 15 14:45:02   Screenshot from 2020-08-15 14-45-01.png
    -rw-rw-r--   jao    jao       20937   2020 Aug 15 14:45:43   Screenshot from 2020-08-15 14-45-42.png
    -rw-rw-r--   jao    jao    19855068   2020 Aug 17 19:31:04   DFABookInstall#1.pdf
    -rw-rw-r--   jao    jao      259427   2020 Aug 22 10:25:46   elections.jpg
    -rw-rw-r--   jao    jao      261481   2020 Sep 24 19:13:49   mumpsweirdness.zip
    -rw-rw-r--   jao    jao    68328818   2020 Sep 27 21:18:01   discord-0.0.12.deb
    -rw-rw-r--   jao    jao       18934   2020 Sep 28 15:00:25   magritte-notrepro_400x400.jpg
    -rw-rw-r--   jao    jao      173649   2020 Sep 29 10:41:39   Screenshot from 2020-09-29 10-41-34.png
    -rw-rw-r--   jao    jao      444664   2020 Oct 28 10:50:06   OpenExternalObject (1).pdf
    -rw-rw-r--   jao    jao      560652   2020 Oct 28 10:50:06   OpenExternalObject.pdf
    -rw-rw-r--   jao    jao     2873437   2020 Oct 29 19:12:50   IMG_6236.jpg
    -rw-rw-r--   jao    jao     6034565   2020 Oct 29 19:13:24   IMG_6238.jpg
    -rw-rw-r--   jao    jao        3968   2020 Oct 30 00:12:49   Screenshot from 2020-10-30 00-12-44.png
    drwxrwxr-x   jao    jao        4096   2020 Nov 15 18:26:48   repair
    -rw-rw-r--   jao    jao       73274   2020 Nov 30 12:36:03   SnipImage.JPG
    -rw-rw-r--   jao    jao       56889   2020 Nov 30 12:36:13   Jerry.jpg
    drwxr-xr-x   jao    jao        4096   2020 Nov 30 12:36:15   .


But the stored pipeline does not, removing files:

    M 0.11.14 jao@cheese ~$ ls Downloads | byt
    drwxrwxr-x   jao    jao        4096   2020 Nov 15 18:26:48   repair

----------------------------------------------------------------------

FIXED

152. Assertion complaining about attempt to read from reservoir open for write

    TEST.run('fact = [x: gen (x) 1 | args [n: gen (n) 1 | red * | map (f: (n, f))]]')
    TEST.run('fact (5) > f')
    TEST.run('f >')

Causes:

    Traceback (most recent call last):
      File "/home/jao/git/marcel/test/test_ops.py", line 1274, in <module>
        main()
      File "/home/jao/git/marcel/test/test_ops.py", line 1269, in main
        main_dev()
      File "/home/jao/git/marcel/test/test_ops.py", line 1260, in main_dev
        TEST.run('f >')
      File "/home/jao/git/marcel/test/test_base.py", line 123, in run
        self.main.run_command(test)
      File "/home/jao/git/marcel/marcel/main.py", line 156, in run_command
        command.execute()
      File "/home/jao/git/marcel/marcel/core.py", line 396, in execute
        self.pipeline.setup()
      File "/home/jao/git/marcel/marcel/core.py", line 337, in setup
        op.setup()
      File "/home/jao/git/marcel/marcel/op/load.py", line 110, in setup
        self.reader = iter(self.picklefile)
      File "/home/jao/git/marcel/marcel/picklefile.py", line 38, in __iter__
        return self.reader()
      File "/home/jao/git/marcel/marcel/picklefile.py", line 48, in reader
        assert len(self.writers) == 0, self
    AssertionError: Reservoir(/tmp/tmppdf62cm1: readers = 0, writers = 1)

----------------------------------------------------------------------

FIXED

153. red count should return 0 on empty input

It's returning None:

    M 0.12.0 jao@cheese ~/git/marcel/test$ gen 3 | select (x: False) | red count
    None

----------------------------------------------------------------------

FIXED

154. var > (x: ...) crashes

    M 0.12.3 jao@cheese ~$ gen 3 > x
    M 0.12.3 jao@cheese ~$ x > (y: -y)
    Traceback (most recent call last):
      File "/usr/lib/python3.8/runpy.py", line 194, in _run_module_as_main
        return _run_code(code, main_globals, None,
      File "/usr/lib/python3.8/runpy.py", line 87, in _run_code
        exec(code, run_globals)
      File "/home/jao/git/marcel/marcel/main.py", line 310, in <module>
        MAIN.run()
      File "/home/jao/git/marcel/marcel/main.py", line 134, in run
        self.run_command(self.input)
      File "/home/jao/git/marcel/marcel/main.py", line 146, in run_command
        pipeline = parser.parse()
      File "/home/jao/git/marcel/marcel/parser.py", line 805, in parse
        return self.command()
      File "/home/jao/git/marcel/marcel/parser.py", line 813, in command
        command = self.pipeline(None)
      File "/home/jao/git/marcel/marcel/parser.py", line 885, in pipeline
        assert False
    AssertionError
    

----------------------------------------------------------------------

FIXED

155. This shouldn't work    

    M 0.12.3 jao@cheese ~/git/marcel/test$ gen 3 > x

This is correct behavior:

    M 0.12.3 jao@cheese ~/git/marcel/test$ x >> map (x: -x)
    Parsing error at position 2 of "...x >> map (x: -x)...": Append not permitted here.

This is not:

    M 0.12.3 jao@cheese ~/git/marcel/test$ x >> (x: -x)
    0
    -1
    -2


----------------------------------------------------------------------

FIXED

156. env -c returns nothing following reload of config file

    M 0.12.3 jao@cheese ~$ env -c
    ('COLOR_EXT_IMAGE', Color(3, 0, 2, BOLD))
    ('COLOR_EXT_SOURCE', Color(0, 3, 4, BOLD))
    ('DB_DEFAULT', Database(psycopg2, nasuni, jao))
    ('RUN_ON_STARTUP', "\next = [e: select (f: f.suffix == '.' + e)]\n\ngrem = [pattern, files: read -l (files) |                         select (f, l: pattern in l)]\nloc = [ls -0 ~/git/marcel/marcel ~/git/marcel/test        | args [d: ls -fr (d)                   | ext py                   | (f: f.read().count('\\n'))                   | red +                   | (n: (d, n))]]\n\nrecent = [d: ls -fr | select (f: now() - f.mtime < days(float(d)))]\n\nbyt = [sort (f: f.mtime)]\n")
    ('acme', Cluster(jao, acme))
    ('all', Cluster(jao, localhost, acme))
    ('byt', [sort(lambda f: f.mtime)])
    ('ext', [e: select(lambda f: f.suffix == '.' + e)])
    ('grem', [pattern, files: read(depth=recursive,label=True, filename=?) | select(lambda f, l: pattern in l)])
    ('jao', Cluster(jao, localhost))
    ('jdb', Database(psycopg2, jao, jao))
    ('loc', [ls(depth=0) | args([d: ls(depth=recursive,include=f) | runpipeline(ext ['py']) | map(lambda f: f.read().count('\n')) | red(functions=['+']) | map(lambda n: (d, n))])])
    ('nasuni', Database(psycopg2, nasuni, jao))
    ('recent', [d: ls(depth=recursive,include=f) | select(lambda f: now() - f.mtime < days(float(d)))])
    ('root', Cluster(root, localhost))
    M 0.12.3 jao@cheese ~$ touch ~/.marcel.py  
    M 0.12.3 jao@cheese ~$ env -c
    M 0.12.3 jao@cheese ~$ 

----------------------------------------------------------------------

FIXED

157. Move INTERACTIVE_EXECUTABLES to .marcel.py

Makes it more obvious how a user can modify it.


----------------------------------------------------------------------

FIXED

158. expand is awkward

    sql "select zvals(b) from z" | (x: x.split(',')) | expand

The query and split yields some items with a single string, others
with a list. expand expands the strings, but does the right thing with
the lists.

And "expand 0" does this: can only concatenate list (not "tuple") to list

----------------------------------------------------------------------

FIXED

160. Piping shell output to grep crashes

    M 0.12.5 jao@cheese ~/git/marcel$ ifconfig | grep inet
            inet 127.0.0.1  netmask 255.0.0.0
            inet6 ::1  prefixlen 128  scopeid 0x10<host>
            inet 10.0.0.121  netmask 255.255.255.0  broadcast 10.0.0.255
            inet6 2601:184:4602:2d10:364b:ead:f982:3e9d  prefixlen 64  scopeid 0x0<global>
            inet6 2601:184:4602:2d10:70d2:9f19:6bb2:6d9c  prefixlen 64  scopeid 0x0<global>
            inet6 2601:184:4602:2d10:9043:b18a:64a1:cf04  prefixlen 64  scopeid 0x0<global>
            inet6 2601:184:4602:2d10:e2de:808a:a5b3:5484  prefixlen 64  scopeid 0x0<global>
            inet6 2601:184:4602:2d10:cbd0:c8fb:1e72:f4fe  prefixlen 64  scopeid 0x0<global>
            inet6 2601:184:4602:2d10:8c19:e680:8454:ad5  prefixlen 64  scopeid 0x0<global>
            inet6 2601:184:4602:2d10:e2e4:ac84:5943:f1d6  prefixlen 64  scopeid 0x0<global>
            inet6 2601:184:4602:2d10:280:a9b0:7f90:17cc  prefixlen 64  scopeid 0x0<global>
            inet6 fe80::e640:6aeb:4e56:140  prefixlen 64  scopeid 0x20<link>
            inet6 2601:184:4602:2d10:feb:7600:ae20:c9fe  prefixlen 64  scopeid 0x0<global>
            inet6 2601:184:4602:2d10::7434  prefixlen 128  scopeid 0x0<global>
    M 0.12.5 jao@cheese ~/git/marcel$ ifconfig | grep inet
    Exception in thread Thread-2:
    Traceback (most recent call last):
      File "/usr/lib/python3.8/threading.py", line 932, in _bootstrap_inner
        self.run()
      File "/home/jao/git/marcel/marcel/op/bash.py", line 186, in run
        op.send(ProcessOutputHandler.normalize_output(line))
      File "/home/jao/git/marcel/marcel/core.py", line 129, in send
        receiver.receive_input(x)
      File "/home/jao/git/marcel/marcel/core.py", line 160, in receive_input
        self.receive(x if type(x) in (tuple, list) else
      File "/home/jao/git/marcel/marcel/op/bash.py", line 91, in receive
        self.runner.receive(x)
    AttributeError: 'NoneType' object has no attribute 'receive'

ifconfig by itself works.


----------------------------------------------------------------------

NOT A BUG
env -s removed.

161. env -s is broken

It is including items defined in config (e.g. byt, ext)

    M 0.12.7 jao@cheese ~/git/marcel/test$ env -s
    ('byt', [sort(lambda f: f.mtime)])
    ('ext', [e: select(lambda f: f.suffix == '.' + e)])
    ('grem', [pattern, files: read(depth=recursive,label=True, filename=?) | select(lambda f, l: pattern in l)])
    ('loc', [ls(depth=0) | args([d: ls(depth=recursive,include=f) | runpipeline(ext ['py']) | map(lambda f: f.read().count('\n')) | red(functions=['+']) | map(lambda n: (d, n))])])
    ('pi', 3.141592653589793)
    ('rand', [n: gen(count=0, start=0) | map(lambda x: random.randint(0, int(n)-1))])
    ('recent', [d: ls(depth=recursive,include=f) | select(lambda f: now() - f.mtime < days(float(d)))])


----------------------------------------------------------------------

FIXED

162. Crash on overwriting variable

M 0.12.7 jao@cheese ~$ x = ([1, (4-2), 3])
M 0.12.7 jao@cheese ~$ (x)
[1, 2, 3]
M 0.12.7 jao@cheese ~$ gen 10 > x
Process Process-3:
Traceback (most recent call last):
  File "/usr/lib/python3.8/multiprocessing/process.py", line 315, in _bootstrap
    self.run()
  File "/usr/lib/python3.8/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/home/jao/git/marcel/marcel/job.py", line 147, in run_command_in_child
    child_namespace_changes = command.execute(self.env)
  File "/home/jao/git/marcel/marcel/core.py", line 416, in execute
    self.pipeline.setup()
  File "/home/jao/git/marcel/marcel/core.py", line 346, in setup
    op.setup()
  File "/home/jao/git/marcel/marcel/op/store.py", line 116, in setup
    self.writer = self.picklefile.writer(self.append)
AttributeError: 'list' object has no attribute 'writer'

----------------------------------------------------------------------

NOT A BUG

Appears to be due to mismatched marcel versions between local and
remote. Not yet clear whether the exact same version should be
required, so leaving this alone.

163. Pickling error

M 0.12.7 jao@cheese ~$ @acme [ df -h ]
Traceback (most recent call last):
  File "/usr/local/bin/farcel.py", line 177, in <module>
    main()
  File "/usr/local/bin/farcel.py", line 162, in main
    signal_id = input.load()
  File "/usr/local/lib/python3.8/site-packages/dill/_dill.py", line 472, in load
    obj = StockUnpickler.load(self)
_pickle.UnpicklingError: unpickling stack underflow
M 0.12.7 jao@cheese ~$ @acme [ bash df -h ]
Traceback (most recent call last):
  File "/usr/local/bin/farcel.py", line 177, in <module>
    main()
  File "/usr/local/bin/farcel.py", line 162, in main
    signal_id = input.load()
  File "/usr/local/lib/python3.8/site-packages/dill/_dill.py", line 472, in load
    obj = StockUnpickler.load(self)


----------------------------------------------------------------------

FIXED

164. jobs is broken

M 0.12.7 jao@cheese ~$ jobs
jobs cannot be the first operator in a pipeline

bg broken too.


----------------------------------------------------------------------

FIXED

165. Op names can't be used as var names

    M 0.12.8 jao@cheese ~$ ls = 5
    [ls(depth=recursive)] followed by excess tokens: Assign(=), String(5)

Are op names keys in the global namespace? If so, then this is
correct. If not, then this is buggy behavior.

Bash allows executable names as variables.

......................................................................

- Lexer creates a String, or Op if the string is an op name. 

- Op is a subclass of string, but is_string() returns False. (I.e.,
  the inheritance simplifies implementation).

- Parser.command sees that token is an Op and tries to parse a
  pipeline. The test is done like this:

        if self.next_token(String, Assign):

  This would work correctly if "ls" worked as both an Op and a String.
  But that would probably break something else.

  next_token() tests for exact match of token type, (i.e. is_string() 
  isn't used).

......................................................................

Plan:

+ Get rid of Op type. 

+ Simplifies Lexer.next_token, distinguishing Op from String.

+ Parser.pipeline does this:

    if self.next_token(Op, Gt)
        ...
    elif self.next_token(String, Gt)

  Easy to fix. Similar thing later: 

    if self.next_token(Op)
        ...
    elif self.next_token(String)

+ create_op_builtin: Replace is_op() call.

+ Parser.load_op, store_op, map_op are no longer staticmethod.

+ op_name() -> field op_name. None if not an op. 

+ Pass op_modules to String init so that op_name can be set.

----------------------------------------------------------------------

FIXED

166. read without FILENAMES reads all files in the current directory

This is wrong, should expect Files from input stream.


read foo.bar

    - write lines to output stream

ls | read

    - write to output stream, lines of each File arriving on input stream

read

    - No FILENAMEs given, so get Files from input stream.

    - But there is no input, so output nothing.

----------------------------------------------------------------------

NOT A BUG

167. args crashing following host executable

M 0.12.9 jao@cheese ~$ cat zack_disk_usage.txt | args[*x: (x)]
Exception in thread Thread-2:
Traceback (most recent call last):
  File "/usr/lib/python3.8/threading.py", line 932, in _bootstrap_inner
    self.run()
  File "/home/jao/git/marcel/marcel/op/bash.py", line 205, in run
    op.send(ProcessOutputHandler.normalize_output(line))
  File "/home/jao/git/marcel/marcel/core.py", line 129, in send
    receiver.receive_input(x)
  File "/home/jao/git/marcel/marcel/core.py", line 160, in receive_input
    self.receive(x if type(x) in (tuple, list) else
  File "/home/jao/git/marcel/marcel/op/args.py", line 78, in receive
    self.impl.receive(x)
AttributeError: 'NoneType' object has no attribute 'receive'


----------------------------------------------------------------------

FIXED

168. red crashing following host executable

cat README.md | red count
0
Exception in thread Thread-2:
Traceback (most recent call last):
  File "/usr/lib/python3.8/threading.py", line 932, in _bootstrap_inner
    self.run()
  File "/home/jao/git/marcel/marcel/op/bash.py", line 205, in run
    op.send(ProcessOutputHandler.normalize_output(line))
  File "/home/jao/git/marcel/marcel/core.py", line 129, in send
    receiver.receive_input(x)
  File "/home/jao/git/marcel/marcel/core.py", line 160, in receive_input
    self.receive(x if type(x) in (tuple, list) else
  File "/home/jao/git/marcel/marcel/op/red.py", line 166, in receive
    self.reducer.receive(x)
  File "/home/jao/git/marcel/marcel/op/red.py", line 202, in receive
    accumulator[i] = op.call(functions[i], accumulator[i], x[i])
TypeError: 'NoneType' object is not subscriptable

----------------------------------------------------------------------

FIXED

169. Remote ls fails on some hosts

acme:

    M 0.12.9 jao@cheese ~$ @acme [ ls /tmp ]
    XXX lineno: 121, opcode: 117
    Error(acme): unknown opcode

cheese:

    M 0.12.9 jao@cheese ~$ @jao [ ls /tmp ]
    (localhost, .)
    (localhost, .ICE-unix)
    (localhost, .Test-unix)
    (localhost, .X11-unix)
    ...

On acme:

Caught <class 'SystemError'>: unknown opcode
  File "/usr/local/bin/farcel.py", line 76, in run
    self.pipeline.first_op().run()
  File "/usr/local/lib/python3.8/site-packages/marcel/op/filenamesop.py", line 85, in run
    self.visit(root, 0)
  File "/usr/local/lib/python3.8/site-packages/marcel/op/filenamesop.py", line 91, in visit
    self.action(self, file)
  File "/home/jao/git/marcel/marcel/op/ls.py", line 121, in send_path
    assert type(file) is File, f'{type(file)} {file}'
1640518413.3948474: Pickling error: (<class 'marcel.object.error.Error'>) Error:
 unknown opcode

The problem was different versions of Python (3.8 vs 3.9). Check for
matching version x.y. Use sys.version_info, e.g.

sys.version_info(major=3, minor=9, micro=7, releaselevel='final', serial=0)

----------------------------------------------------------------------

FIXED

170. args -a failing when receiving input from host executable

    bash: echo a > /tmp/f; echo b >> /tmp/f

Then

    $ cat /tmp/f | args [x: (x)]
    a
    b
    $ cat /tmp/f | args -a [x: (x)]

----------------------------------------------------------------------

FIXED

182. sudo not working

    M 0.13.10 jao@cheese ~$ ls /tmp/farcel.log 
    -rw-r--r--   root   root        175   2022 Dec 05 10:56:49   farcel.log
    M 0.13.10 jao@cheese ~$ sudo [rm /tmp/farcel.log]
    M 0.13.10 jao@cheese ~$ ls /tmp/farcel.log 
    -rw-r--r--   root   root        175   2022 Dec 05 10:57:42   farcel.log

Why did sudo rm fail?

If it failed, why was there no error message?

----------------------------------------------------------------------

FIXED

184. Relative directory operations broken

Relative directory operations in api are broken/confused. Revisit, and
then revive relative tests in test_download(), test_source_filenames().

test_source_filenames() calls filename_op_setup() to initialize. That
function cds to test dir, and then some tests use relative paths. That
works for Interactive, fails for API. So those versions of
test_source_filenames() are currently different, with the API version
using absolute paths.

test_api test_ls, this section is broken: # 0/1/r flags with no files
specified. Also: # Test f/d/s flags

----------------------------------------------------------------------

FIXED

185. marcel var should mask executable

E.g., defining "echo" doesn't prevent the echo executable from being found:

M 0.14.0 jao@cheese ~/git/marcel/test$ echo = [n: gen (n) 100]
M 0.14.0 jao@cheese ~/git/marcel/test$ echo 4
4

----------------------------------------------------------------------

FIXED

187. API env missing all args from the interactive version

----------------------------------------------------------------------

FIXED

190. Some glob characters not working

... when passed to bash

In ~/git/marcel/test:

    M 0.14.1 jao@cheese ~/git/marcel/test$ grep import bug_[23]*
    23 is not defined.

    M 0.14.1 jao@cheese ~/git/marcel/test$ grep import bug_\[23\]*
    Error: ['grep: bug_[23]*: No such file or directory']

    M 0.14.1 jao@cheese ~/git/marcel/test$ ls bug_[23]*
    23 is not defined.

    M 0.14.1 jao@cheese ~/git/marcel/test$ ls bug_\[23\]*
    -rw-r--r--   jao    jao         837   2020 Jun 24 11:46:56   bug_28.py
    -rw-r--r--   jao    jao        1378   2020 Jun 24 11:46:56   bug_29.py
    -rw-r--r--   jao    jao         732   2020 Jun 24 11:46:56   bug_30.py
    -rw-r--r--   jao    jao        1075   2022 May 02 14:26:04   bug_31.py
    -rw-r--r--   jao    jao         652   2020 Jun 24 11:46:56   bug_33.py
    -rw-r--r--   jao    jao         696   2020 Jun 24 11:46:56   bug_38.py
    -rw-r--r--   jao    jao         955   2020 Jun 24 11:46:56   bug_39.py

    M 0.14.1 jao@cheese ~/git/marcel/test$ bash ls bug_\[23\]*
    Error: ["ls: cannot access 'bug_[23]*': No such file or directory"]

......................................................................

Parens are weird:

- Marcel: expr

- Bash single paren: paren ends arg, but is useless by itself.

- Bash double paren: evaluate expr, e.g. $((4+5))

So ((4,5)) is ambiguous:

    marcel: ((4,5)) yields the tuple (4, 5)
    bash: ((4,5)) yields 5

Not sure this is right, but treat ( as marcel expr.

......................................................................

Notes:

* Terminates shell arg

    STRING_TERMINATING = [
        * ( OPEN,
        * ) CLOSE,
        * | PIPE,
          [ BEGIN,
          ] END,
          = ASSIGN,
          # COMMENT,
          , COMMA,
          : COLON,
        * > REDIRECT_FILE,
        * >> REDIRECT_FILE_APPEND,
        * >$ REDIRECT_VAR,
        * >>$ REDIRECT_VAR_APPEND
    ]

----------------------------------------------------------------------

FIXED

193. ls doesn't handle recursion well

E.g. ls -r /bin/X11

Needs to detect the cycle and stop.

......................................................................

Hard links are not a problem. They link only to files.

For symbolic links: always show the link, but don't recurse if the
target has already been visited.


----------------------------------------------------------------------

FIXED

195. Remote execution should work on a pipeline-valued expression

E.g., these should work:

g3 = [gen 3]
@jao (g3)
remote jao (g3)

----------------------------------------------------------------------

FIXED

196. Parsing after pipeline var is broken

    M 0.15.0 jao@cheese ~/git/marcel/test$ g = (| gen 3 |)
    M 0.15.0 jao@cheese ~/git/marcel/test$ g 3
    0
    1
    2

"g 5" runs, ignores the arg. Should complain.

But this works:

    M 0.15.0 jao@cheese ~/git/marcel/test$ gn = (| n: gen (int(n)) |)
    M 0.15.0 jao@cheese ~/git/marcel/test$ gn 3
    0
    1
    2
    M 0.15.0 jao@cheese ~/git/marcel/test$ gn 3 4
    Provided 2 arguments, but there are only 1 pipeline parameters

Is the fix to have pipeline, even without args, check arg count?


----------------------------------------------------------------------

FIXED

197. runpipeline, used as an op, crashes marcel

It isn't a public op, but if you try calling it marcel crashes.

    M 0.15.0 jao@cheese ~/git/marcel/test$ runpipeline
    Traceback (most recent call last):
      File "/usr/lib/python3.10/runpy.py", line 196, in _run_module_as_main
        return _run_code(code, main_globals, None,
      File "/usr/lib/python3.10/runpy.py", line 86, in _run_code
        exec(code, run_globals)
      File "/home/jao/git/marcel/marcel/main.py", line 316, in <module>
        main()
      File "/home/jao/git/marcel/marcel/main.py", line 303, in main
        MAIN.run()
      File "/home/jao/git/marcel/marcel/main.py", line 133, in run
        self.run_command(self.input)
      File "/home/jao/git/marcel/marcel/main.py", line 145, in run_command
        pipeline = parser.parse()
      File "/home/jao/git/marcel/marcel/parser.py", line 919, in parse
        return self.command()
      File "/home/jao/git/marcel/marcel/parser.py", line 927, in command
        command = self.pipeline(None)
      File "/home/jao/git/marcel/marcel/parser.py", line 1040, in pipeline
        pipeline.append(self.create_op(*op_args))
      File "/home/jao/git/marcel/marcel/parser.py", line 1162, in create_op
        op = self.create_op_builtin(op_token, arg_tokens)
      File "/home/jao/git/marcel/marcel/parser.py", line 1191, in create_op_builtin
        self.tab_completion_context.set_op(op, op_module.args_parser().flags())
      File "/home/jao/git/marcel/marcel/opmodule.py", line 74, in args_parser
        assert self._args_parser_constructor is not None
    AssertionError
    jao@cheese:~/git/marcel/test$ 

----------------------------------------------------------------------

FIXED

198. Crash when trying to create a file in place of an exiting directory

/media/backup/daily $ find /media/backup/daily/2023.03.09 -links 1 | args (| f: ls (f) | (f: (f.size, f)) |) > /tmp/x
Process Process-1:
Traceback (most recent call last):
  File "/usr/lib/python3.10/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/usr/lib/python3.10/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/usr/local/lib/python3.10/dist-packages/marcel/job.py", line 147, in run_command_in_child
    child_namespace_changes = command.execute(self.env)
  File "/usr/local/lib/python3.10/dist-packages/marcel/core.py", line 263, in execute
    self.pipeline.setup()
  File "/usr/local/lib/python3.10/dist-packages/marcel/core.py", line 410, in setup
    op.setup()
  File "/usr/local/lib/python3.10/dist-packages/marcel/op/write.py", line 144, in setup
    DefaultWriter(self))
  File "/usr/local/lib/python3.10/dist-packages/marcel/op/write.py", line 240, in __init__
    super().__init__(op)
  File "/usr/local/lib/python3.10/dist-packages/marcel/op/write.py", line 196, in __init__
    self.output = open(path, mode='a' if op.append else 'w')
IsADirectoryError: [Errno 21] Is a directory: '/tmp/x'

----------------------------------------------------------------------

FIXED

199. Execution of pipeline var does not work after >

    x = (| write -f '<<<{}>>>' |)
    gen 3 | x

Works, we see the formatted output.

Save the gen output:

    gen 3 > g
    g >

This:

    g > x

produces no output.

But this does:

    g > (*x: x) | x

So pipeline var execution works after |, but not after >.


----------------------------------------------------------------------

FIXED

200. Writing/reading CSV files should be composable

Writing a CSV file produced something not readable as a CSV file.

----------------------------------------------------------------------

FIXED

201. Deleting non-existent var from environment should not cause an error

    M 0.16.1 jao@cheese ~/git/marcel/test$ x = 1
    M 0.16.1 jao@cheese ~/git/marcel/test$ env x
    ('x', '1')
    M 0.16.1 jao@cheese ~/git/marcel/test$ env -d x
    ('x', '1')
    M 0.16.1 jao@cheese ~/git/marcel/test$ env -d x
    Error: None is undefined

Even if we wanted an error, that's not a good one.

Produce no output in this case.


----------------------------------------------------------------------

FIXED

202. Pipeline definition should not rely on early variable bindings

A pipeline cannot be defined if it references an undefined variable:

    M 0.16.1 jao@cheese ~/git/marcel/test$ p = (| x |)
    x is not a variable, operator, or executable.

Define x to be a pipeline (works):

    M 0.16.1 jao@cheese ~/git/marcel/test$ x = (| gen 3 |)
    M 0.16.1 jao@cheese ~/git/marcel/test$ p = (| x |)
    M 0.16.1 jao@cheese ~/git/marcel/test$ p
    0
    1
    2

Define x to be something other than a pipeline (works):

    M 0.16.1 jao@cheese ~/git/marcel/test$ x = 4
    M 0.16.1 jao@cheese ~/git/marcel/test$ p
    The variable x is not bound to anything executable.

----------------------------------------------------------------------

FIXED

203: Pipeline source should include args

    p = (| n: gen (int(n)) | (x: -x) |)
    M 0.16.1 jao@cheese ~/git/marcel$ (p)
    gen (int(n)) | (x: -x) 

Should be n: ...

----------------------------------------------------------------------

FIXED

204. Suppress prompts when running script

If a script is run like this:

    marcel <<EOF
    ...
    EOF

then a bunch of marcel prompts are printed. They shouldn't be.

----------------------------------------------------------------------

FIXED

205. File objects for filenames with spaces are a problem for bash commands

There is a file named "ab c".

    M 0.17.1 jao@cheese /tmp$ cat (File('ab c'))
    Error: ['cat: ab: No such file or directory']
    Error: ['cat: c: No such file or directory']

----------------------------------------------------------------------

FIXED

206. cd foobar* is broken

M 0.17.1 jao@cheese /tmp$ cd ~/Desktop/photos/Relo*
[Errno 2] No such file or directory: '/home/jao/Desktop/photos/Relo*'

----------------------------------------------------------------------

FIXED

208. cd crashes

M 0.17.3 jao@cheese ~/Dropbox$ ls
drwx------   jao    jao        4096   2023 Jul 05 17:52:03   .
-rw-r--r--   jao    jao          41   2023 Mar 16 11:24:41   .dropbox
drwxr-xr-x   jao    jao        4096   2023 Mar 16 11:24:41   .dropbox.cache
-rw-r--r--   jao    jao          29   2023 Jul 02 11:51:33   transfer.txt
M 0.17.3 jao@cheese ~/Dropbox$ more .dropbox
{"tag":"dropbox","ns":117078224,"n":true}
M 0.17.3 jao@cheese ~/Dropbox$ cd .dropbox
Traceback (most recent call last):
  File "/usr/lib/python3.10/runpy.py", line 196, in _run_module_as_main
    return _run_code(code, main_globals, None,
  File "/usr/lib/python3.10/runpy.py", line 86, in _run_code
    exec(code, run_globals)
  File "/home/jao/git/marcel/marcel/main.py", line 317, in <module>
    main()
  File "/home/jao/git/marcel/marcel/main.py", line 300, in main
    MAIN.run(print_prompt)
  File "/home/jao/git/marcel/marcel/main.py", line 131, in run
    self.run_command(self.input)
  File "/home/jao/git/marcel/marcel/main.py", line 153, in run_command
    command.execute()
  File "/home/jao/git/marcel/marcel/core.py", line 273, in execute
    self.pipeline.run()
  File "/home/jao/git/marcel/marcel/core.py", line 431, in run
    self.ops[0].run()
  File "/home/jao/git/marcel/marcel/op/cd.py", line 71, in run
    self.env().dir_state().cd(self.directory)
  File "/home/jao/git/marcel/marcel/env.py", line 115, in cd
    os.chdir(new_dir)
NotADirectoryError: [Errno 20] Not a directory: '/home/jao/Dropbox/.dropbox'

----------------------------------------------------------------------

FIXED

210: types crashes on input from jobs

Make sure there are some jobs, e.g. 

     timer 1
     <ctrl-z>

M 0.17.3 jao@loon ~$ jobs | types
Process Process-7:
Traceback (most recent call last):
  File "/usr/lib/python3.10/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/usr/lib/python3.10/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/home/jao/git/marcel/marcel/job.py", line 147, in run_command_in_child
    child_namespace_changes = command.execute(self.env)
  File "/home/jao/git/marcel/marcel/core.py", line 273, in execute
    self.pipeline.run()
  File "/home/jao/git/marcel/marcel/core.py", line 431, in run
    self.ops[0].run()
  File "/home/jao/git/marcel/marcel/op/jobs.py", line 59, in run
    for job in marcel.job.JobControl.only.jobs():
  File "/home/jao/git/marcel/marcel/job.py", line 245, in jobs
    self.remove_completed()
  File "/home/jao/git/marcel/marcel/job.py", line 299, in remove_completed
    if job.process is not None and job.process.is_alive():
  File "/usr/lib/python3.10/multiprocessing/process.py", line 160, in is_alive
    assert self._parent_pid == os.getpid(), 'can only test a child process'
AssertionError: can only test a child process


Also happens on jobs >& x

----------------------------------------------------------------------

FIXED

211. Crash in complex pipeline

M 0.17.3 jao@loon ~/consulting/jamie/downloads$ (['NWSTAT', 'NWSTAT']) | expand | args (| x: \
    read -l */*.sps | \
    select (file, line: x in line) | \
    map (file, line: (file, line.split())) | \
    expand 1 | \
    select (file, token: token.startswith(x)) | \
    map (file, token: (file, int(token[6:]))) | \
    red . max | \
    map (file, m: (x, m)) | \
    red . max \
|)
('NWSTAT', 20)
Process Process-47:
Traceback (most recent call last):
  File "/usr/lib/python3.10/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/usr/lib/python3.10/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/home/jao/git/marcel/marcel/job.py", line 147, in run_command_in_child
    child_namespace_changes = command.execute(self.env)
  File "/home/jao/git/marcel/marcel/core.py", line 273, in execute
    self.pipeline.run()
  File "/home/jao/git/marcel/marcel/core.py", line 431, in run
    self.ops[0].run()
  File "/home/jao/git/marcel/marcel/op/map.py", line 67, in run
    self.send(self.call(self.function))
  File "/home/jao/git/marcel/marcel/core.py", line 89, in send
    receiver.receive_input(x)
  File "/home/jao/git/marcel/marcel/core.py", line 120, in receive_input
    self.receive(x if type(x) in (tuple, list) else
  File "/home/jao/git/marcel/marcel/op/expand.py", line 102, in receive
    self.expander.receive(x)
  File "/home/jao/git/marcel/marcel/op/expand.py", line 135, in receive
    self.op.send(x)
  File "/home/jao/git/marcel/marcel/core.py", line 89, in send
    receiver.receive_input(x)
  File "/home/jao/git/marcel/marcel/core.py", line 120, in receive_input
    self.receive(x if type(x) in (tuple, list) else
  File "/home/jao/git/marcel/marcel/op/args.py", line 92, in receive
    self.pipeline_wrapper.run_pipeline(self.args)
  File "/home/jao/git/marcel/marcel/core.py", line 573, in run_pipeline
    marcel.core.Command(env, None, self.pipeline).execute()
  File "/home/jao/git/marcel/marcel/core.py", line 271, in execute
    self.pipeline.setup()
  File "/home/jao/git/marcel/marcel/core.py", line 422, in setup
    op.setup()
  File "/home/jao/git/marcel/marcel/op/red.py", line 150, in setup
    if function.is_grouping():
AttributeError: 'NoneType' object has no attribute 'is_grouping'
M 0.17.3 jao@loon ~/consulting/jamie/downloads$ 

----------------------------------------------------------------------

FIXED

212. Serialization of Pipeline fails

This works:

    M 0.17.3 jao@loon ~/git/marcel/test$ import sys
    M 0.17.3 jao@loon ~/git/marcel/test$ sudo (| gen 3 |)
    0
    1
    2

But this fails:

    M 0.17.3 jao@loon ~/git/marcel/test$ import sys *
    M 0.17.3 jao@loon ~/git/marcel/test$ sudo (| gen 3 |)

The problem is that sudo requires serialization of the pipeline which
contains stuff from sys. Unclear why the failure only occurs if the
sys symbols are top-level in namespace (not inside sys).

Ops really shouldn't own an Environment.

Process Process-2:
Traceback (most recent call last):
  File "/usr/lib/python3.10/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/usr/lib/python3.10/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/home/jao/git/marcel/marcel/job.py", line 147, in run_command_in_child
    child_namespace_changes = command.execute(self.env)
  File "/home/jao/git/marcel/marcel/core.py", line 272, in execute
    self.pipeline.run()
  File "/home/jao/git/marcel/marcel/core.py", line 430, in run
    self.ops[0].run()
  File "/home/jao/git/marcel/marcel/op/sudo.py", line 110, in run
    pickler.dump(self.pipeline)
  File "/usr/local/lib/python3.10/dist-packages/dill/_dill.py", line 418, in dump
    StockPickler.dump(self, obj)
  File "/usr/lib/python3.10/pickle.py", line 487, in dump
    self.save(obj)
  File "/usr/local/lib/python3.10/dist-packages/dill/_dill.py", line 412, in save
    StockPickler.save(self, obj, save_persistent_id)
  File "/usr/lib/python3.10/pickle.py", line 603, in save
    self.save_reduce(obj=obj, *rv)
  File "/usr/lib/python3.10/pickle.py", line 717, in save_reduce
    save(state)
  File "/usr/local/lib/python3.10/dist-packages/dill/_dill.py", line 412, in save
    StockPickler.save(self, obj, save_persistent_id)
  File "/usr/lib/python3.10/pickle.py", line 560, in save
    f(self, obj)  # Call unbound method with explicit self
  File "/usr/local/lib/python3.10/dist-packages/dill/_dill.py", line 1212, in save_module_dict
    StockPickler.save_dict(pickler, obj)
  File "/usr/lib/python3.10/pickle.py", line 972, in save_dict
    self._batch_setitems(obj.items())
  File "/usr/lib/python3.10/pickle.py", line 998, in _batch_setitems
    save(v)
  File "/usr/local/lib/python3.10/dist-packages/dill/_dill.py", line 412, in save
    StockPickler.save(self, obj, save_persistent_id)
  File "/usr/lib/python3.10/pickle.py", line 560, in save
    f(self, obj)  # Call unbound method with explicit self
  File "/usr/lib/python3.10/pickle.py", line 932, in save_list
    self._batch_appends(obj)
  File "/usr/lib/python3.10/pickle.py", line 959, in _batch_appends
    save(tmp[0])
  File "/usr/local/lib/python3.10/dist-packages/dill/_dill.py", line 412, in save
    StockPickler.save(self, obj, save_persistent_id)
  File "/usr/lib/python3.10/pickle.py", line 603, in save
    self.save_reduce(obj=obj, *rv)
  File "/usr/lib/python3.10/pickle.py", line 717, in save_reduce
    save(state)
  File "/usr/local/lib/python3.10/dist-packages/dill/_dill.py", line 412, in save
    StockPickler.save(self, obj, save_persistent_id)
  File "/usr/lib/python3.10/pickle.py", line 560, in save
    f(self, obj)  # Call unbound method with explicit self
  File "/usr/local/lib/python3.10/dist-packages/dill/_dill.py", line 1212, in save_module_dict
    StockPickler.save_dict(pickler, obj)
  File "/usr/lib/python3.10/pickle.py", line 972, in save_dict
    self._batch_setitems(obj.items())
  File "/usr/lib/python3.10/pickle.py", line 998, in _batch_setitems
    save(v)
  File "/usr/local/lib/python3.10/dist-packages/dill/_dill.py", line 412, in save
    StockPickler.save(self, obj, save_persistent_id)
  File "/usr/lib/python3.10/pickle.py", line 603, in save
    self.save_reduce(obj=obj, *rv)
  File "/usr/lib/python3.10/pickle.py", line 717, in save_reduce
    save(state)
  File "/usr/local/lib/python3.10/dist-packages/dill/_dill.py", line 412, in save
    StockPickler.save(self, obj, save_persistent_id)
  File "/usr/lib/python3.10/pickle.py", line 560, in save
    f(self, obj)  # Call unbound method with explicit self
  File "/usr/local/lib/python3.10/dist-packages/dill/_dill.py", line 1212, in save_module_dict
    StockPickler.save_dict(pickler, obj)
  File "/usr/lib/python3.10/pickle.py", line 972, in save_dict
    self._batch_setitems(obj.items())
  File "/usr/lib/python3.10/pickle.py", line 998, in _batch_setitems
    save(v)
  File "/usr/local/lib/python3.10/dist-packages/dill/_dill.py", line 412, in save
    StockPickler.save(self, obj, save_persistent_id)
  File "/usr/lib/python3.10/pickle.py", line 603, in save
    self.save_reduce(obj=obj, *rv)
  File "/usr/lib/python3.10/pickle.py", line 713, in save_reduce
    self._batch_setitems(dictitems)
  File "/usr/lib/python3.10/pickle.py", line 998, in _batch_setitems
    save(v)
  File "/usr/local/lib/python3.10/dist-packages/dill/_dill.py", line 412, in save
    StockPickler.save(self, obj, save_persistent_id)
  File "/usr/lib/python3.10/pickle.py", line 560, in save
    f(self, obj)  # Call unbound method with explicit self
  File "/usr/lib/python3.10/pickle.py", line 902, in save_tuple
    save(element)
  File "/usr/local/lib/python3.10/dist-packages/dill/_dill.py", line 412, in save
    StockPickler.save(self, obj, save_persistent_id)
  File "/usr/lib/python3.10/pickle.py", line 560, in save
    f(self, obj)  # Call unbound method with explicit self
  File "/usr/local/lib/python3.10/dist-packages/dill/_dill.py", line 1965, in save_function
    _save_with_postproc(pickler, (_create_function, (
  File "/usr/local/lib/python3.10/dist-packages/dill/_dill.py", line 1107, in _save_with_postproc
    pickler._batch_setitems(iter(source.items()))
  File "/usr/lib/python3.10/pickle.py", line 998, in _batch_setitems
    save(v)
  File "/usr/local/lib/python3.10/dist-packages/dill/_dill.py", line 412, in save
    StockPickler.save(self, obj, save_persistent_id)
  File "/usr/lib/python3.10/pickle.py", line 560, in save
    f(self, obj)  # Call unbound method with explicit self
  File "/usr/local/lib/python3.10/dist-packages/dill/_dill.py", line 1965, in save_function
    _save_with_postproc(pickler, (_create_function, (
  File "/usr/local/lib/python3.10/dist-packages/dill/_dill.py", line 1107, in _save_with_postproc
    pickler._batch_setitems(iter(source.items()))
  File "/usr/lib/python3.10/pickle.py", line 998, in _batch_setitems
    save(v)
  File "/usr/local/lib/python3.10/dist-packages/dill/_dill.py", line 412, in save
    StockPickler.save(self, obj, save_persistent_id)
  File "/usr/lib/python3.10/pickle.py", line 560, in save
    f(self, obj)  # Call unbound method with explicit self
  File "/usr/local/lib/python3.10/dist-packages/dill/_dill.py", line 1212, in save_module_dict
    StockPickler.save_dict(pickler, obj)
  File "/usr/lib/python3.10/pickle.py", line 972, in save_dict
    self._batch_setitems(obj.items())
  File "/usr/lib/python3.10/pickle.py", line 998, in _batch_setitems
    save(v)
  File "/usr/local/lib/python3.10/dist-packages/dill/_dill.py", line 412, in save
    StockPickler.save(self, obj, save_persistent_id)
  File "/usr/lib/python3.10/pickle.py", line 560, in save
    f(self, obj)  # Call unbound method with explicit self
  File "/usr/local/lib/python3.10/dist-packages/dill/_dill.py", line 1668, in save_module
    pickler.save_reduce(_import_module, (mod_name,), obj=obj, state=main_dict)
  File "/usr/lib/python3.10/pickle.py", line 717, in save_reduce
    save(state)
  File "/usr/local/lib/python3.10/dist-packages/dill/_dill.py", line 412, in save
    StockPickler.save(self, obj, save_persistent_id)
  File "/usr/lib/python3.10/pickle.py", line 560, in save
    f(self, obj)  # Call unbound method with explicit self
  File "/usr/local/lib/python3.10/dist-packages/dill/_dill.py", line 1212, in save_module_dict
    StockPickler.save_dict(pickler, obj)
  File "/usr/lib/python3.10/pickle.py", line 972, in save_dict
    self._batch_setitems(obj.items())
  File "/usr/lib/python3.10/pickle.py", line 998, in _batch_setitems
    save(v)
  File "/usr/local/lib/python3.10/dist-packages/dill/_dill.py", line 412, in save
    StockPickler.save(self, obj, save_persistent_id)
  File "/usr/lib/python3.10/pickle.py", line 560, in save
    f(self, obj)  # Call unbound method with explicit self
  File "/usr/local/lib/python3.10/dist-packages/dill/_dill.py", line 1668, in save_module
    pickler.save_reduce(_import_module, (mod_name,), obj=obj, state=main_dict)
  File "/usr/lib/python3.10/pickle.py", line 717, in save_reduce
    save(state)
  File "/usr/local/lib/python3.10/dist-packages/dill/_dill.py", line 412, in save
    StockPickler.save(self, obj, save_persistent_id)
  File "/usr/lib/python3.10/pickle.py", line 560, in save
    f(self, obj)  # Call unbound method with explicit self
  File "/usr/local/lib/python3.10/dist-packages/dill/_dill.py", line 1212, in save_module_dict
    StockPickler.save_dict(pickler, obj)
  File "/usr/lib/python3.10/pickle.py", line 972, in save_dict
    self._batch_setitems(obj.items())
  File "/usr/lib/python3.10/pickle.py", line 998, in _batch_setitems
    save(v)
  File "/usr/local/lib/python3.10/dist-packages/dill/_dill.py", line 412, in save
    StockPickler.save(self, obj, save_persistent_id)
  File "/usr/lib/python3.10/pickle.py", line 560, in save
    f(self, obj)  # Call unbound method with explicit self
  File "/usr/local/lib/python3.10/dist-packages/dill/_dill.py", line 1668, in save_module
    pickler.save_reduce(_import_module, (mod_name,), obj=obj, state=main_dict)
  File "/usr/lib/python3.10/pickle.py", line 717, in save_reduce
    save(state)
  File "/usr/local/lib/python3.10/dist-packages/dill/_dill.py", line 412, in save
    StockPickler.save(self, obj, save_persistent_id)
  File "/usr/lib/python3.10/pickle.py", line 560, in save
    f(self, obj)  # Call unbound method with explicit self
  File "/usr/local/lib/python3.10/dist-packages/dill/_dill.py", line 1212, in save_module_dict
    StockPickler.save_dict(pickler, obj)
  File "/usr/lib/python3.10/pickle.py", line 972, in save_dict
    self._batch_setitems(obj.items())
  File "/usr/lib/python3.10/pickle.py", line 998, in _batch_setitems
    save(v)
  File "/usr/local/lib/python3.10/dist-packages/dill/_dill.py", line 412, in save
    StockPickler.save(self, obj, save_persistent_id)
  File "/usr/lib/python3.10/pickle.py", line 603, in save
    self.save_reduce(obj=obj, *rv)
  File "/usr/lib/python3.10/pickle.py", line 717, in save_reduce
    save(state)
  File "/usr/local/lib/python3.10/dist-packages/dill/_dill.py", line 412, in save
    StockPickler.save(self, obj, save_persistent_id)
  File "/usr/lib/python3.10/pickle.py", line 560, in save
    f(self, obj)  # Call unbound method with explicit self
  File "/usr/local/lib/python3.10/dist-packages/dill/_dill.py", line 1212, in save_module_dict
    StockPickler.save_dict(pickler, obj)
  File "/usr/lib/python3.10/pickle.py", line 972, in save_dict
    self._batch_setitems(obj.items())
  File "/usr/lib/python3.10/pickle.py", line 998, in _batch_setitems
    save(v)
  File "/usr/local/lib/python3.10/dist-packages/dill/_dill.py", line 412, in save
    StockPickler.save(self, obj, save_persistent_id)
  File "/usr/lib/python3.10/pickle.py", line 603, in save
    self.save_reduce(obj=obj, *rv)
  File "/usr/lib/python3.10/pickle.py", line 717, in save_reduce
    save(state)
  File "/usr/local/lib/python3.10/dist-packages/dill/_dill.py", line 412, in save
    StockPickler.save(self, obj, save_persistent_id)
  File "/usr/lib/python3.10/pickle.py", line 560, in save
    f(self, obj)  # Call unbound method with explicit self
  File "/usr/local/lib/python3.10/dist-packages/dill/_dill.py", line 1212, in save_module_dict
    StockPickler.save_dict(pickler, obj)
  File "/usr/lib/python3.10/pickle.py", line 972, in save_dict
    self._batch_setitems(obj.items())
  File "/usr/lib/python3.10/pickle.py", line 998, in _batch_setitems
    save(v)
  File "/usr/local/lib/python3.10/dist-packages/dill/_dill.py", line 412, in save
    StockPickler.save(self, obj, save_persistent_id)
  File "/usr/lib/python3.10/pickle.py", line 578, in save
    rv = reduce(self.proto)
TypeError: cannot pickle '_json.Scanner' object
M 0.17.3 jao@loon ~/git/marcel/test$ 


----------------------------------------------------------------------

FIXED

213: Variable storing stream not found i~env

24261: Caught <class 'FileNotFoundError'>: [Errno 2] No such file or directory: '/root/.config/marcel'
Caught <class 'FileNotFoundError'>: [Errno 2] No such file or directory: '/root/.config/marcel'
  File "/usr/local/bin/farcel.py", line 184, in main
    namespace = marcel.nestednamespace.NestedNamespace(read_config())
  File "/usr/local/bin/farcel.py", line 160, in read_config
    config_path = locations.config_path()
  File "/usr/local/lib/python3.10/dist-packages/marcel/locations.py", line 28, in config_path
    return self._dir('XDG_CONFIG_HOME', '.config') / 'startup.py'
  File "/usr/local/lib/python3.10/dist-packages/marcel/locations.py", line 49, in _dir
    dir.mkdir(exist_ok=False)
  File "/usr/lib/python3.10/pathlib.py", line 1175, in mkdir
    self._accessor.mkdir(self, mode)
24261: Exiting
       

M 0.18.3 jao@loon ~/git/marcel$ gen 10 >$ v
M 0.18.3 jao@loon ~/git/marcel$ (v)
Error: Running map(lambda: v): name 'v' is not defined


----------------------------------------------------------------------

FIXED

215. help needs a help message

"help help" should print something other than "None", which it does now.

----------------------------------------------------------------------

FIXED

222. Stale docs: marcel.py

https://github.com/geophile/marcel/issues/21

----------------------------------------------------------------------

FIXED

223. Stale docs: Pipeline notation

https://github.com/geophile/marcel/issues/17

----------------------------------------------------------------------

FIXED

224. Stale docs: Redirect syntax

----------------------------------------------------------------------

FIXED

225. Stale docs: out -> write

----------------------------------------------------------------------

227. marcel fails on first startup

NOT A BUG

Found this while working on https://github.com/geophile/marcel/issues/22

ssue22@loon:~$ . ./venv/bin/activate
(venv) issue22@loon:~$ pip install marcel
Collecting marcel
  Downloading marcel-0.18.3-py3-none-any.whl (292 kB)
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 292.6/292.6 KB 862.1 kB/s eta 0:00:00
Collecting dill
  Downloading dill-0.3.7-py3-none-any.whl (115 kB)
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 115.3/115.3 KB 819.3 kB/s eta 0:00:00
Collecting psutil
  Downloading psutil-5.9.6-cp36-abi3-manylinux_2_12_x86_64.manylinux2010_x86_64.manylinux_2_17_x86_64.manylinux2014_x86_64.whl (283 kB)
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 283.6/283.6 KB 1.3 MB/s eta 0:00:00
Installing collected packages: psutil, dill, marcel
Successfully installed dill-0.3.7 marcel-0.18.3 psutil-5.9.6
(venv) issue22@loon:~$ marcel
Traceback (most recent call last):
  File "/usr/lib/python3.10/runpy.py", line 196, in _run_module_as_main
    return _run_code(code, main_globals, None,
  File "/usr/lib/python3.10/runpy.py", line 86, in _run_code
    exec(code, run_globals)
  File "/home/issue22/venv/lib/python3.10/site-packages/marcel/main.py", line 317, in <module>
    main()
  File "/home/issue22/venv/lib/python3.10/site-packages/marcel/main.py", line 293, in main
    MAIN = Main(None, same_process=False, old_namespace=old_namespace)
  File "/home/issue22/venv/lib/python3.10/site-packages/marcel/main.py", line 96, in __init__
    self.env = marcel.env.Environment.new(config_file, old_namespace)
  File "/home/issue22/venv/lib/python3.10/site-packages/marcel/env.py", line 212, in new
    env.config_path = env.read_config(config_file)
  File "/home/issue22/venv/lib/python3.10/site-packages/marcel/env.py", line 326, in read_config
    config_path = self.locations.config_path()
  File "/home/issue22/venv/lib/python3.10/site-packages/marcel/locations.py", line 28, in config_path
    return self._dir('XDG_CONFIG_HOME', '.config') / 'startup.py'
  File "/home/issue22/venv/lib/python3.10/site-packages/marcel/locations.py", line 49, in _dir
    dir.mkdir(exist_ok=False)
t  File "/usr/lib/python3.10/pathlib.py", line 1175, in mkdir
    self._accessor.mkdir(self, mode)
FileNotFoundError: [Errno 2] No such file or directory: '/home/issue22/.config/marcel'
(venv) issue22@loon:~$ 

----------------------------------------------------------------------

FIXED

229. var assigned in saved pipeline can't be read

    M 0.18.4 jao@loon ~$ gn = (| n: gen (int(n)) >$ g |)
    M 0.18.4 jao@loon ~$ gn 3
    M 0.18.4 jao@loon ~$ g <$
    Process Process-2:
    Traceback (most recent call last):
      File "/usr/lib/python3.10/multiprocessing/process.py", line 314, in _bootstrap
        self.run()
      File "/usr/lib/python3.10/multiprocessing/process.py", line 108, in run
        self._target(*self._args, **self._kwargs)
      File "/home/jao/git/marcel/marcel/job.py", line 147, in run_command_in_child
        child_namespace_changes = command.execute(self.env, True)
      File "/home/jao/git/marcel/marcel/core.py", line 260, in execute
        self.pipeline.setup(env)
      File "/home/jao/git/marcel/marcel/core.py", line 415, in setup
        op.setup(env)
      File "/home/jao/git/marcel/marcel/op/load.py", line 99, in setup
        self.reader = iter(self.picklefile)
      File "/home/jao/git/marcel/marcel/picklefile.py", line 38, in __iter__
        return self.reader()
      File "/home/jao/git/marcel/marcel/picklefile.py", line 48, in reader
        assert len(self.writers) == 0, self
    AssertionError: Reservoir(/tmp/tmp_10yzt3q: readers = 0, writers = 1)


----------------------------------------------------------------------

FIXED

229. Arguments to bash commands handled inconsistently

From Claudio Grondi <claudio.grondi@freenet.de>, 11/2/23.

M 0.18.4 jao@loon ~$ bash ls -l *.txt
-rw-rw-r-- 1 jao jao   115 Feb 16  2021 books.txt
-rw-rw-r-- 1 jao jao  1672 Sep  6  2020 canada.txt
-rw-rw-r-- 1 jao jao   939 Feb 11  2022 cats.txt
-rw-rw-r-- 1 jao jao  2114 Dec 15  2021 condo_2021_12_15.txt
-rw-r--r-- 1 jao jao 26721 Mar 26  2020 coronavirus_journal.txt
-rw-rw-r-- 1 jao jao  4266 Nov 17  2021 highland.txt
-rw-rw-r-- 1 jao jao  6685 May 11 09:01 max.txt
-rw-rw-r-- 1 jao jao  1973 Oct 27 14:09 movies.txt
-rw-rw-r-- 1 jao jao 43175 Oct 30 16:56 passwords.txt
-rw-rw-r-- 1 jao jao  6779 Nov  2 10:50 todo.txt
M 0.18.4 jao@loon ~$ bash ls -i *.txt
Operator bash: Flags must all appear before the first anonymous arg

----------------------------------------------------------------------

FIXED

230. Problem with bash ls -i ( -l option is OK, -i option fails)

See https://github.com/geophile/marcel/issues/23


----------------------------------------------------------------------

NOT A BUG

231. Crash due to tuple/list confusion by red . cat

M 0.18.5 jao@loon ~/tufts/cs131/assignments/a4$ read -c all.csv \
| (p, h, t, c, *_: (p, h.strip(), int(c.strip()))) \
| (p, h, c: (p, (h, c))) \
| red . concat \
| (p, hc: sorted(hc, key=lambda hc: -hc[1])) \
| expand 1
Process Process-12:
Traceback (most recent call last):
  File "/usr/lib/python3.10/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/usr/lib/python3.10/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/home/jao/git/marcel/marcel/job.py", line 147, in run_command_in_child
    child_namespace_changes = command.execute(self.env, True)
  File "/home/jao/git/marcel/marcel/core.py", line 262, in execute
    self.pipeline.flush(env)
  File "/home/jao/git/marcel/marcel/core.py", line 430, in flush
    self.ops[0].flush(env)
  File "/home/jao/git/marcel/marcel/core.py", line 133, in flush
    self.propagate_flush(env)
  File "/home/jao/git/marcel/marcel/core.py", line 93, in propagate_flush
    self.receiver.flush(env)
  File "/home/jao/git/marcel/marcel/core.py", line 133, in flush
    self.propagate_flush(env)
  File "/home/jao/git/marcel/marcel/core.py", line 93, in propagate_flush
    self.receiver.flush(env)
  File "/home/jao/git/marcel/marcel/core.py", line 133, in flush
    self.propagate_flush(env)
  File "/home/jao/git/marcel/marcel/core.py", line 93, in propagate_flush
    self.receiver.flush(env)
  File "/home/jao/git/marcel/marcel/op/red.py", line 168, in flush
    self.reducer.flush(env)
  File "/home/jao/git/marcel/marcel/op/red.py", line 243, in flush
    op.send(env, tuple(data))
  File "/home/jao/git/marcel/marcel/core.py", line 84, in send
    receiver.receive_input(env, x)
  File "/home/jao/git/marcel/marcel/core.py", line 115, in receive_input
    self.receive(env, x if type(x) in (tuple, list) else (x,))
  File "/home/jao/git/marcel/marcel/op/map.py", line 67, in receive
    self.send(env, self.call(env, self.function, *x))
  File "/home/jao/git/marcel/marcel/core.py", line 84, in send
    receiver.receive_input(env, x)
  File "/home/jao/git/marcel/marcel/core.py", line 115, in receive_input
    self.receive(env, x if type(x) in (tuple, list) else (x,))
  File "/home/jao/git/marcel/marcel/op/expand.py", line 102, in receive
    self.expander.receive(env, x)
  File "/home/jao/git/marcel/marcel/op/expand.py", line 154, in receive
    send(env, pre + (x,) + post)
TypeError: can only concatenate list (not "tuple") to list

----------------------------------------------------------------------

FIXED

232. Config changes don't take place on the next command

Has to wait until the one after.

The variable asdf doesn't exist:

    M 0.19.0 jao@loon ~/git/marcel/test$ (asdf)
    Error: Running map(lambda: asdf): name 'asdf' is not defined

Add "asdf = 1" in startup.

    M 0.19.0 jao@loon ~/git/marcel/test$ (asdf)

It seems to know it's there, but doesn't have the value?! Try again:

    M 0.19.0 jao@loon ~/git/marcel/test$ (asdf)
    1



----------------------------------------------------------------------

NOT A BUG

232 1/2 (numbering error). Bug in redirect at both ends of a pipeline

This doesn't load al:

a <$ args -a (| L: (L) |) >$ al

----------------------------------------------------------------------

FIXED

234. Saved pipelines not working

For AI course A6, I created a workspace and defined these vars:

readdata = (| f: \
    read -c (f) \
    | map (sl, sw, pl, pw, c: (c, float(sl), float(sw), float(pl), float(pw))) \
|)

graph = (| a, b: \
    map (*t: (t[int(a)+1], t[int(b)+1], t[0])) \
    | args -a (| x: (zip(*x)) |) \
    | map (z: scatter(a, b, *list(z))) \
|)


allgraphs = (| f: \
    gen 3 | args (| a: \
        gen (3-a) (a+1) | args (| b: \
            readdata (f) | graph (a) (b) |) |) \
|)

Exited marcel, restarted, open the ws. Running readdata:

'NoneType' object is not callable

----------------------------------------------------------------------

FIXED

235: Nested pipelines with args getting confused about pipeline vars?

Using this:

graph = (| a, b: \
    map (*t: (t[int(a)+1], t[int(b)+1], t[0])) \
    | args -a (| x: (list(zip(*x))) |) \
    | map (*z: scatter(int(a), int(b), *z)) \
|)

Results in complaints about a being unknown in the last line (inside
the scatter call).

----------------------------------------------------------------------

FIXED

236. cd-ing out of nonexistent directory crashes marcel

I was in .../hello, deleted it. Tried to cd out, but that caused a crash.

M 0.20.0 jao@loon /tmp/test_home/local/marcel/hello$ 
M 0.20.0 jao@loon /tmp/test_home/local/marcel/hello$ cd /tmp/test_home/local/marcel/hello
Traceback (most recent call last):
  File "/usr/lib/python3.10/runpy.py", line 196, in _run_module_as_main
    return _run_code(code, main_globals, None,
  File "/usr/lib/python3.10/runpy.py", line 86, in _run_code
    exec(code, run_globals)
  File "/home/jao/git/marcel/marcel/main.py", line 373, in <module>
    main()
  File "/home/jao/git/marcel/marcel/main.py", line 367, in main
    main_interactive_run(config)
  File "/home/jao/git/marcel/marcel/main.py", line 338, in main_interactive_run
    main.run()
  File "/home/jao/git/marcel/marcel/main.py", line 240, in run
    self.parse_and_run_command(self.input)
  File "/home/jao/git/marcel/marcel/main.py", line 149, in parse_and_run_command
    self.execute_command(command, pipeline)
  File "/home/jao/git/marcel/marcel/main.py", line 224, in execute_command
    command.execute(self.env)
  File "/home/jao/git/marcel/marcel/core.py", line 228, in execute
    self.pipeline.setup(env)
  File "/home/jao/git/marcel/marcel/core.py", line 357, in setup
    op.setup(env)
  File "/home/jao/git/marcel/marcel/op/cd.py", line 63, in setup
    dirs = marcel.op.filenames.Filenames([dir_arg]).normalize()
  File "/home/jao/git/marcel/marcel/op/filenames.py", line 41, in __init__
    self.current_dir = pathlib.Path(os.getcwd())
FileNotFoundError: [Errno 2] No such file or directory
Error in sys.excepthook:
Traceback (most recent call last):
  File "/usr/lib/python3/dist-packages/apport_python_hook.py", line 76, in apport_excepthook
    binary = os.path.realpath(os.path.join(os.getcwd(), sys.argv[0]))
FileNotFoundError: [Errno 2] No such file or directory

Original exception was:
Traceback (most recent call last):
  File "/usr/lib/python3.10/runpy.py", line 196, in _run_module_as_main
    return _run_code(code, main_globals, None,
  File "/usr/lib/python3.10/runpy.py", line 86, in _run_code
    exec(code, run_globals)
  File "/home/jao/git/marcel/marcel/main.py", line 373, in <module>
    main()
  File "/home/jao/git/marcel/marcel/main.py", line 367, in main
    main_interactive_run(config)
  File "/home/jao/git/marcel/marcel/main.py", line 338, in main_interactive_run
    main.run()
  File "/home/jao/git/marcel/marcel/main.py", line 240, in run
    self.parse_and_run_command(self.input)
  File "/home/jao/git/marcel/marcel/main.py", line 149, in parse_and_run_command
    self.execute_command(command, pipeline)
  File "/home/jao/git/marcel/marcel/main.py", line 224, in execute_command
    command.execute(self.env)
  File "/home/jao/git/marcel/marcel/core.py", line 228, in execute
    self.pipeline.setup(env)
  File "/home/jao/git/marcel/marcel/core.py", line 357, in setup
    op.setup(env)
  File "/home/jao/git/marcel/marcel/op/cd.py", line 63, in setup
    dirs = marcel.op.filenames.Filenames([dir_arg]).normalize()
  File "/home/jao/git/marcel/marcel/op/filenames.py", line 41, in __init__
    self.current_dir = pathlib.Path(os.getcwd())
FileNotFoundError: [Errno 2] No such file or directory
jao@loon:/tmp/test_home$ 

----------------------------------------------------------------------

FIXED

237. Typo leads to crash

args -a was followed by function, not pipeline

 0.20.0 jao@loon ~/git/marcel/test$ transpose = (| args -a (x: (list(zip(*x)))) |)
M 0.20.0 jao@loon ~/git/marcel/test$ gen 3 | (x: ([x] * 3))
[0, 0, 0]
[1, 1, 1]
[2, 2, 2]
M 0.20.0 jao@loon ~/git/marcel/test$ gen 3 | (x: ([x] * 3)) | transpose
Process Process-8:
Traceback (most recent call last):
  File "/usr/lib/python3.10/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/usr/lib/python3.10/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/home/jao/git/marcel/marcel/job.py", line 147, in run_command_in_child
    child_namespace_changes = command.execute(self.env, True)
  File "/home/jao/git/marcel/marcel/core.py", line 228, in execute
    self.pipeline.setup(env)
  File "/home/jao/git/marcel/marcel/core.py", line 357, in setup
    op.setup(env)
  File "/home/jao/git/marcel/marcel/op/runpipeline.py", line 63, in setup
    self.pipeline.setup(env)
  File "/home/jao/git/marcel/marcel/core.py", line 357, in setup
    op.setup(env)
  File "/home/jao/git/marcel/marcel/op/args.py", line 88, in setup
    self.n_params = self.pipeline.n_params()
  File "/home/jao/git/marcel/marcel/core.py", line 567, in n_params
    return self.pipeline_arg.n_params()
  File "/home/jao/git/marcel/marcel/core.py", line 248, in n_params
    return len(self.function.__code__.co_varnames)
AttributeError: 'SourceFunction' object has no attribute '__code__'

Simpler test case: gen 3 | args -a (x: (x))

----------------------------------------------------------------------

FIXED

238. Default workspace reservoirs don't go away when the session ends

Seems to work in testing, not manually.

The problem is that interactively, the command is run in a process
with a different pid, while cleanup looks for the top-level process
pid.

Put top-level pid in Env? Or would a global in some module work,
e.g. TOP_LEVEL_PID = os.getpid()? Job's multiprocessing forks the
environment, including the global?

----------------------------------------------------------------------

FIXED

239. Reservoirs in default workspaces are flaky

Populate a stream var. I can look at it. But the file isn't there. And
reading from it again crashes. But the variable is in the environment.

M 0.21.2 jao@loon ~/git/marcel/test$ gen 3 >$ g
M 0.21.2 jao@loon ~/git/marcel/test$ g <$
0
1
2
M 0.21.2 jao@loon ~/git/marcel/test$ cd ~/.local/share/marcel
M 0.21.2 jao@loon ~/.local/share/marcel$ ls
drwxrwxr-x   jao    jao        4096   2023 Dec 22 09:06:42   .
-rw-------   jao    jao        3388   2023 Dec 22 12:44:53   history
drwxrwxr-x   jao    jao        4096   2023 Dec 22 12:47:57   reservoirs
M 0.21.2 jao@loon ~/.local/share/marcel$ cd reservoirs/
M 0.21.2 jao@loon ~/.local/share/marcel/reservoirs$ ls
drwxrwxr-x   jao    jao        4096   2023 Dec 22 12:47:57   .
M 0.21.2 jao@loon ~/.local/share/marcel/reservoirs$ g <$
Process Process-5:
Traceback (most recent call last):
  File "/usr/lib/python3.10/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/usr/lib/python3.10/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/home/jao/git/marcel/marcel/job.py", line 147, in run_command_in_child
    child_namespace_changes = command.execute(self.env, True)
  File "/home/jao/git/marcel/marcel/core.py", line 228, in execute
    self.pipeline.setup(env)
  File "/home/jao/git/marcel/marcel/core.py", line 357, in setup
    op.setup(env)
  File "/home/jao/git/marcel/marcel/op/load.py", line 99, in setup
    self.reader = iter(self.picklefile)
  File "/home/jao/git/marcel/marcel/picklefile.py", line 38, in __iter__
    return self.reader()
  File "/home/jao/git/marcel/marcel/picklefile.py", line 49, in reader
    reader = Reader(self)
  File "/home/jao/git/marcel/marcel/picklefile.py", line 97, in __init__
    self.file = open(owner.path, 'rb')
FileNotFoundError: [Errno 2] No such file or directory: '/home/jao/.local/share/marcel/reservoirs/713612.g.pickle'
M 0.21.2 jao@loon ~/.local/share/marcel/reservoirs$ 
M 0.21.2 jao@loon ~/.local/share/marcel/reservoirs$ (g)
Reservoir(/home/jao/.local/share/marcel/reservoirs/713612.g.pickle)

----------------------------------------------------------------------

FIXED

241. Fix ls formatting for large file sizes

M 0.21.2 (jeffrey) jao@loon ~/hacks/jeffrey$ ls | ft
-rw-rw-r--   jao    jao    823516880   2023 Dec 16 14:24:12   output.txt
-rw-rw-r--   jao    jao    86083186   2023 Dec 27 13:36:14   CompressedFile.zip
-rw-rw-r--   jao    jao    835703600   2023 Dec 27 14:07:39   output_split.txt
-rw-rw-r--   jao    jao    150673824   2023 Dec 27 14:10:03   coords
-rw-rw-r--   jao    jao    666598081   2023 Dec 27 15:28:57   xyrgb.csv
-rw-rw-r--   jao    jao         550   2023 Dec 27 15:29:18   x
-rw-rw-r--   jao    jao        3941   2023 Dec 27 17:10:40   green
-rw-rw-r--   jao    jao        3941   2023 Dec 27 17:11:42   red
-rw-rw-r--   jao    jao        3941   2023 Dec 27 17:12:41   blue
-rw-rw-r--   jao    jao         643   2023 Dec 28 10:59:27   solve_250_255.py
lrwxrwxrwx   jao    jao           4   2023 Dec 28 13:14:51   blue.csv -> blue
-rw-rw-r--   jao    jao         603   2023 Dec 28 16:00:39   notes.txt
drwxrwxr-x   jao    jao        4096   2023 Dec 29 13:45:03   .idea
drwxrwxr-x   jao    jao        4096   2023 Dec 29 15:12:13   venv
-rw-rw-r--   jao    jao    739754689   2023 Dec 29 15:26:54   xyrgb_sorted.csv
-rw-rw-r--   jao    jao        3541   2023 Dec 29 16:53:54   solve.py
drwxrwxr-x   jao    jao        4096   2023 Dec 29 16:54:10   .
-rw-rw-r--   jao    jao     3096968   2023 Dec 29 16:54:10   jeffrey.jpg

----------------------------------------------------------------------

FIXED

242. Function defined in startup.py can't be used in reduction? 

----------------------------------------------------------------------

FIXED

242a. Questionable usage causes crash

Same var used for both load and store.

M 0.21.2 (queens) jao@loon ~$ x <$ (x: x+1) >$ x
Process Process-4:
Traceback (most recent call last):
  File "/usr/lib/python3.10/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/usr/lib/python3.10/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/home/jao/git/marcel/marcel/job.py", line 147, in run_command_in_child
    child_namespace_changes = command.execute(self.env, True)
  File "/home/jao/git/marcel/marcel/core.py", line 228, in execute
    self.pipeline.setup(env)
  File "/home/jao/git/marcel/marcel/core.py", line 357, in setup
    op.setup(env)
  File "/home/jao/git/marcel/marcel/op/store.py", line 114, in setup
    self.writer = self.reservoir.writer(append=self.append)
  File "/home/jao/git/marcel/marcel/picklefile.py", line 57, in writer
    assert len(self._readers) == 0 and self._writer is None, self
AssertionError: Reservoir(/home/jao/.local/share/marcel/queens/reservoirs/x.pickle)

----------------------------------------------------------------------

FIXED

243. List/tuple confusion causes crash

This happens a lot. Revisit tuple/list usage and try to settle on one,
and not crash when there's a conflict.

M 0.21.2 (queens) jao@loon ~$ c1 = (lambda: lambda n: list(range(int(n))))
M 0.21.2 (queens) jao@loon ~$ (c1(3))
[0, 1, 2]
M 0.21.2 (queens) jao@loon ~$ c2 = (lambda: lambda n: [(x, c1(n)) for x in list(range(int(n)))])
M 0.21.2 (queens) jao@loon ~$ (c2(3))
[(0, [0, 1, 2]), (1, [0, 1, 2]), (2, [0, 1, 2])]
M 0.21.2 (queens) jao@loon ~$ (c2(3)) | expand 1
Traceback (most recent call last):
  File "/usr/lib/python3.10/runpy.py", line 196, in _run_module_as_main
    return _run_code(code, main_globals, None,
  File "/usr/lib/python3.10/runpy.py", line 86, in _run_code
    exec(code, run_globals)
  File "/home/jao/git/marcel/marcel/main.py", line 367, in <module>
    main()
  File "/home/jao/git/marcel/marcel/main.py", line 360, in main
    main_interactive_run()
  File "/home/jao/git/marcel/marcel/main.py", line 331, in main_interactive_run
    main.run()
  File "/home/jao/git/marcel/marcel/main.py", line 236, in run
    self.parse_and_run_command(self.input)
  File "/home/jao/git/marcel/marcel/main.py", line 147, in parse_and_run_command
    self.execute_command(command, pipeline)
  File "/home/jao/git/marcel/marcel/main.py", line 220, in execute_command
    command.execute(self.env)
  File "/home/jao/git/marcel/marcel/core.py", line 229, in execute
    self.pipeline.run(env)
  File "/home/jao/git/marcel/marcel/core.py", line 362, in run
    self.ops[0].run(env)
  File "/home/jao/git/marcel/marcel/op/map.py", line 64, in run
    self.send(env, self.call(env, self.function))
  File "/home/jao/git/marcel/marcel/core.py", line 80, in send
    receiver.receive_input(env, x)
  File "/home/jao/git/marcel/marcel/core.py", line 113, in receive_input
    self.receive(env, x if type(x) in (tuple, list) else (x,))
  File "/home/jao/git/marcel/marcel/op/expand.py", line 102, in receive
    self.expander.receive(env, x)
  File "/home/jao/git/marcel/marcel/op/expand.py", line 153, in receive
    send(env, pre + (x,) + post)
TypeError: can only concatenate list (not "tuple") to list

----------------------------------------------------------------------

NOT A BUG

243. Use of term "output stream"

The jobs help info says that output is written to the "output
stream". Is this right? I think it just goes to stdout.

----------------------------------------------------------------------

FIXED

244. ws commands don't work in script

/tmp/q.m:

ws queens
queens 4

Using it:

jao@loon:~$ marcel /tmp/q.m
Workspace(queens)
Traceback (most recent call last):
  File "/usr/lib/python3.10/runpy.py", line 196, in _run_module_as_main
    return _run_code(code, main_globals, None,
  File "/usr/lib/python3.10/runpy.py", line 86, in _run_code
    exec(code, run_globals)
  File "/home/jao/git/marcel/marcel/main.py", line 367, in <module>
    main()
  File "/home/jao/git/marcel/marcel/main.py", line 362, in main
    main_script_run(script)
  File "/home/jao/git/marcel/marcel/main.py", line 351, in main_script_run
    main.run_script(script_file.read())
  File "/home/jao/git/marcel/marcel/main.py", line 184, in run_script
    self.parse_and_run_command(command)
  File "/home/jao/git/marcel/marcel/main.py", line 147, in parse_and_run_command
    self.execute_command(command, pipeline)
  File "/home/jao/git/marcel/marcel/main.py", line 166, in execute_command
    command.execute(self.env)
  File "/home/jao/git/marcel/marcel/core.py", line 229, in execute
    self.pipeline.run(env)
  File "/home/jao/git/marcel/marcel/core.py", line 362, in run
    self.ops[0].run(env)
  File "/home/jao/git/marcel/marcel/op/ws.py", line 176, in run
    self.impl.run(env)
  File "/home/jao/git/marcel/marcel/op/ws.py", line 279, in run
    self.reconfigure(workspace)
  File "/home/jao/git/marcel/marcel/op/ws.py", line 202, in reconfigure
    raise marcel.exception.ReconfigureException(workspace)
marcel.exception.ReconfigureException

----------------------------------------------------------------------

NOT A BUG

245. Crash on write with format

M 0.22.2 jao@loon ~$ gen 3 | args (| x: (x: x) | write -f f'<{x}>' |)
Process Process-8:
Traceback (most recent call last):
  File "/home/jao/git/marcel/marcel/core.py", line 87, in call
    return function(*args, **kwargs)
  File "/home/jao/git/marcel/marcel/function.py", line 39, in __call__
    return self.function(*args, **kwargs)
TypeError: <lambda>() missing 1 required positional argument: 'x'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/jao/git/marcel/marcel/core.py", line 222, in execute
    self.pipeline.run(env)
  File "/home/jao/git/marcel/marcel/core.py", line 348, in run
    self.ops[0].run(env)
  File "/home/jao/git/marcel/marcel/op/gen.py", line 100, in run
    self.send(env, self.apply_padding(x))
  File "/home/jao/git/marcel/marcel/core.py", line 70, in send
    receiver.receive_input(env, x)
  File "/home/jao/git/marcel/marcel/core.py", line 105, in receive_input
    self.receive(env, x if type(x) in (tuple, list) else (x,))
  File "/home/jao/git/marcel/marcel/op/args.py", line 93, in receive
    self.pipeline.run_pipeline(env, self.args)
  File "/home/jao/git/marcel/marcel/core.py", line 513, in run_pipeline
    marcel.core.Command(None, self.pipeline).execute(env)
  File "/home/jao/git/marcel/marcel/core.py", line 222, in execute
    self.pipeline.run(env)
  File "/home/jao/git/marcel/marcel/core.py", line 348, in run
    self.ops[0].run(env)
  File "/home/jao/git/marcel/marcel/op/map.py", line 64, in run
    self.send(env, self.call(env, self.function))
  File "/home/jao/git/marcel/marcel/core.py", line 95, in call
    self.fatal_error(env, args_description, str(e))
  File "/home/jao/git/marcel/marcel/core.py", line 141, in fatal_error
    self.send_error(env, error)
  File "/home/jao/git/marcel/marcel/core.py", line 77, in send_error
    self.receiver.receive_error(env, error)
  File "/home/jao/git/marcel/marcel/op/write.py", line 160, in receive_error
    self.writer.receive(env, error)
  File "/home/jao/git/marcel/marcel/op/write.py", line 268, in receive
    self.write_line(self.format.format(*x))
TypeError: str.format() argument after * must be an iterable, not Error

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/jao/git/marcel/marcel/core.py", line 87, in call
    return function(*args, **kwargs)
  File "/home/jao/git/marcel/marcel/function.py", line 39, in __call__
    return self.function(*args, **kwargs)
TypeError: <lambda>() missing 1 required positional argument: 'x'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/lib/python3.10/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/usr/lib/python3.10/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/home/jao/git/marcel/marcel/job.py", line 147, in run_command_in_child
    child_namespace_changes = command.execute(self.env, True)
1  File "/home/jao/git/marcel/marcel/core.py", line 224, in execute
    self.pipeline.flush(env)
  File "/home/jao/git/marcel/marcel/core.py", line 358, in flush
    self.ops[0].flush(env)
  File "/home/jao/git/marcel/marcel/core.py", line 123, in flush
    self.propagate_flush(env)
  File "/home/jao/git/marcel/marcel/core.py", line 81, in propagate_flush
    self.receiver.flush(env)
  File "/home/jao/git/marcel/marcel/op/args.py", line 103, in flush
    self.pipeline.run_pipeline(env, self.args)
  File "/home/jao/git/marcel/marcel/core.py", line 513, in run_pipeline
    marcel.core.Command(None, self.pipeline).execute(env)
  File "/home/jao/git/marcel/marcel/core.py", line 222, in execute
    self.pipeline.run(env)
  File "/home/jao/git/marcel/marcel/core.py", line 348, in run
    self.ops[0].run(env)
  File "/home/jao/git/marcel/marcel/op/map.py", line 64, in run
    self.send(env, self.call(env, self.function))
  File "/home/jao/git/marcel/marcel/core.py", line 95, in call
    self.fatal_error(env, args_description, str(e))
  File "/home/jao/git/marcel/marcel/core.py", line 141, in fatal_error
    self.send_error(env, error)
  File "/home/jao/git/marcel/marcel/core.py", line 77, in send_error
    self.receiver.receive_error(env, error)
  File "/home/jao/git/marcel/marcel/op/write.py", line 160, in receive_error
    self.writer.receive(env, error)
  File "/home/jao/git/marcel/marcel/op/write.py", line 268, in receive
    self.write_line(self.format.format(*x))
TypeError: str.format() argument after * must be an iterable, not Error
M 0.22.2 jao@loon ~$ 

----------------------------------------------------------------------

FIXED

246. Bad handling of workspace in use

(base) jao@loon:~$ marcel pa
Traceback (most recent call last):
  File "/home/jao/miniconda3/lib/python3.10/runpy.py", line 196, in _run_module_as_main
    return _run_code(code, main_globals, None,
  File "/home/jao/miniconda3/lib/python3.10/runpy.py", line 86, in _run_code
    exec(code, run_globals)
  File "/home/jao/git/marcel/marcel/main.py", line 382, in <module>
    main()
  File "/home/jao/git/marcel/marcel/main.py", line 375, in main
    main_interactive_run(workspace)
  File "/home/jao/git/marcel/marcel/main.py", line 327, in main_interactive_run
    env = marcel.env.EnvironmentInteractive.create(marcel.locations.Locations(), workspace, trace)
  File "/home/jao/git/marcel/marcel/env.py", line 587, in create
    env.initialize_namespace()
  File "/home/jao/git/marcel/marcel/env.py", line 417, in initialize_namespace
    self.restore_persistent_state_from_workspace()
  File "/home/jao/git/marcel/marcel/env.py", line 447, in restore_persistent_state_from_workspace
    self.workspace.open(self)
  File "/home/jao/git/marcel/marcel/object/workspace.py", line 202, in open
    self.lock_workspace(locations)
  File "/home/jao/git/marcel/marcel/object/workspace.py", line 271, in lock_workspace
    self.cannot_lock_workspace()
  File "/home/jao/git/marcel/marcel/object/workspace.py", line 295, in cannot_lock_workspace
    raise marcel.exception.KillCommandException(f'Workspace {self.name} is in use by another process.')
marcel.exception.KillCommandException: Workspace pa is in use by another process.

----------------------------------------------------------------------

FIXED

247. Error inside args kills output

M 0.22.2 jao@loon ~/Downloads/mounish$ gen 3 | args (| x: (x ) |)
0
1
2
M 0.22.2 jao@loon ~/Downloads/mounish$ gen 3 | args (| x: (x / (1-x)) |)
M 0.22.2 jao@loon ~/Downloads/mounish$

----------------------------------------------------------------------

FIXED

249. edit -s loses import

    M 0.23.0 jao@loon ~$ import math
    M 0.23.0 jao@loon ~$ (math)
    <module 'math' from '/home/jao/miniconda3/lib/python3.10/lib-dynload/math.cpython-310-x86_64-linux-gnu.so'>
    M 0.23.0 jao@loon ~$ edit -s
    M 0.23.0 jao@loon ~$ (math)
    Error: Running map(lambda: math): name 'math' is not defined

Probably only a problem with default namespace. Probably lose other
definitions too.

----------------------------------------------------------------------

FIXED

250. Crash when starting marcel with non-existent workspace

(base) jao@loon:~$ marcel hw3
Traceback (most recent call last):
  File "/home/jao/miniconda3/lib/python3.10/runpy.py", line 196, in _run_module_as_main
    return _run_code(code, main_globals, None,
  File "/home/jao/miniconda3/lib/python3.10/runpy.py", line 86, in _run_code
    exec(code, run_globals)
  File "/home/jao/git/marcel/marcel/main.py", line 386, in <module>
    main()
  File "/home/jao/git/marcel/marcel/main.py", line 379, in main
    main_interactive_run(workspace)
  File "/home/jao/git/marcel/marcel/main.py", line 330, in main_interactive_run
    env = marcel.env.EnvironmentInteractive.create(marcel.locations.Locations(), workspace, trace)
  File "/home/jao/git/marcel/marcel/env.py", line 614, in create
    env.initialize_namespace()
  File "/home/jao/git/marcel/marcel/env.py", line 422, in initialize_namespace
    self.restore_persistent_state_from_workspace()
  File "/home/jao/git/marcel/marcel/env.py", line 447, in restore_persistent_state_from_workspace
    self.workspace.open(self)
  File "/home/jao/git/marcel/marcel/object/workspace.py", line 123, in open
    self.lock_workspace(env.locations)
  File "/home/jao/git/marcel/marcel/object/workspace.py", line 214, in lock_workspace
    marker_path = locations.workspace_marker_file_path(self)
  File "/home/jao/git/marcel/marcel/locations.py", line 76, in workspace_marker_file_path
    for file_path in self.config_dir_path(workspace).iterdir():
  File "/home/jao/miniconda3/lib/python3.10/pathlib.py", line 1017, in iterdir
    for name in self._accessor.listdir(self):
FileNotFoundError: [Errno 2] No such file or directory: '/home/jao/.config/marcel/hw3'
(base) jao@loon:~$ 


----------------------------------------------------------------------

FIXED

251. Default workspace marker files

- .WORKSPACE disappers (renamed?) on startup.

- .WORKSPACE.<pid> files accumulate.

----------------------------------------------------------------------

FIXED

252. args failing when some args not provided?

This works:

M 0.24.3 jao@loon ~/.local/share/marcel/__DEFAULT_WORKSPACE__$ gen 3000 | (x: random.random()) | args (| x, y, c: ((int(x*100), int(y*100), int(c*3))) |) 

But this provides no output:


M 0.24.3 jao@loon ~/.local/share/marcel/__DEFAULT_WORKSPACE__$ gen 2999 | (x: random.random()) | args (| x, y, c: ((int(x*100), int(y*100), int(c*3))) |) 

----------------------------------------------------------------------

FIXED

253. Crash on bad import

M 0.24.5 h5 jao@loon dev5$ import numpy np
Traceback (most recent call last):
  File "/home/jao/git/marcel/marcel/op/import.py", line 91, in run
    env.import_module(self.module, self.symbol, self.name)
  File "/home/jao/git/marcel/marcel/env.py", line 505, in import_module
    value = module.__dict__[symbol]
KeyError: 'np'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/jao/miniconda3/lib/python3.10/runpy.py", line 196, in _run_module_as_main
    return _run_code(code, main_globals, None,
  File "/home/jao/miniconda3/lib/python3.10/runpy.py", line 86, in _run_code
    exec(code, run_globals)
  File "/home/jao/git/marcel/marcel/main.py", line 388, in <module>
    main()
  File "/home/jao/git/marcel/marcel/main.py", line 381, in main
    main_interactive_run(workspace)
  File "/home/jao/git/marcel/marcel/main.py", line 335, in main_interactive_run
    main.run()
  File "/home/jao/git/marcel/marcel/main.py", line 212, in run
    self.parse_and_run_command(self.input)
  File "/home/jao/git/marcel/marcel/main.py", line 140, in parse_and_run_command
    self.execute_command(command, pipeline)
  File "/home/jao/git/marcel/marcel/main.py", line 196, in execute_command
    command.execute(self.env)
  File "/home/jao/git/marcel/marcel/core.py", line 231, in execute
    self.pipeline.run(env)
  File "/home/jao/git/marcel/marcel/core.py", line 357, in run
    self.ops[0].run(env)
  File "/home/jao/git/marcel/marcel/op/import.py", line 93, in run
    self.non_fatal_error(message=f'{self.symbol} is not defined in {self.module}')
TypeError: Op.non_fatal_error() missing 1 required positional argument: 'env'

ALSO: This crash leaves an owned .WORKSPACE file.

----------------------------------------------------------------------

FIXED

254. First startup of marcel is failing

    (base) jao@loon:~$ marcel
    Traceback (most recent call last):
      File "/home/jao/miniconda3/lib/python3.10/shutil.py", line 816, in move
        os.rename(src, real_dst)
    FileNotFoundError: [Errno 2] No such file or directory: '/home/jao/.config/marcel/startup.py' -> '/home/jao/.config/marcel/__DEFAULT_WORKSPACE__/startup.py'
    
    During handling of the above exception, another exception occurred:
    
    Traceback (most recent call last):
      File "/home/jao/miniconda3/lib/python3.10/runpy.py", line 196, in _run_module_as_main
        return _run_code(code, main_globals, None,
      File "/home/jao/miniconda3/lib/python3.10/runpy.py", line 86, in _run_code
        exec(code, run_globals)
      File "/home/jao/git/marcel/marcel/main.py", line 388, in <module>
        main()
      File "/home/jao/git/marcel/marcel/main.py", line 376, in main
        marcel.migration.migration.migrate()
      File "/home/jao/git/marcel/marcel/migration/migration.py", line 48, in migrate
        marcel.migration.migration024.migrate(locations)
      File "/home/jao/git/marcel/marcel/migration/migration024.py", line 83, in migrate
        shutil.move(config_dir_path_old / 'startup.py', config_dir_path)
      File "/home/jao/miniconda3/lib/python3.10/shutil.py", line 836, in move
        copy_function(src, real_dst)
      File "/home/jao/miniconda3/lib/python3.10/shutil.py", line 434, in copy2
        copyfile(src, dst, follow_symlinks=follow_symlinks)
      File "/home/jao/miniconda3/lib/python3.10/shutil.py", line 254, in copyfile
        with open(src, 'rb') as fsrc:
    FileNotFoundError: [Errno 2] No such file or directory: '/home/jao/.config/marcel/startup.py'

main runs migration, there is no previous installation, so
PREMIGRATION applies, and then the attempt to upgrade fails,
attempting to move ~/.config/marcel/startup.py to inside
__DEFAULT_WORKSPACE__, none of which exists.


----------------------------------------------------------------------

FIXED

254. Pipeline saved in ws can't be recompiled

(cs135_env) jao@loon:~$ marcel pb
Unable to restore look = f: read -cs (f)         | (e, l, tr, va, *_: (e, tr, va))         | cast float float float         | graph2 because compilation failed. Removing look from environment: 
M 0.24.5 pb jao@loon $ look = (| f: read -cs (f) \
        | (e, l, tr, va, *_: (e, tr, va)) \
        | cast float float float \
        | graph2 |)

----------------------------------------------------------------------

FIXED

255. Crash on bad path

 0.24.5 pb jao@loon src_starter$ cd //
Traceback (most recent call last):
  File "/home/jao/miniconda3/envs/cs135_env/lib/python3.10/runpy.py", line 196, in _run_module_as_main
    return _run_code(code, main_globals, None,
  File "/home/jao/miniconda3/envs/cs135_env/lib/python3.10/runpy.py", line 86, in _run_code
    exec(code, run_globals)
  File "/home/jao/git/marcel/marcel/main.py", line 388, in <module>
    main()
  File "/home/jao/git/marcel/marcel/main.py", line 381, in main
    main_interactive_run(workspace)
  File "/home/jao/git/marcel/marcel/main.py", line 335, in main_interactive_run
    main.run()
  File "/home/jao/git/marcel/marcel/main.py", line 212, in run
    self.parse_and_run_command(self.input)
  File "/home/jao/git/marcel/marcel/main.py", line 140, in parse_and_run_command
    self.execute_command(command, pipeline)
  File "/home/jao/git/marcel/marcel/main.py", line 196, in execute_command
    command.execute(self.env)
  File "/home/jao/git/marcel/marcel/core.py", line 226, in execute
    self.pipeline.setup(env)
  File "/home/jao/git/marcel/marcel/core.py", line 352, in setup
    op.setup(env)
  File "/home/jao/git/marcel/marcel/op/cd.py", line 63, in setup
    dirs = marcel.op.filenames.Filenames(env, [dir_arg]).normalize()
  File "/home/jao/git/marcel/marcel/op/filenames.py", line 52, in normalize
    for root in (glob_base.glob(glob_pattern)
  File "/home/jao/miniconda3/envs/cs135_env/lib/python3.10/pathlib.py", line 1032, in glob
    raise NotImplementedError("Non-relative patterns are unsupported")
NotImplementedError: Non-relative patterns are unsupported



----------------------------------------------------------------------

FIXED

256. Reservoir files disappeared!

They seem to disappear on exiting marcel.

M 0.27.1 jao@loon ~/git/marcel/test$ ws -n test
Workspace(test)
M 0.27.1 test jao@loon /home/jao/git/marcel/test$ gen 5 >$ g
M 0.27.1 test jao@loon /home/jao/git/marcel/test$ g <$
0
1
2
3
4
M 0.27.1 test jao@loon /home/jao/git/marcel/test$ 
jao@loon:~/git/marcel/test$ marcel test
M 0.27.1 test jao@loon /home/jao/git/marcel/test$ g <$
Process Process-1:
Traceback (most recent call last):
  File "/usr/lib/python3.10/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/usr/lib/python3.10/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/home/jao/git/marcel/marcel/job.py", line 147, in run_command_in_child
    child_namespace_changes = command.execute(self.env, True)
  File "/home/jao/git/marcel/marcel/core.py", line 226, in execute
    self.pipeline.setup(env)
  File "/home/jao/git/marcel/marcel/core.py", line 352, in setup
    op.setup(env)
  File "/home/jao/git/marcel/marcel/op/load.py", line 99, in setup
    self.reader = iter(self.picklefile)
  File "/home/jao/git/marcel/marcel/picklefile.py", line 42, in __iter__
    return self.reader()
  File "/home/jao/git/marcel/marcel/picklefile.py", line 53, in reader
    reader = Reader(self)
  File "/home/jao/git/marcel/marcel/picklefile.py", line 98, in __init__
    self.file = open(owner.path, 'rb')
FileNotFoundError: [Errno 2] No such file or directory: '/home/jao/.local/share/marcel/test/reservoirs/g.pickle'

----------------------------------------------------------------------

FIXED

I *think* this is fixed. Not sure how workspace pb got into this
state, but current dir according to marcel and host OS was
different. In any case, now restoring persistent state sets os current
dir to match PWD.

257. Files not being found?!

Is diff working with a different idea of current directory?

M 0.24.5 pb jao@loon src_starter$ diff recommendations_2.csv recommendations_10.csv 
Error: diff: recommendations_2.csv: No such file or directory
Error: diff: recommendations_10.csv: No such file or directory
M 0.24.5 pb jao@loon src_starter$ ls rec*
-rw-rw-r--     jao     jao  179984  2024 May 05 11:47:31  recommendations_10.csv
-rw-rw-r--     jao     jao  179984  2024 May 05 11:46:49  recommendations_2.csv
-rw-rw-r--     jao     jao  179984  2024 May 04 21:28:43  recommendations_50.csv

----------------------------------------------------------------------

FIXED

258. cd / -> Too many paths

This is github issue 5.

----------------------------------------------------------------------

FIXED

259. Deletion of WS with missing marker file crashes

M 0.27.2 jao@loon ~$ ws -d h4
Traceback (most recent call last):
  File "/usr/lib/python3.10/runpy.py", line 196, in _run_module_as_main
    return _run_code(code, main_globals, None,
  File "/usr/lib/python3.10/runpy.py", line 86, in _run_code
    exec(code, run_globals)
  File "/home/jao/git/marcel/marcel/main.py", line 388, in <module>
    main()
  File "/home/jao/git/marcel/marcel/main.py", line 381, in main
    main_interactive_run(workspace)
  File "/home/jao/git/marcel/marcel/main.py", line 335, in main_interactive_run
    main.run()
  File "/home/jao/git/marcel/marcel/main.py", line 212, in run
    self.parse_and_run_command(self.input)
  File "/home/jao/git/marcel/marcel/main.py", line 140, in parse_and_run_command
    self.execute_command(command, pipeline)
  File "/home/jao/git/marcel/marcel/main.py", line 196, in execute_command
    command.execute(self.env)
  File "/home/jao/git/marcel/marcel/core.py", line 231, in execute
    self.pipeline.run(env)
  File "/home/jao/git/marcel/marcel/core.py", line 357, in run
    self.ops[0].run(env)
  File "/home/jao/git/marcel/marcel/op/ws.py", line 189, in run
    self.impl.run(env)
  File "/home/jao/git/marcel/marcel/op/ws.py", line 332, in run
    Workspace(name).delete(env)
  File "/home/jao/git/marcel/marcel/object/workspace.py", line 155, in delete
    if self.lock_workspace(env):
  File "/home/jao/git/marcel/marcel/object/workspace.py", line 243, in lock_workspace
    owner = self.owner(env)
  File "/home/jao/git/marcel/marcel/object/workspace.py", line 332, in owner
    assert marker_filename is not None
AssertionError


----------------------------------------------------------------------

FIXED

260. Extra line at end



    jao@loon:~/git/marcel/test/system$ marcel <<EOF
    > gen 3
    > EOF
    0
    1
    2
    <THIS LINE IS BLANK>

There is an extra line at the end. Undesirable in general, but
especially when embedded in bash scripts.

----------------------------------------------------------------------

FIXED

261. Migration from pre024 failing

z@loon ~ $ marcel
VERSION file missing.
z@loon ~ $ marcel
VERSION file missing.
z@loon ~ $ cd .config/marcel
z@loon ~/.config/marcel $ ls
startup.py
z@loon ~/.config/marcel $ find .
.
./startup.py
./.WORKSPACE

----------------------------------------------------------------------

262. "help edit" crashes

M 0.29.2 jao@loon ~$ help edit
Traceback (most recent call last):
  File "/home/jao/git/marcel/marcel/helpformatter.py", line 221, in raise_invalid_markup
    raise InvalidMarkupException(self.text)
AttributeError: 'TextMarkup' object has no attribute 'text'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/jao/git/marcel/marcel/helpformatter.py", line 280, in __init__
    self.color, text_start = self.formatting(textp, color_scheme)
  File "/home/jao/git/marcel/marcel/helpformatter.py", line 349, in formatting
    self.raise_invalid_markup()
  File "/home/jao/git/marcel/marcel/helpformatter.py", line 224, in raise_invalid_markup
    raise InvalidMarkupException()
marcel.helpformatter.InvalidMarkupException: None

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/lib/python3.10/runpy.py", line 196, in _run_module_as_main
    return _run_code(code, main_globals, None,
  File "/usr/lib/python3.10/runpy.py", line 86, in _run_code
    exec(code, run_globals)
  File "/home/jao/git/marcel/marcel/main.py", line 557, in <module>
    main()
  File "/home/jao/git/marcel/marcel/main.py", line 550, in main
    main_interactive_run(locations, workspace)
  File "/home/jao/git/marcel/marcel/main.py", line 488, in main_interactive_run
    main.run()
  File "/home/jao/git/marcel/marcel/main.py", line 350, in run
    self.parse_and_run_command(self.input)
  File "/home/jao/git/marcel/marcel/main.py", line 214, in parse_and_run_command
    self.execute_command(command, pipeline)
  File "/home/jao/git/marcel/marcel/main.py", line 334, in execute_command
    command.execute(self.env)
  File "/home/jao/git/marcel/marcel/core.py", line 231, in execute
    self.pipeline.run(env)
  File "/home/jao/git/marcel/marcel/core.py", line 357, in run
    self.ops[0].run(env)
  File "/home/jao/git/marcel/marcel/op/help.py", line 66, in run
    help_text = Help.op_help(env, op_module) if op_module else self.topic_help(env)
  File "/home/jao/git/marcel/marcel/op/help.py", line 84, in op_help
    return formatter.format(help_text)
  File "/home/jao/git/marcel/marcel/helpformatter.py", line 494, in format
    paragraph.remove_markup()
  File "/home/jao/git/marcel/marcel/helpformatter.py", line 395, in remove_markup
    markup = TextMarkup(textp, non_ws_count, self.help_formatter.color_scheme)
  File "/home/jao/git/marcel/marcel/helpformatter.py", line 303, in __init__
    raise InvalidMarkupException(self.markup_start.snippet(10))
marcel.helpformatter.InvalidMarkupException: {--startup
jao@loon:~$ 

----------------------------------------------------------------------

FIXED

263. Strange things going on during close of workspace

- Start marcel

- ws -n test

- edit -s: Edit the startup script to introduce a syntax error

- ws -c

This notes an error in test's startup script, which is unexpected
while closing, and puts us in the default
workspace. .config/marcel/workspace/test has .WORKSPACE.<pid>, i.e.,
the workspace didn't get closed properly.

- Exit marcel

- Start marcel

- ws test: Crashes because marker is missing.

Traceback (most recent call last):
  File "/usr/lib/python3.10/runpy.py", line 196, in _run_module_as_main
    return _run_code(code, main_globals, None,
  File "/usr/lib/python3.10/runpy.py", line 86, in _run_code
    exec(code, run_globals)
  File "/home/jao/git/marcel/marcel/main.py", line 571, in <module>
    main()
  File "/home/jao/git/marcel/marcel/main.py", line 559, in main
    main_interactive_run(locations, workspace)
  File "/home/jao/git/marcel/marcel/main.py", line 494, in main_interactive_run
    main.run()
  File "/home/jao/git/marcel/marcel/main.py", line 356, in run
    self.parse_and_run_command(self.input)
  File "/home/jao/git/marcel/marcel/main.py", line 220, in parse_and_run_command
    self.execute_command(command, pipeline)
  File "/home/jao/git/marcel/marcel/main.py", line 340, in execute_command
    command.execute(self.env)
  File "/home/jao/git/marcel/marcel/core.py", line 231, in execute
    self.pipeline.run(env)
  File "/home/jao/git/marcel/marcel/core.py", line 357, in run
    self.ops[0].run(env)
  File "/home/jao/git/marcel/marcel/op/ws.py", line 189, in run
    self.impl.run(env)
  File "/home/jao/git/marcel/marcel/op/ws.py", line 290, in run
    workspace.open(env)
  File "/home/jao/git/marcel/marcel/object/workspace.py", line 123, in open
    if self.lock_workspace(env):
  File "/home/jao/git/marcel/marcel/object/workspace.py", line 241, in lock_workspace
    owner = self.owner(env)
  File "/home/jao/git/marcel/marcel/object/workspace.py", line 324, in owner
    assert marker_filename is not None
AssertionError

----------------------------------------------------------------------

264. There shouldn't be two non-default workspaces marked active

NOT A BUG

... where active means a marker file with a pid. Switching to a
workspace should deactivate the one we were in.

M 0.30.0 jao@loon ~/.config/marcel/workspace/test$ ws -n test2
Workspace(test2)
M 0.30.0 test2 jao@loon /home/jao/.config/marcel/workspace/test$ cd ../test2
M 0.30.0 test2 jao@loon /home/jao/.config/marcel/workspace/test2$ ls
drwxrwxr-x     jao     jao    4096  2024 Aug 22 18:25:35  .
----------     jao     jao       0  2024 Aug 22 18:25:35  .WORKSPACE.87353
-rw-------     jao     jao    4876  2024 Aug 22 18:25:35  startup.py
M 0.30.0 test2 jao@loon /home/jao/.config/marcel/workspace/test2$ ws
Workspace(test2)
M 0.30.0 test2 jao@loon /home/jao/.config/marcel/workspace/test2$ cd ../test
M 0.30.0 test2 jao@loon /home/jao/.config/marcel/workspace/test$ ls
drwxrwxr-x     jao     jao    4096  2024 Aug 22 17:57:20  .
----------     jao     jao       0  2024 Aug 22 17:57:06  .WORKSPACE.78726
-rw-------     jao     jao    4882  2024 Aug 22 17:57:12  startup.py


----------------------------------------------------------------------

FIXED

265. Missing workspace marker file not detected or handled well

A workspace was missing a .WORKSPACE file. Not reported by validation,
and crashed on switching to it:

M 0.30.0 jao@loon ~/git/marcel$ ws queens
Traceback (most recent call last):
  File "/usr/lib/python3.10/runpy.py", line 196, in _run_module_as_main
    return _run_code(code, main_globals, None,
  File "/usr/lib/python3.10/runpy.py", line 86, in _run_code
    exec(code, run_globals)
  File "/home/jao/git/marcel/marcel/main.py", line 586, in <module>
    main()
  File "/home/jao/git/marcel/marcel/main.py", line 574, in main
    main_interactive_run(locations, workspace)
  File "/home/jao/git/marcel/marcel/main.py", line 509, in main_interactive_run
    main.run()
  File "/home/jao/git/marcel/marcel/main.py", line 356, in run
    self.parse_and_run_command(self.input)
  File "/home/jao/git/marcel/marcel/main.py", line 220, in parse_and_run_command
    self.execute_command(command, pipeline)
  File "/home/jao/git/marcel/marcel/main.py", line 340, in execute_command
    command.execute(self.env)
  File "/home/jao/git/marcel/marcel/core.py", line 231, in execute
    self.pipeline.run(env)
  File "/home/jao/git/marcel/marcel/core.py", line 357, in run
    self.ops[0].run(env)
  File "/home/jao/git/marcel/marcel/op/ws.py", line 202, in run
    self.impl.run(env)
  File "/home/jao/git/marcel/marcel/op/ws.py", line 303, in run
    workspace.open(env)
  File "/home/jao/git/marcel/marcel/object/workspace.py", line 123, in open
    if self.lock_workspace(env):
  File "/home/jao/git/marcel/marcel/object/workspace.py", line 250, in lock_workspace
    owner = self.owner(env)
  File "/home/jao/git/marcel/marcel/object/workspace.py", line 333, in owner
    assert marker_filename is not None
AssertionError


Then, on restart and switch to the ws:

jao@loon:~/git/marcel$ marcel
Damaged workspaces have been detected: ['queens']. Their contents will be moved to:
    /home/jao/.config/marcel/broken/1724418322.6169038
    /home/jao/.local/share/marcel/broken/1724418322.6169038
queens: /home/jao/.config/marcel/workspace/queens/.WORKSPACE is missing

So the marker was deleted on startup?!


The first problem was that the marker was left with a pid.

On startup validation: Look for marker with inactive pid and remove
the pid.

----------------------------------------------------------------------

NOT A BUG. Probably fixed by other ws work

266. Crash wiped out marker and now marcel can't start

base) jao@loon:~/nathan_reunion$ marcel nathan
Traceback (most recent call last):
  File "/home/jao/miniconda3/lib/python3.10/runpy.py", line 196, in _run_module_as_main
    return _run_code(code, main_globals, None,
  File "/home/jao/miniconda3/lib/python3.10/runpy.py", line 86, in _run_code
    exec(code, run_globals)
  File "/home/jao/git/marcel/marcel/main.py", line 586, in <module>
    main()
  File "/home/jao/git/marcel/marcel/main.py", line 574, in main
    main_interactive_run(locations, workspace)
  File "/home/jao/git/marcel/marcel/main.py", line 505, in main_interactive_run
    env, main = env_and_main(None, main, workspace)
  File "/home/jao/git/marcel/marcel/main.py", line 490, in env_and_main
    main = MainInteractive(old_main, env, workspace)
  File "/home/jao/git/marcel/marcel/main.py", line 309, in __init__
    super().__init__(env, workspace, testing, initial_config)
  File "/home/jao/git/marcel/marcel/main.py", line 176, in __init__
    env.restore_persistent_state_from_workspace()
  File "/home/jao/git/marcel/marcel/env.py", line 407, in restore_persistent_state_from_workspace
    self.workspace.open(self)
  File "/home/jao/git/marcel/marcel/object/workspace.py", line 126, in open
    if self.lock_workspace(env):
  File "/home/jao/git/marcel/marcel/object/workspace.py", line 253, in lock_workspace
    owner = self.owner(env)
  File "/home/jao/git/marcel/marcel/object/workspace.py", line 332, in owner
    assert marker_filename is not None
AssertionError


----------------------------------------------------------------------

FIXED

267. Reference to MainInteractive.job_control crashes marcel

M 0.30.1 jao@loon ~/nathan_reunion$ ws nathan
Workspace(nathan @ /home/jao/nathan_reunion)
Traceback (most recent call last):
  File "/home/jao/miniconda3/lib/python3.10/runpy.py", line 196, in _run_module_as_main
    return _run_code(code, main_globals, None,
  File "/home/jao/miniconda3/lib/python3.10/runpy.py", line 86, in _run_code
    exec(code, run_globals)
  File "/home/jao/git/marcel/marcel/main.py", line 586, in <module>
    main()
  File "/home/jao/git/marcel/marcel/main.py", line 574, in main
    main_interactive_run(locations, workspace)
  File "/home/jao/git/marcel/marcel/main.py", line 505, in main_interactive_run
    env, main = env_and_main(None, main, workspace)
  File "/home/jao/git/marcel/marcel/main.py", line 490, in env_and_main
    main = MainInteractive(old_main, env, workspace)
  File "/home/jao/git/marcel/marcel/main.py", line 309, in __init__
    super().__init__(env, workspace, testing, initial_config)
  File "/home/jao/git/marcel/marcel/main.py", line 181, in __init__
    startup_vars = self.read_config()
  File "/home/jao/git/marcel/marcel/main.py", line 196, in read_config
    self.run_startup_scripts()
  File "/home/jao/git/marcel/marcel/main.py", line 255, in run_startup_scripts
    self.parse_and_run_command(command)
  File "/home/jao/git/marcel/marcel/main.py", line 220, in parse_and_run_command
    self.execute_command(command, pipeline)
  File "/home/jao/git/marcel/marcel/main.py", line 342, in execute_command
    self.job_control.create_job(command)
AttributeError: 'MainInteractive' object has no attribute 'job_control'

----------------------------------------------------------------------

268. Uncaught exception

FIXED

M 0.30.2 hw1 jao@loon $ read -cs jack_orenstein_supporting_data.csv | cast int int (n, r: (1, n, n)) | red + min max
Process Process-13:
Traceback (most recent call last):
  File "/home/jao/miniconda3/lib/python3.10/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/home/jao/miniconda3/lib/python3.10/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/home/jao/git/marcel/marcel/job.py", line 147, in run_command_in_child
    child_namespace_changes = command.execute(self.env, True)
  File "/home/jao/git/marcel/marcel/core.py", line 226, in execute
    self.pipeline.setup(env)
  File "/home/jao/git/marcel/marcel/core.py", line 352, in setup
    op.setup(env)
  File "/home/jao/git/marcel/marcel/op/cast.py", line 67, in setup
    self.functions.append(getattr(builtins, type))
TypeError: getattr(): attribute name must be string

----------------------------------------------------------------------

FIXED

270. ... <$ ... >$ var not working?

M 0.30.2 hw3 jao@loon $ d1 <$ intersect (| r1 <$ |) >$ x
M 0.30.2 hw3 jao@loon $ x <$
Variable x is undefined.

Works if we use > x, x < instead.

Simpler:

M 0.30.2 jao@loon ~$ gen 3 | intersect (| gen 3 1 |) >$ z
M 0.30.2 jao@loon ~$ z <$
Variable z is undefined.

----------------------------------------------------------------------

FIXED

273. Fix to 270 may have broken args

M 0.30.2 sb jao@loon /usr/share/dict$ gen 3 | args (| x: (x) |)
0
1
2
Process Process-6:
Traceback (most recent call last):
  File "/home/jao/miniconda3/lib/python3.10/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/home/jao/miniconda3/lib/python3.10/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/home/jao/git/marcel/marcel/job.py", line 147, in run_command_in_child
    child_namespace_changes = command.execute(self.env, remote=True)
  File "/home/jao/git/marcel/marcel/core.py", line 244, in execute
    return env.changes() if remote else None
  File "/home/jao/git/marcel/marcel/env.py", line 255, in changes
    return self.var_handler.changes()
  File "/home/jao/git/marcel/marcel/env.py", line 115, in changes
    changes[var] = self.env.namespace[var]
KeyError: 'x'




While clearing env changes, vars_read has COLOR_SCHEME?!?!?!? I guess
it makes sense, we were running interactively.

----------------------------------------------------------------------

FIXED

272. expand op should expand sets
